<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>美女単 - ログイン</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; padding:0; background:linear-gradient(135deg,#f8e8f0,#f0f8ff);
           font-family:'Arial',sans-serif; display:flex; justify-content:center;
           align-items:center; min-height:100vh; flex-direction:column; text-align:center; padding:20px; }
    h2 { color:#e91e63; font-size:1.8rem; margin-bottom:20px; }
    form { display:flex; flex-direction:column; align-items:stretch; gap:15px; width:100%; max-width:320px; }
    input { padding:14px; font-size:1rem; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; }
    button { font-size:1.2rem; padding:14px; background-color:#ff4081; border:none; border-radius:30px;
             color:#fff; cursor:pointer; transition:background-color .3s; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    button:hover { background-color:#f50057; }
    .links { margin-top:20px; font-size:.95rem; display:flex; flex-direction:column; gap:10px; }
    .links a { color:#e91e63; text-decoration:none; }
    .links a:hover { text-decoration:underline; }
    @media (max-width:480px) { body { padding:30px 15px; } h2 { font-size:1.6rem; } button { font-size:1rem; } }
  </style>
</head>
<body>

  <h2>美女単 ログイン</h2>

  <!-- JS無効時もサーバ側リダイレクトが効くように /login へ通常送信 -->
<!-- src/main/resources/static/login.html の <form> はこのまま -->
<form id="loginForm" method="post" action="/login" novalidate>
  <input type="email" name="email" placeholder="メールアドレス" autocomplete="username" required>
  <input type="password" name="password" placeholder="パスワード" autocomplete="current-password" required>
  <button type="submit" id="loginBtn">ログイン</button>
</form>

  <div class="links">
    <a href="register.html">新規ユーザー登録</a>
    <a href="forgot-password.html">パスワードを忘れた方はこちら</a>
  </div>

<script>
  function pickCSRFFromPageOrCookie() {
    const meta = document.querySelector('meta[name="csrf-token"]')?.content;
    if (meta) return { header: 'X-CSRF-Token', token: meta };
    const ck = document.cookie || '';
    const m1 = ck.match(/(?:^|;\s*)XSRF-TOKEN=([^;]+)/);
    if (m1) return { header: 'X-CSRF-TOKEN', token: decodeURIComponent(m1[1]) };
    const m2 = ck.match(/(?:^|;\s*)_csrf=([^;]+)/);
    if (m2) return { header: 'X-CSRF-Token', token: decodeURIComponent(m2[1]) };
    return null;
  }

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.currentTarget;
    const btn  = document.getElementById('loginBtn');
    const email = form.email.value.trim();
    const password = form.password.value;

    if (!email || !password) { alert('メールアドレスとパスワードを入力してください'); return; }

    btn.disabled = true; btn.textContent = '送信中…';
    try {
      const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
      const csrf = pickCSRFFromPageOrCookie();
      if (csrf) headers[csrf.header] = csrf.token;

      const res = await fetch('/login', {
        method: 'POST',
        headers,
        body: new URLSearchParams({ email, password }),
        credentials: 'same-origin',
        redirect: 'follow'
      });

      // 1) サーバ側 302 をそのまま画面遷移
      if (res.redirected) { window.location.assign(res.url); return; }

      // 2) 念のため: セッション成立を /api/me で確認し、id で遷移
      if (res.ok || res.status === 204) {
        try {
          const meRes = await fetch('/api/me', { credentials: 'same-origin' });
          if (meRes.ok) {
            const me = await meRes.json();
            if (me && me.id) { window.location.assign('/user.html?userId=' + me.id); return; }
          }
        } catch (_) {}
        // 取れない場合の最終フォールバック
        window.location.assign('/user.html');
        return;
      }

      alert('ログインに失敗しました。メールまたはパスワードをご確認ください。');
    } catch (err) {
      console.error('login error:', err);
      // ネットワーク等で fetch できない時は通常のフォーム送信にフォールバック
      form.submit();
    } finally {
      btn.disabled = false; btn.textContent = 'ログイン';
    }
  });

  // クエリパラメータの通知
  (function(){
    const p = new URLSearchParams(location.search);
    if (p.get('reset') === 'success') alert('パスワード再設定リンクをメール送信しました！');
    else if (p.get('error') === 'notfound') alert('メールアドレスが見つかりませんでした。');
    else if (p.get('error')) alert('ログインに失敗しました');
  })();
</script>


</body>
</html>
