<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>美女単 - 新規登録</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #f8e8f0, #f0f8ff);
        font-family: "Arial", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        flex-direction: column;
        text-align: center;
      }

      h2 {
        color: #e91e63;
        font-size: 2em;
        margin-bottom: 30px;
      }

      form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: 300px;
      }

      input {
        padding: 12px;
        width: 100%;
        font-size: 1em;
        border-radius: 8px;
        border: 1px solid #ccc;
      }

      button {
        font-size: 1.2em;
        padding: 12px 20px;
        background-color: #ff4081;
        border: none;
        border-radius: 30px;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #f50057;
      }

      .links {
        margin-top: 20px;
        font-size: 0.9em;
      }

      .links a {
        color: #e91e63;
        text-decoration: none;
      }

      .links a:hover {
        text-decoration: underline;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <h2>新規ユーザー登録</h2>

    <form
      id="registerForm"
      onsubmit="handleRegister(event); return false;"
      style="text-align: center; margin: 16px 0"
    >
      <input
        id="regName"
        name="name"
        autocomplete="username"
        required
        placeholder="ユーザー名"
      />
      <input
        id="regEmail"
        name="email"
        autocomplete="email"
        required
        type="email"
        placeholder="メール"
      />
      <input
        id="regPass"
        name="pass"
        autocomplete="new-password"
        required
        type="password"
        placeholder="パスワード"
      />
      <button>新規登録</button>
    </form>

    <div class="links">
      <a href="login.html">ログイン画面に戻る</a>
    </div>

<script>
  // ---- 共通 fetch（CSRF 自動付与） ----
  const apiFetch = (path, opts = {}) => {
    const method = (opts.method || 'GET').toUpperCase();
    const needsCSRF = !['GET','HEAD','OPTIONS'].includes(method);

    const pickCSRFFromPageOrCookie = () => {
      const meta = document.querySelector('meta[name="csrf-token"]')?.content;
      if (meta) return { header:'X-CSRF-Token', token: meta };
      const ck = document.cookie;
      const m1 = ck.match(/(?:^|;\s*)XSRF-TOKEN=([^;]+)/);
      if (m1) return { header:'X-CSRF-TOKEN', token: decodeURIComponent(m1[1]) };
      const m2 = ck.match(/(?:^|;\s*)_csrf=([^;]+)/);
      if (m2) return { header:'X-CSRF-Token', token: decodeURIComponent(m2[1]) };
      return null;
    };

    const headers = new Headers({ Accept: 'application/json', ...(opts.headers||{}) });
    if (needsCSRF && !headers.has('X-CSRF-Token') && !headers.has('X-CSRF-TOKEN')) {
      const c = pickCSRFFromPageOrCookie();
      if (c) headers.set(c.header, c.token);
    }
    return fetch(path, { credentials: 'include', ...opts, headers });
  };

  // ---- 取り得る場所は全部見るユーティリティ ----
  const parseIdFromJson = (j) => {
    const cands = [
      j?.id, j?.userId, j?.user_id,
      j?.user?.id, j?.data?.id, j?.data?.user?.id,
      j?.result?.id, j?.payload?.id
    ];
    for (const v of cands) if (v != null && String(v) !== '') return String(v);
    return null;
  };

  const parseIdFromText = (t) => {
    if (!t) return null;
    // "id": 21 / 'userId': '21' / user_id=21
    let m = t.match(/["']?(?:userId|user_id|id)["']?\s*[:=]\s*["']?(\d{1,})["']?/i);
    if (m) return m[1];
    // /users/21 or /user/21 を拾う
    m = t.match(/\/(?:api\/)?(?:user|users)\/(\d{1,})(?:\D|$)/i);
    if (m) return m[1];
    return null;
  };

  const getIdFromLocationHeader = (res) => {
    const loc = res.headers.get('Location') || res.headers.get('location');
    return loc ? parseIdFromText(String(loc)) : null;
  };

  const getIdFromCookie = () => {
    const ck = document.cookie;
    const keys = ['userId','uid','_user_id'];
    for (const k of keys) {
      const m = ck.match(new RegExp('(?:^|;\\s*)' + k.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&') + '=([^;]+)'));
      if (m && m[1]) return decodeURIComponent(m[1]).match(/\d+/)?.[0] || null;
    }
    return null;
  };

  const pollMeEndpoints = async (retry = 4, intervalMs = 300) => {
    const urls = [
      '/api/me','/user/me','/api/user/me','/api/v1/me','/me','/auth/me'
    ];
    for (let r = 0; r < retry; r++) {
      for (const url of urls) {
        try {
          const res = await fetch(url, { credentials:'include', cache:'no-store' });
          const ct  = (res.headers.get('content-type')||'').toLowerCase();
          if (!res.ok || !ct.includes('application/json')) continue;
          const id = parseIdFromJson(await res.json());
          if (id) return id;
        } catch {}
      }
      await new Promise(s=>setTimeout(s, intervalMs));
    }
    return null;
  };

  // ---- メイン処理 ----
  async function handleRegister(e){
    e.preventDefault();
    const btn = e.submitter || document.querySelector('#registerForm button');
    btn.disabled = true;

    const body = {
      name: document.getElementById('regName').value.trim(),
      email: document.getElementById('regEmail').value.trim(),
      password: document.getElementById('regPass').value
    };

    try{
      const res = await apiFetch('/api/auth/register', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });

      if (res.status === 201 || res.status === 200 || res.status === 204) {
        let userId = null;

        // 1) JSON 本体（content-type 不問で挑戦）
        try { userId = parseIdFromJson(await res.clone().json()); } catch {}

        // 2) Location ヘッダ
        if (!userId) userId = getIdFromLocationHeader(res);

        // 3) テキスト本文を嗅ぎ取る（HTML/プレーンテキスト）
        if (!userId) {
          try { userId = parseIdFromText(await res.clone().text()); } catch {}
        }

        // 4) /api/me 系をポーリング
        if (!userId) userId = await pollMeEndpoints();

        // 5) Cookie
        if (!userId) userId = getIdFromCookie();

        if (userId) localStorage.setItem('userId', userId);

        const dest = userId
          ? `/user.html?userId=${encodeURIComponent(userId)}`
          : `/user.html`;

        const go = () => { location.href = dest; };
        if (window.Swal) await Swal.fire({icon:'success', text:'登録できました！'}).then(go);
        else { alert('登録できました！'); go(); }
        return false;
      }

      const msg = res.status === 409
        ? 'このメールは既に使われています'
        : '登録に失敗しました（入力内容をご確認ください）';
      window.Swal ? Swal.fire({icon:'error', text: msg}) : alert(msg);

    }catch(err){
      window.Swal
        ? Swal.fire({icon:'error', text:'通信エラーが発生しました。時間をおいてお試しください。'})
        : alert('通信エラーが発生しました。');
      console.error(err);
    } finally {
      btn.disabled = false;
    }
    return false;
  }
</script>

  </body>
</html>
