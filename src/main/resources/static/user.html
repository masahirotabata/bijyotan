<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç¾å¥³å˜èªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; background: rgb(249, 249, 249); }
    h1, h3 { text-align: center; color: rgb(233, 30, 99); }
    #username, #plan { display: block; text-align: center; margin: 10px 0; font-size: 1.1em; }

    .word-card { background: #eef7ff; border: 1px solid #ccc; border-radius: 8px; margin: 10px auto; padding: 12px; max-width: 90%; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); font-size: 0.95rem; }

    .pagination { text-align: center; margin: 20px 0; display:flex; gap:6px; flex-wrap:wrap; justify-content:center; align-items:center;}
    .pagination button { margin: 2px; padding: 8px 12px; font-size: 0.9rem; }
    .pagination .page-info { font-size:.9rem; color:#555; padding:0 6px; }

    .locked { background: #ffdddd; padding: 10px; text-align: center; }
    .musou-card { background: #fff5f5; border: 1px solid #f48fb1; border-radius: 10px; padding: 10px; margin: 10px 0; }

    button { padding: 10px 20px; border: none; border-radius: 20px; background-color: #ff4081; color: white; font-size: 1rem; margin: 5px; cursor: pointer; }
    button:hover { background-color: #f50057; }

    #user-info { text-align: left; margin: 10px 0 20px; font-size: 1.1rem; padding-left: 10px; }

    #bgEffect { position: absolute; width: 180px; height: 180px; top: 0; left: 50%; transform: translateX(-50%); z-index: -1; }
    .star-bg { background: radial-gradient(circle, #fff 20%, transparent 70%); animation: sparkle 1.5s infinite alternate; }
    .heart-bg { background: url('/images/heart_bg.gif') center center / cover no-repeat; }
    @keyframes sparkle { 0% { opacity: 0.6; transform: scale(1); } 100% { opacity: 1; transform: scale(1.05); } }

    #planText { text-align: left; color: #333; font-weight: bold; }

    #partButtons { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px; }

    #statsBox { background: #fff3f8; border: 1px solid #ff99c9; border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 500px; box-shadow: 2px 2px 6px rgba(0,0,0,0.05); font-weight: bold; font-size: 1rem; }
    #learningStatus { text-align: center; margin-bottom: 10px; color: #333; }
    #subStats { display: flex; justify-content: space-between; font-size: 0.95rem; padding: 0 10px; color: #555; }
    #subStats div { flex: 1; text-align: center; }

    #loginBonusPopup { display: none; position: fixed; top: 10%; left: 5%; width: 90%; height: 75%; background: white; border: 2px solid #ccc; z-index: 9999; padding: 20px; overflow: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .swal2-popup.premium-popup { font-family: 'sans-serif'; border-radius: 15px; padding: 20px; max-width: 400px; }
    #stampGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }

    #test-section { text-align: center; margin: 20px 0; }

    #videoModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 999; }
    video { width: 90%; max-height: 80vh; }

    @media (max-width: 480px) {
      h1, h3 { font-size: 1.3rem; }
      button { font-size: 0.9rem; padding: 10px; width: 90%; }
      #partButtons { flex-direction: column; align-items: center; }
      .word-card { font-size: 0.9rem; }
    }

    .btn-premium { background-color: #e91e63; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-size: 1em; margin-top: 10px; cursor: pointer; transition: background-color 0.3s ease; }
    .btn-premium:hover { background-color: #d81b60; }

    .hidden{display:none;}
    #swipeModeBox{ max-width:700px;margin:16px auto;padding:10px; }
    #swipeDeck{ position:relative;height:360px;user-select:none;touch-action:pan-y; }
    .swipe-card{ position:absolute;inset:0;margin:auto;width:92%;max-width:580px;height:340px;background:#fff;border-radius:14px;border:1px solid #eee;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:18px;display:flex;flex-direction:column;justify-content:center;align-items:center;transition:transform .2s ease, opacity .2s ease; }
    .swipe-word{font-size:28px;font-weight:700;margin-bottom:8px;}
    .swipe-mean{color:#555;margin-bottom:12px;}
    .swipe-img{ width:220px;height:300px;object-fit:cover;border-radius:10px;background:#f2f2f2;-webkit-user-drag:none;user-drag:none;user-select:none;pointer-events:none; }
    .swipe-badge{ position:absolute;top:12px;font-weight:700;padding:6px 10px;border-radius:8px;opacity:0; }
    .badge-left{left:12px;background:#fde68a;color:#92400e;}
    .badge-right{right:12px;background:#dcfce7;color:#166534;}
    .swipe-hud{display:flex;justify-content:space-between;align-items:center;margin:6px 6px 10px;}
    .swipe-hints{display:flex;justify-content:space-between;color:#888;margin-top:6px;padding:0 4px;}
    .swipe-card .caption { display: none !important; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="loginBonusPopup">
  <h3>ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹</h3>
  <div id="stampGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;"></div>
  <button onclick="closeLoginBonus()">OK</button>
</div>

<div id="user-info">
  <div id="username"></div>
  <div id="planText"></div>
  <div id="userLevel"></div>
</div>

<!-- â˜… è¿½åŠ ï¼šãƒ—ãƒ¬ãƒŸã‚¢ãƒ å‹•ç”»ã®ç½®ãå ´ -->
<div id="premiumVideoContainer" style="text-align:center; margin: 8px 0;"></div>

<div id="levelGirlContainer" style="text-align:center; margin: 10px 0;">
  <div id="bgEffect" class="star-bg"></div>
  <video id="girlVideo" autoplay muted loop playsinline width="180" style="border-radius: 10px;"></video>
</div>

<!-- ãƒ‘ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ -->
<div id="partButtons"></div>

<!-- ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ -->
<div style="text-align:center; margin:6px 0 14px;">
  <button id="swipeStartBtn" onclick="startSwipeMode()">ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ã‚’å§‹ã‚ã‚‹</button>
</div>
<div id="swipeModeBox" class="hidden">
  <div class="swipe-hud">
    <button id="swipeExitBtn">ä¸€è¦§ã«æˆ»ã‚‹</button>
    <div id="swipeCounter">0 / 0</div>
    <div id="swipeStats">è¦šãˆãŸ: 0 / è¦šãˆãŸã„: 0</div>
  </div>
  <div id="swipeDeck"></div>
  <div class="swipe-hints"><span>â† è¦šãˆã¦ãªã„</span><span>è¦šãˆãŸ â†’</span></div>
</div>

<div id="statsBox">
  <div id="learningStatus"></div>
  <div id="subStats">
    <div id="loginDays"></div>
    <div id="testStats"></div>
  </div>
</div>

<!-- åºƒå‘Šã¨èª²é‡‘ -->
<div style="margin: 10px;">
  <button onclick="watchAdGlobal()">åºƒå‘Šã‚’è¦‹ã¦ç¾å¥³ãŒè‹±å˜èªã‚’è¡¨ç¾ï¼ˆ5æšæœ‰åŠ¹ï¼‰</button>
</div>

<div id="test-section" style="text-align: center; margin: 30px 0;">
  <button id="testStartBtn" onclick="startTest()">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹</button>
  <button id="vocabTestBtn" onclick="startVocabularyTest()">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹(å˜èªãƒ¢ãƒ¼ãƒ‰)</button>
  <button onclick="goToPart(getUserId(), 'ç„¡åŒPart')">ç„¡åŒPartã¸</button>
</div>

<div id="weeklyAnswersBox" style="max-width:700px;margin:20px auto;">
  <h3 style="text-align:center;margin:10px 0;">1é€±é–“ã®è§£ç­”æ•°:(ç›®æ¨™è§£ç­”æ•°:80ãŒç›®å®‰)</h3>
  <div id="weeklyBars" style="display:flex;gap:8px;justify-content:space-between;align-items:flex-end;height:140px;padding:8px 4px;background:#fff3f8;border:1px solid #ff99c9;border-radius:12px;"></div>
  <div id="weeklyLabels" style="display:flex;gap:8px;justify-content:space-between;font-size:.8rem;margin-top:6px;color:#555;"></div>
</div>

<div id="wordContainer"></div>

<!-- ãƒšãƒ¼ã‚¸ãƒ£é ˜åŸŸ -->
<div class="pagination" id="pagination"></div>

<!-- å‹•ç”»ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="videoModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:999;">
  <video id="videoPlayer" controls autoplay width="80%"></video>
</div>

<script>
/* ====== çŠ¶æ…‹ ====== */
let words = [];
let user = { id: null, isPremium: false, canWatchVideo: false, premium: false };
let musouMode = false;              // â† è¿½åŠ 
let currentPage = 1;
let pageSize = 5;                   // â† å¯å¤‰ã«ã—ãŸã„å ´åˆã¯ã“ã“ã‚’æ›¸ãæ›ãˆ
let selectedPart = "part1";
let currentPart = 1;

const style = document.createElement('style');
style.innerHTML = `@keyframes pop {0% { transform: scale(0.3); opacity: 0; }100% { transform: scale(1); opacity: 1; }}`;
document.head.appendChild(style);

/* ãƒ‘ãƒ¼ãƒˆ */
const parts = [
  { label: "Part1", value: "part1" },
  { label: "Part2", value: "part2" },
  { label: "Part3", value: "part3" },
  { label: "Part4", value: "part4" },
  { label: "Part5", value: "part5" },
];

/* ====== èµ·å‹•æ™‚ ====== */
document.addEventListener("DOMContentLoaded", async () => {
  const userId = getUserIdFromQuery();

  await fetchUserInfo(userId);
  if (userId) {
    localStorage.setItem("userId", userId);
    await checkPremiumStatus(userId);
  }

  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("premium") === "true") {
    await setUserPremium(userId);
    user.isPremium = true;
    user.premium = true;
  }

  renderPartButtons();
  await loadWords();
  refreshUserStats();
  showUpdateInfoIfNeeded();
  applyTestParamsAndCommit(); // URLã«ãƒ†ã‚¹ãƒˆçµæœãŒã¤ã„ã¦ãŸã‚‰åæ˜ 
});

/* ====== URLãƒ†ã‚¹ãƒˆçµæœåæ˜  ====== */
async function applyTestParamsAndCommit() {
  const sp = new URLSearchParams(location.search);
  const from  = sp.get('from');
  const score = parseInt(sp.get('score') || '0', 10);
  const total = parseInt(sp.get('total') || '0', 10);
  const userId = getUserIdFromQuery() || 1;
  const mode = 'sentence';
  if (from !== 'test' || !total) return;

  const testStats = document.getElementById("testStats");
  if (testStats) testStats.textContent = `æ­£ç­”æ•°: ${score} / ${total}å•ä¸­`;

  const localTotalCorrectKey = `localTotalCorrect:${userId}`;
  const prevLocal = parseInt(localStorage.getItem(localTotalCorrectKey) || '0', 10);
  const newLocal  = prevLocal + score;
  localStorage.setItem(localTotalCorrectKey, String(newLocal));

  const prevLevel = Math.floor(prevLocal / 10);
  const newLevel  = Math.floor(newLocal / 10);
  for (let lv = prevLevel + 1; lv <= newLevel; lv++) showLevelUpPopup(lv);

  const committedKey = `committed:${userId}:${mode}:${score}/${total}`;
  if (sessionStorage.getItem(committedKey) === '1') return;

  try {
    const res = await fetch('/api/test/commit', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId, mode, correct: score, total })
    });
    if (res.ok) {
      sessionStorage.setItem(committedKey, '1');
    }
  } catch {}
}

/* ====== ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆè¡¨ç¤º ====== */
const latestUpdateVersion = "1.3.0";
const updateMessage = `
  <ul style="text-align: left;">
    <li>ğŸ‰ æ–°æ©Ÿèƒ½ã€Œè¡£è£…åˆ‡ã‚Šæ›¿ãˆã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ </li>
    <li>ğŸ“ˆ æ­£ç­”æ•°ã«å¿œã˜ãŸãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡ºã‚’è¿½åŠ </li>
    <li>ğŸ”’ ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ä¸€éƒ¨æ©Ÿèƒ½ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¶é™</li>
    <li>ğŸ è»½å¾®ãªãƒã‚°ä¿®æ­£ã¨UIæ”¹å–„</li>
  </ul>
`;
function showUpdateInfoIfNeeded() {
  const shownVersion = localStorage.getItem("updateInfoShownVersion");
  if (shownVersion !== latestUpdateVersion) {
    Swal.fire({ title: "âœ¨ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ± (v" + latestUpdateVersion + ")âœ¨", html: updateMessage, icon: "info", confirmButtonText: "é–‰ã˜ã‚‹", confirmButtonColor: "#e91e63" });
    localStorage.setItem("updateInfoShownVersion", latestUpdateVersion);
  }
}

/* ====== ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¤å®šï¼ˆå¤‰æ•°åä¿®æ­£ï¼‰ ====== */
async function checkPremiumStatus(userId) {
  try {
    const res = await fetch(`http://localhost:8080/user/${userId}`);
    const fetchedUser = await res.json();
    if (fetchedUser?.premium === true) {
      const video = document.createElement("video");
      video.src = "videos/run_girl_motion.mp4";
      video.autoplay = true; video.muted = true; video.loop = true; video.width = 300;
      const container = document.getElementById("premiumVideoContainer");
      if (container) { container.innerHTML = ""; container.appendChild(video); }
    }
  } catch (err) {
    console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—", err);
  }
}

/* ====== ãƒ‘ãƒ¼ãƒˆåˆ‡æ›¿ ====== */
function changePart(partName) {
  currentPart = partName;
  musouMode = (partName === 'ç„¡åŒPart');
  const userId = new URLSearchParams(window.location.search).get('userId');
  if (musouMode) {
    goToPart(userId, "ç„¡åŒPart");
  } else {
    currentPage = 1;
    loadWords();
  }
}

/* ====== ç”»åƒURL ====== */
function toSlugForImage(s) {
  return (s || "").toLowerCase().replace(/\s+/g, "_").replace(/['â€™`"]/g, "").replace(/[^a-z0-9_]/g, "");
}
function imageUrlForWord(w) {
  if (w.imageUrl) return w.imageUrl;
  if (w.pictUrl)  return w.pictUrl;
  if (w.pictUrlAnimated) return w.pictUrlAnimated;
  const slug = toSlugForImage(w.word);
  return `/images/${slug}_girl.png`;
}

/* ====== ç„¡åŒé·ç§» ====== */
function goToPart(userId, partName) {
  const url = `musou.html?userId=${userId}&part=${encodeURIComponent(partName)}`;
  window.location.href = url;
}

/* ====== ãƒ‘ãƒ¼ãƒˆãƒœã‚¿ãƒ³ ====== */
function renderPartButtons() {
  const container = document.getElementById("partButtons");
  container.innerHTML = "";
  parts.forEach(({ label, value }) => {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.onclick = () => selectPart(value);
    if (value === selectedPart) btn.style.fontWeight = "bold";
    container.appendChild(btn);
  });
}
function selectPart(part) {
  const lockedParts = ["part4", "part5", "part6", "partHealing","musou"];
  const isLockedPart = lockedParts.includes(part);
  if (!user.premium && isLockedPart && !isAdEnabled()) {
    Swal.fire({
      title: "ã“ã®ãƒ‘ãƒ¼ãƒˆã¯åºƒå‘Šè¦–è´ãŒå¿…è¦ã§ã™",
      html: `<p>åºƒå‘Šã‚’è¦‹ã‚Œã°<strong>5åˆ†é–“ã ã‘é–‹æ”¾</strong>ã•ã‚Œã¾ã™ã€‚<br><span style="color:#e91e63;font-weight:bold;">ğŸ€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡</span>ãªã‚‰ã€<strong>ç„¡åˆ¶é™ã§é–‹æ”¾</strong>ã•ã‚Œã¾ã™ã€‚</p>`,
      icon: "info", showCancelButton: true, showDenyButton: true,
      confirmButtonText: "åºƒå‘Šã‚’è¦‹ã‚‹", cancelButtonText: "ã‚„ã‚ã‚‹", denyButtonText: "ğŸ€ 300å††ã§åºƒå‘Šãªã—ï¼ç¾å¥³ã‚ãã‚Šæ”¾é¡ŒğŸ€"
    }).then(result => {
      if (result.isConfirmed) {
        watchAdGlobal();
        selectedPart = part;
        currentPart = parts.findIndex(p => p.value === part) + 1;
        currentPage = 1;
        renderPartButtons();
        loadWords();
      } else if (result.isDenied) {
        showPremiumPopup();
      }
    });
  } else {
    selectedPart = part;
    currentPart = parts.findIndex(p => p.value === part) + 1;
    currentPage = 1;
    renderPartButtons();
    loadWords();
  }
}

/* ====== ãƒ¦ãƒ¼ã‚¶ãƒ¼/å˜èªå–å¾— ====== */
function getUserIdFromQuery() {
  const params = new URLSearchParams(window.location.search);
  return params.get('userId');
}
async function fetchUserInfo(userId) {
  const res = await fetch(`http://localhost:8080/user/${userId}`);
  if (!res.ok) {
    alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
    window.location.href = "login.html";
    return;
  }
  const data = await res.json();
  user = data;
  localStorage.setItem("userId", data.id);
  document.getElementById("username").innerText = `${data.username} ã•ã‚“ã€ã‚ˆã†ã“ãï¼`;
  document.getElementById("planText").innerText = `ãƒ—ãƒ©ãƒ³: ${data.premium ? "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ " : "ç„¡æ–™"}`;
  document.getElementById("userLevel").innerText = `ãƒ¬ãƒ™ãƒ«: Lv.${data.level || 1}`;
  updateGirlVisual(data.level || 1);
  await updateLoginPointsIfNeeded(data.id);
  if (typeof data.loginPoints === 'number') showLoginBonus(data.loginPoints);
}
async function updateLoginPointsIfNeeded(userId) {
  try {
    const res = await fetch(`http://localhost:8080/api/user/updateLoginPoints`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId })
    });
    if (res.ok) {
      const updated = await res.json();
      if (typeof updated.loginPoints === 'number') {
        showLoginBonus(updated.loginPoints);
        document.getElementById("loginDays").textContent = `å­¦ç¿’æ—¥æ•°: ${updated.loginPoints}æ—¥ç›®`;
      }
    }
  } catch {}
}
async function fetchWordsFromServer(userId, part) {
  const res = await fetch(`http://localhost:8080/api/words?userId=${userId}&part=${part}`);
  if (!res.ok) { alert("å˜èªã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"); return []; }
  const data = await res.json();
  return data.map(word => {
    const s = word.status;
    const learned = (s === true || s === 1 || s === '1' || s === 'true' || s === 'LEARNED');
    return { ...word, status: !!learned };
  });
}

/* ====== ç”»åƒåˆ‡æ›¿ï¼ˆåºƒå‘Šå°ç·šã‚ã‚Šï¼‰ ====== */
let pendingToggle = null;
function getBeautyClickCount() { const n = parseInt(localStorage.getItem('beauty_clicks') || '0', 10); return isNaN(n) ? 0 : n; }
function incBeautyClickCount() { const n = getBeautyClickCount() + 1; localStorage.setItem('beauty_clicks', String(n)); return n; }
function resetBeautyClickCount() { localStorage.setItem('beauty_clicks', '0'); }
function showAdModalForToggle(callback) { pendingToggle = callback; document.getElementById('adModal').style.display = 'flex'; }
function handleAdAccept() { watchAdGlobal(); closeAdModal(); if (typeof pendingToggle === 'function') { pendingToggle(); pendingToggle = null; } resetBeautyClickCount(); }
function closeAdModal() { document.getElementById('adModal').style.display = 'none'; pendingToggle = null; }
function toggleImage(imgId, btnId, img1, img2, index) {
  const imgElem = document.getElementById(imgId);
  const pathLabel = document.getElementById(`imgpath-${index}`);
  const currentSrc = imgElem.getAttribute("src");
  if (currentSrc === img1) { imgElem.src = img2; pathLabel.textContent = img2; }
  else { imgElem.src = img1; pathLabel.textContent = img1; }
}
function handleToggleImage(imgId, btnId, img1, img2, index) {
  const proceed = () => toggleImage(imgId, btnId, img1, img2, index);
  const total = incBeautyClickCount();
  if (!user.premium && total % 6 === 0) { showAdModalForToggle(proceed); return; }
  proceed();
}

/* ====== å˜èªä¸€è¦§æç”» + ãƒšãƒ¼ã‚¸ãƒ£ ====== */
function renderWords() {
  const container = document.getElementById("wordContainer");
  container.innerHTML = "";

  const total = words.length;
  const pageCount = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > pageCount) currentPage = pageCount;

  const start = (currentPage - 1) * pageSize;
  const pageWords = words.slice(start, start + pageSize);

  pageWords.forEach((word, index) => {
    const div = document.createElement("div");
    div.className = "word-card";

    const checkboxId = `status-${word.id}`;
    const checked = word.status ? "checked" : "";
    const labelText = word.status ? "å­¦ç¿’æ¸ˆã¿" : "æœªå­¦ç¿’";

    const imageId = `img-${start + index}`;
    const toggleButtonId = `toggle-${start + index}`;
    const baseImg = '/images/beauty.png';
    const slug = toSlugForImage(word.word);
    const specificImg = `/images/${slug}_girl.png`;

    div.innerHTML = `
      <strong>${word.word}</strong>ï¼ˆ${word.meaning}ï¼‰<br>
      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
        <input type="checkbox" id="${checkboxId}" ${checked}
               onchange="toggleStatus(this.checked, ${word.id}, selectedPart)">
        <span id="status-label-${word.id}">${labelText}</span>

      <div>ç”»åƒãƒ‘ã‚¹: <span id="imgpath-${start + index}">${baseImg}</span></div>
      <img id="${imageId}" src="${baseImg}" width="150" onerror="this.src='/images/beauty.png'"><br>

      <button id="${toggleButtonId}"
              onclick="handleToggleImage('${imageId}','${toggleButtonId}','${baseImg}','${specificImg}','${start + index}')">
        ç¾å¥³ã§è‹±å˜èªã‚’è¡¨ç¾ã™ã‚‹
      </button>
    `;
    container.appendChild(div);
  });

  renderPagination(total);
}

function renderPagination(totalItems) {
  const pagination = document.getElementById("pagination");
  pagination.innerHTML = "";
  const pageCount = Math.max(1, Math.ceil(totalItems / pageSize));

  const btnFirst = document.createElement("button");
  btnFirst.textContent = "â‰ª";
  btnFirst.disabled = currentPage === 1;
  btnFirst.onclick = () => { currentPage = 1; renderWords(); };
  pagination.appendChild(btnFirst);

  const btnPrev = document.createElement("button");
  btnPrev.textContent = "ï¼œ";
  btnPrev.disabled = currentPage === 1;
  btnPrev.onclick = () => { currentPage = Math.max(1, currentPage - 1); renderWords(); };
  pagination.appendChild(btnPrev);

  // ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆÂ±2ã ã‘è¡¨ç¤ºï¼‰
  const pages = [];
  for (let i = Math.max(1, currentPage - 2); i <= Math.min(pageCount, currentPage + 2); i++) pages.push(i);
  pages.forEach(i => {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.onclick = () => { currentPage = i; renderWords(); };
    if (i === currentPage) btn.style.fontWeight = "bold";
    pagination.appendChild(btn);
  });

  const btnNext = document.createElement("button");
  btnNext.textContent = "ï¼";
  btnNext.disabled = currentPage === pageCount;
  btnNext.onclick = () => { currentPage = Math.min(pageCount, currentPage + 1); renderWords(); };
  pagination.appendChild(btnNext);

  const btnLast = document.createElement("button");
  btnLast.textContent = "â‰«";
  btnLast.disabled = currentPage === pageCount;
  btnLast.onclick = () => { currentPage = pageCount; renderWords(); };
  pagination.appendChild(btnLast);

  const info = document.createElement("span");
  info.className = "page-info";
  info.textContent = `ãƒšãƒ¼ã‚¸ ${currentPage} / ${pageCount}ï¼ˆå…¨${totalItems}ä»¶ï¼‰`;
  pagination.appendChild(info);
}

async function loadWords() {
  const userId = getUserIdFromQuery();
  words = await fetchWordsFromServer(userId, selectedPart);
  currentPage = 1; // ãƒ‘ãƒ¼ãƒˆåˆ‡æ›¿ãƒ»å†èª­è¾¼æ™‚ã¯å…ˆé ­ã¸
  renderWords();
  updateStatusCount();

  document.getElementById("loginDays").textContent = `å­¦ç¿’æ—¥æ•°: ${user.loginPoints || 0}æ—¥ç›®`;

  const correct = localStorage.getItem("test_correct") || 0;
  const total = localStorage.getItem("test_total") || 0;
  document.getElementById("testStats").textContent = `æ­£ç­”æ•°: ${correct} / ${total}å•ä¸­`;
  await refreshUserStats();
}

/* ====== åºƒå‘Šæœ‰åŠ¹æ™‚é–“ ====== */
function watchAdGlobal() {
  const now = Date.now();
  const expiry = now + 5 * 60 * 1000;
  localStorage.setItem("ad_expiry", expiry.toString());
  alert("åºƒå‘Šè¦–è´å®Œäº†ï¼");
  renderWords();
}
function isAdEnabled() {
  const expiry = localStorage.getItem("ad_expiry");
  return expiry && Date.now() < parseInt(expiry);
}

/* ====== ãã®ä»–UI ====== */
function getUserId() { return localStorage.getItem("userId") || new URLSearchParams(window.location.search).get("userId") || 1; }
function playVideo(videoUrl) {
  const modal = document.getElementById("videoModal");
  const player = document.getElementById("videoPlayer");
  player.src = videoUrl;
  modal.style.display = "flex";
  modal.onclick = () => { modal.style.display = "none"; player.pause(); player.currentTime = 0; };
}
function updateGirlVisual(level) {
  const video = document.getElementById("girlVideo");
  const bg = document.getElementById("bgEffect");
  if (level >= 20) { video.src = "/videos/girl_idle_loop.mp4"; bg.className = "heart-bg"; }
  else if (level >= 10) { video.src = "/videos/girl_idle_loop.mp4"; bg.className = "star-bg"; }
  else { video.src = "/videos/girl_idle_loop.mp4"; bg.className = "normal-bg"; }
}

/* ====== å­¦ç¿’æ¸ˆã¿ãƒˆã‚°ãƒ« â†’ ã‚µãƒ¼ãƒåæ˜  ====== */
function toggleStatus(isChecked, wordId, part) {
  const userId = getUserIdFromQuery();
  fetch('/api/learning/update', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, wordId, status: isChecked, part })
  })
  .then(response => {
    if (!response.ok) { alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"); return; }
    const word = words.find(w => w.id === wordId);
    if (word) {
      word.status = isChecked;
      const statusSpan = document.getElementById(`status-label-${wordId}`);
      if (statusSpan) statusSpan.innerText = isChecked ? "å­¦ç¿’æ¸ˆã¿" : "æœªå­¦ç¿’";
    }
    updateStatusCount();
  })
  .catch(() => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"));
}
async function updateStatusCount() {
  const userId = getUserIdFromQuery();
  try {
    const res = await fetch(`http://localhost:8080/api/learning/count?userId=${userId}&part=${selectedPart}`);
    if (!res.ok) throw new Error();
    const learnedCount = await res.json();
    const totalCount = words.length;
    const unlearnedCount = Math.max(0, totalCount - learnedCount);
    document.getElementById("learningStatus").textContent = `å­¦ç¿’æ¸ˆã¿: ${learnedCount} / æœªå­¦ç¿’: ${unlearnedCount}`;
  } catch {
    document.getElementById("learningStatus").textContent = "å­¦ç¿’çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
}

/* ====== é€±æ¬¡æ£’ã‚°ãƒ©ãƒ• ====== */
async function loadWeeklyAnswers(){
  const userId = getUserIdFromQuery() || localStorage.getItem('userId') || 1;
  try{
    const res = await fetch(`/api/test/weekly?userId=${userId}`);
    if(!res.ok) return;
    const data = await res.json();
    const max = Math.max(1, ...data.map(d => d.answers));
    const bars = document.getElementById('weeklyBars');
    const labels = document.getElementById('weeklyLabels');
    bars.innerHTML = ''; labels.innerHTML = '';

    data.forEach(d => {
      const h = Math.round((d.answers / max) * 120);
      const wrap = document.createElement('div');
      wrap.style.flex = '1'; wrap.style.display = 'flex'; wrap.style.flexDirection = 'column'; wrap.style.alignItems = 'center'; wrap.style.justifyContent = 'flex-end';
      const num = document.createElement('div'); num.textContent = d.correct; num.style.fontSize = '.8rem'; num.style.color = '#e91e63'; num.style.marginBottom = '4px'; wrap.appendChild(num);
      const bar = document.createElement('div'); bar.title = `æ­£è§£:${d.correct} / è§£ç­”:${d.answers}`; bar.style.width = '24px'; bar.style.height = `${h}px`; bar.style.borderRadius = '8px'; bar.style.background = 'linear-gradient(180deg,#ff7bbd,#ffb3d9)'; bar.style.boxShadow = '0 2px 6px rgba(0,0,0,.08)'; wrap.appendChild(bar);
      bars.appendChild(wrap);
      const dd = new Date(d.ymd); const label = document.createElement('div'); const mmdd = `${(dd.getMonth()+1).toString().padStart(2,'0')}/${dd.getDate().toString().padStart(2,'0')}`; const youbi = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dd.getDay()];
      label.style.flex='1'; label.style.textAlign='center'; label.innerHTML = `<div>${mmdd}</div><div style="opacity:.7">${youbi}</div>`;
      labels.appendChild(label);
    });
  }catch(e){ console.warn('weekly chart load failed', e); }
}
document.addEventListener("DOMContentLoaded", loadWeeklyAnswers);

/* ====== ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ ====== */
function showLoginBonus(points) {
  const grid = document.getElementById('stampGrid');
  grid.innerHTML = '';
  const displayPoints = Math.max(points, 1);
  for (let i = 1; i <= 30; i++) {
    const cell = document.createElement('div');
    cell.style.width = '60px'; cell.style.height = '60px'; cell.style.border = '1px solid #999'; cell.style.display = 'flex'; cell.style.justifyContent = 'center'; cell.style.alignItems = 'center'; cell.style.backgroundColor = '#eee';
    if (i <= displayPoints) {
      const img = document.createElement('img');
      img.src = '/images/stamp_beauty.png'; img.alt = 'ã‚¹ã‚¿ãƒ³ãƒ—'; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; img.style.borderRadius = '50%'; img.style.border = '2px solid pink';
      if (i === displayPoints) img.style.animation = 'pop 0.6s ease';
      cell.appendChild(img);
    } else {
      const label = document.createElement('div'); label.textContent = `${i}æ—¥ç›®`; label.style.fontSize = '12px'; cell.appendChild(label);
    }
    grid.appendChild(cell);
  }
  document.getElementById('loginBonusPopup').style.display = 'block';
}
function closeLoginBonus() { document.getElementById("loginBonusPopup").style.display = "none"; }
function getTitleByLevel(level) {
  if (level >= 20) return "ãƒ›ãƒƒãƒˆãƒ‘ãƒ³ãƒ„ã®è¦‡è€…";
  if (level >= 15) return "ã‚»ã‚¯ã‚·ãƒ¼å­¦ç¿’ç‹";
  if (level >= 10) return "ãƒ•ãƒªãƒ•ãƒªç¾å¥³ãƒã‚¹ã‚¿ãƒ¼";
  if (level >= 5) return "Newbie";
  return "ãƒ“ã‚®ãƒŠãƒ¼";
}
function showLevelUpPopup(newLevel) {
  const title = getTitleByLevel(newLevel);
  Swal.fire({
    title: 'ğŸ‰ LEVEL UPï¼ğŸ‰',
    html: `<p style="font-size: 20px;">æ–°ã—ã„ãƒ¬ãƒ™ãƒ«: Lv.${newLevel}</p><div style="margin-top: 10px;">ç§°å·ï¼š<strong>${title}</strong></div><div class="slide-message" style="font-size: 18px; margin-top: 10px;">ã“ã®èª¿å­ã§é ‘å¼µã‚ã†ï¼</div><br><button id="shareButton" style="background:#1da1f2;color:white;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;">SNSã§ã‚·ã‚§ã‚¢ã™ã‚‹</button>`,
    showConfirmButton: false, timer: 6000,
    didOpen: () => {
      document.getElementById("shareButton").addEventListener("click", () => {
        const shareText = `ç§ã¯ä»Šãƒ¬ãƒ™ãƒ«${newLevel}ã§ã€Œ${title}ã€ã«åˆ°é”ã—ã¾ã—ãŸï¼ #ç¾å¥³å˜`;
        const shareUrl = encodeURIComponent("https://your-app-url.com");
        const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${shareUrl}`;
        window.open(tweetUrl, '_blank');
      });
    }
  });
}

/* ====== ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ¡ˆå†… ====== */
function showPremiumPopup() {
  Swal.fire({
    title: 'ğŸ€ ç¾å¥³å˜ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ ğŸ€',
    html: `<div style="text-align:left; font-size: 0.95rem;">
      <p>å…¨ãƒ¢ãƒ¼ãƒ‰è§£æ”¾ï¼†åºƒå‘Šãªã—ã®è´…æ²¢ä½“é¨“</p>
      <ul style="line-height:1.6;">
        <li>âœ” ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰è§£æ”¾</li>
        <li>âœ” ãƒ†ã‚¹ãƒˆå›æ•°ç„¡åˆ¶é™ï¼†æˆç¸¾å±¥æ­´ã‚‚ä¿å­˜</li>
      </ul>
      <p style="font-weight:bold; font-size:1.1rem;">ğŸ’° æœˆé¡500å††ï¼ˆç¨è¾¼ï¼‰</p>
      <p style="color:red;">âœ¨ ä»Šã ã‘åˆæœˆ300å††ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸­ âœ¨</p>
      <small>SNSã§ã‚·ã‚§ã‚¢ã™ã‚‹ã¨1é€±é–“ç„¡æ–™ä½“é¨“ğŸ</small>
    </div>`,
    showCancelButton: true,
    confirmButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«ç™»éŒ²ã™ã‚‹",
    cancelButtonText: "ã‚ã¨ã§è¦‹ã‚‹",
    customClass: { popup: 'premium-popup', confirmButton: 'btn-premium' }
  }).then(result => { if (result.isConfirmed) window.location.href = "/premium.html"; });
}

/* ====== ãƒ†ã‚¹ãƒˆèµ·å‹• ====== */
function startTest() {
  const userId = new URLSearchParams(window.location.search).get("userId");
  const testCount = localStorage.getItem("test_started");
  if (testCount) { alert("åºƒå‘Šã‚’è¦‹ã›ã‚‹å‡¦ç†ï¼ˆä»®ï¼‰"); }
  if (user.premium) {
    Swal.fire({
      title: "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
      html: `<button id="readingBtn" class="swal2-confirm swal2-styled" style="margin: 5px;">ğŸ“˜ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</button>
             <button id="listeningBtn" class="swal2-confirm swal2-styled" style="background:#3949ab;margin: 5px;">ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>`,
      showConfirmButton: false,
      didOpen: () => {
        document.getElementById("readingBtn").onclick = () => { localStorage.setItem("test_started","1"); location.href = `test.html?userId=${userId}&mode=reading`; };
        document.getElementById("listeningBtn").onclick = () => { localStorage.setItem("test_started","1"); location.href = `test.html?userId=${userId}&mode=listening`; };
      }
    });
  } else {
    Swal.fire({
      title: "ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ å°‚ç”¨ğŸ§",
      html: `<p>ä»Šã¯ <strong>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰</strong>ã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p><p>ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç™»éŒ²ã§ <strong>éŸ³å£°ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</strong>ã‚‚å¯èƒ½ã«ï¼</p>`,
      showCancelButton: true, confirmButtonText: "ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§å§‹ã‚ã‚‹", cancelButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’è¦‹ã‚‹",
    }).then(result => {
      if (result.isConfirmed) { localStorage.setItem("test_started","1"); location.href = `test.html?userId=${userId}&mode=reading`; }
      else if (result.dismiss === Swal.DismissReason.cancel) { showPremiumPopup(); }
    });
  }
}
function startVocabularyTest() {
  const userId = new URLSearchParams(window.location.search).get("userId");
  const testCount = localStorage.getItem("test_started");
  if (testCount) { alert("åºƒå‘Šã‚’è¦‹ã›ã‚‹å‡¦ç†ï¼ˆä»®ï¼‰"); }
  if (user.premium) {
    Swal.fire({
      title: "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
      html: `<button id="readingBtn" class="swal2-confirm swal2-styled" style="margin: 5px;">ğŸ“˜ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</button>
             <button id="listeningBtn" class="swal2-confirm swal2-styled" style="background:#3949ab;margin: 5px;">ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>`,
      showConfirmButton: false,
      didOpen: () => {
        document.getElementById("readingBtn").onclick = () => { localStorage.setItem("test_started","1"); location.href = `vocabularyTest.html?userId=${userId}&mode=reading`; };
        document.getElementById("listeningBtn").onclick = () => { localStorage.setItem("test_started","1"); location.href = `vocabularyTest.html?userId=${userId}&mode=listening`; };
      }
    });
  } else {
    Swal.fire({
      title: "ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ å°‚ç”¨ğŸ§",
      html: `<p>ä»Šã¯ <strong>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰</strong>ã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p><p>ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç™»éŒ²ã§ <strong>éŸ³å£°ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</strong>ã‚‚å¯èƒ½ã«ï¼</p>`,
      showCancelButton: true, confirmButtonText: "ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§å§‹ã‚ã‚‹", cancelButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’è¦‹ã‚‹",
    }).then(result => {
      if (result.isConfirmed) { localStorage.setItem("test_started","1"); location.href = `vocabularyTest.html?userId=${userId}&mode=reading`; }
      else if (result.dismiss === Swal.DismissReason.cancel) { showPremiumPopup(); }
    });
  }
}

/* ====== ç´¯è¨ˆãƒ»ãƒ¬ãƒ™ãƒ«åŒæœŸ ====== */
async function refreshUserStats() {
  const userId = getUserIdFromQuery() || localStorage.getItem('userId') || 1;
  try {
    const res = await fetch(`/user/${userId}`);
    if (res.ok) {
      const u = await res.json();
      const days = (typeof u.loginPoints === 'number') ? u.loginPoints : 0;
      document.getElementById("loginDays").textContent = `å­¦ç¿’æ—¥æ•°: ${days}æ—¥ç›®`;
      const totalCorrect = Number(u.testCorrectTotal ?? 0);
      document.getElementById("testStats").textContent = `æ­£ç­”æ•°ï¼ˆç´¯è¨ˆï¼‰: ${totalCorrect}`;
      const newLevel = Math.max(1, Math.floor(totalCorrect / 10) + 1);
      const currentLevel = Number(u.level ?? 1);
      if (currentLevel !== newLevel) {
        const r = await fetch(`/user/updateLevel`, {
          method: 'PUT', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, level: newLevel })
        });
        if (r.ok) { const json = await r.json().catch(() => ({})); u.level = Number(json.level ?? newLevel); }
        else { u.level = newLevel; }
      }
      const levelEl = document.getElementById("userLevel");
      const lv = Number(u.level ?? 1);
      if (levelEl) levelEl.textContent = `ãƒ¬ãƒ™ãƒ«: Lv.${lv}`;
      updateGirlVisual(lv);

      const prev = parseInt(localStorage.getItem('previousCorrect') || '0', 10);
      const prevLv = Math.floor(prev / 10), newLv  = Math.floor(totalCorrect / 10);
      if (newLv > prevLv) { for (let lv = prevLv + 1; lv <= newLv; lv++) showLevelUpPopup(lv); }
      localStorage.setItem('previousCorrect', String(totalCorrect));
      return;
    }
  } catch {}
  try {
    const r2 = await fetch(`/api/test/weekly?userId=${userId}`);
    if (r2.ok) {
      const w = await r2.json();
      const days = w.filter(d => d.answers > 0).length;
      document.getElementById("loginDays").textContent = `å­¦ç¿’æ—¥æ•°(ç›´è¿‘7æ—¥): ${days}æ—¥`;
    }
  } catch {}
}

async function setUserPremium(userId) {
  try {
    const res = await fetch(`http://localhost:8080/api/user/updatePremium`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId })
    });
    if (!res.ok) throw new Error("æ›´æ–°ã«å¤±æ•—");
    console.log("âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã‚’DBã«åæ˜ ã—ã¾ã—ãŸ");
  } catch (err) { console.error("âŒ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è¨­å®šå¤±æ•—:", err); }
}

/* ====== ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ ====== */
let swipeWords = [];
let swipeIndex = 0;
let swipeLearned = 0;
let swipeUnlearned = 0;
let swipeDrag = null;
let currentSwipeMode = "unlearned";
const SWIPE_THRESHOLD = 80;

function swipeTodayKey(userId){
  const d = new Date();
  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  return `swipeExcluded:${userId}:${ymd}`;
}
function todayKey(type){
  const d = new Date();
  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  return `swipe:${type}:${getUserId()}:${ymd}`;
}
function getTodaySet(type){
  const raw = localStorage.getItem(todayKey(type));
  return new Set(raw ? JSON.parse(raw) : []);
}
function addTodaySet(type, wordId){
  const set = getTodaySet(type);
  set.add(wordId);
  localStorage.setItem(todayKey(type), JSON.stringify([...set]));
}
function getSwipeExcludedSet(userId){
  const raw = localStorage.getItem(swipeTodayKey(userId));
  return new Set(raw ? JSON.parse(raw) : []);
}
function addToSwipeExcluded(userId, wordId){
  const key = swipeTodayKey(userId);
  const set = getSwipeExcludedSet(userId);
  set.add(wordId);
  localStorage.setItem(key, JSON.stringify([...set]));
}

function setSwipeModeVisible(show){
  document.getElementById('swipeModeBox').classList.toggle('hidden', !show);
  document.getElementById('wordContainer').classList.toggle('hidden', show);
  document.getElementById('pagination').classList.toggle('hidden', show);
  document.getElementById('test-section').classList.toggle('hidden', show);
  document.getElementById('weeklyAnswersBox').classList.toggle('hidden', show);
}

function startSwipeMode(partValue = selectedPart){
  selectedPart = partValue;
  const lockedParts = ["part4", "part5", "part6", "partHealing", "musou"];
  const isLocked = lockedParts.includes(selectedPart);
  if(!user.premium && isLocked && !isAdEnabled()){ showPremiumPopup(); return; }
  Swal.fire({
    title: "ç¾å¥³ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ğŸ€",
    html: "å­¦ç¿’é–‹å§‹å‰ã¨çµ‚äº†æ™‚ã«åºƒå‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆè¨ˆ2å›ï¼‰<br>ç¾å¥³ã¨ä¸€ç·’ã«æ¥½ã—ãå­¦ç¿’ã—ã¾ã—ã‚‡ã†ï¼",
    icon: "info", confirmButtonText: "åºƒå‘Šã‚’è¦‹ã‚‹", confirmButtonColor: "#e91e63", allowOutsideClick: false
  }).then(() => { watchAdGlobal(); showSwipeModeSelection(); });
}
function showSwipeModeSelection() {
  Swal.fire({
    title: "ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
    html: `<div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button id="btnUnlearned" class="swal2-confirm swal2-styled">æœªå­¦ç¿’ã‚’è¦šãˆã‚‹</button>
      <button id="btnReview" class="swal2-confirm swal2-styled" style="background:#3949ab">å¾©ç¿’ãƒã‚§ãƒƒã‚¯</button>
    </div>`,
    showConfirmButton: false,
    didOpen: () => {
      document.getElementById("btnUnlearned").onclick = () => { currentSwipeMode = "unlearned"; Swal.close(); initSwipeMode("unlearned"); };
      document.getElementById("btnReview").onclick   = () => { currentSwipeMode = "review";    Swal.close(); initSwipeMode("review"); };
    }
  });
}
function shuffle(arr){ for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

async function buildSwipeDeck(mode = "unlearned"){
  const userId   = getUserIdFromQuery() || getUserId();
  const excluded = getSwipeExcludedSet(userId);
  const allUnlearned = words.filter(w => !w.status);
  const allLearned   = words.filter(w =>  w.status);
  let unlearned = allUnlearned.filter(w => !excluded.has(w.id));
  let learned   = allLearned.filter(w   => !excluded.has(w.id));
  if (mode === "review" && learned.length === 0 && allLearned.length > 0) learned = allLearned.slice();
  shuffle(unlearned); shuffle(learned);
  if (mode === "unlearned") return shuffle(unlearned.slice(0, 10));
  if (mode === "review")    return shuffle(learned.slice(0, 10));
  return shuffle([ ...unlearned.slice(0,25), ...learned.slice(0,5) ]);
}

async function initSwipeMode(mode = "unlearned"){
  currentSwipeMode = mode;
  setSwipeModeVisible(true);
  const userId = getUserIdFromQuery() || 1;
  if (!Array.isArray(words) || words.length === 0) words = await fetchWordsFromServer(userId, selectedPart);
  swipeWords = await buildSwipeDeck(mode);
  if (swipeWords.length === 0) {
    const msg = (mode === "review") ? "ä»Šæ—¥ã¯å¾©ç¿’ç”¨ã®å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" : "ä»Šæ—¥ã¯å‡ºé¡Œã™ã‚‹æœªå­¦ç¿’ãŒã‚ã‚Šã¾ã›ã‚“";
    Swal.fire({icon:'info', title: msg, text:'ãƒ‘ãƒ¼ãƒˆå¤‰æ›´ã‚„æ˜æ—¥ã¾ãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã­ï¼'});
    setSwipeModeVisible(false);
    return;
  }
  swipeIndex = 0; swipeLearned = 0; swipeUnlearned = 0;
  await renderSwipeDeck();
  updateSwipeHUD();
  document.getElementById('swipeExitBtn').onclick = exitSwipeMode;
}

function exitSwipeMode(){ setSwipeModeVisible(false); renderWords(); updateStatusCount(); }

async function renderSwipeDeck(){
  const deckEl = document.getElementById('swipeDeck');
  deckEl.innerHTML = '';
  if (!Array.isArray(swipeWords) || swipeWords.length === 0) swipeWords = await buildSwipeDeck(currentSwipeMode);
  const show = swipeWords.slice(swipeIndex, Math.min(swipeIndex + 3, swipeWords.length));
  show.forEach((w, idx) => {
    const card = document.createElement('div');
    card.className = 'swipe-card';
    card.style.zIndex = String(100 - idx);
    card.dataset.index = String(swipeIndex + idx);
    const src = imageUrlForWord(w);
    card.innerHTML = `
      <div class="swipe-badge badge-left">è¦šãˆã¦ãªã„</div>
      <div class="swipe-badge badge-right">è¦šãˆãŸï¼</div>
      <div class="swipe-word">${w.word}</div>
      <div class="swipe-mean">(${w.meaning})</div>
      <img class="swipe-img" src="${src}" alt="" draggable="false">
    `;
    card.querySelector('.swipe-img').onerror = (e)=>{ e.target.src = '/images/beauty.png'; };
    attachSwipeHandlers(card);
    deckEl.appendChild(card);
  });
}

function attachSwipeHandlers(card){
  card.addEventListener('pointerdown', e => {
    e.preventDefault();
    card.setPointerCapture(e.pointerId);
    swipeDrag = {startX:e.clientX, startY:e.clientY, el:card};
    card.style.transition = 'none';
  });
  card.addEventListener('pointermove', e => {
    if(!swipeDrag || swipeDrag.el!==card) return;
    const dx = e.clientX - swipeDrag.startX;
    const dy = e.clientY - swipeDrag.startY;
    const rot = dx * 0.05;
    card.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;
    const left  = card.querySelector('.badge-left');
    const right = card.querySelector('.badge-right');
    if(dx < -20){ left.style.opacity = Math.min(1, (-dx)/80); right.style.opacity = 0; }
    else if(dx > 20){ right.style.opacity = Math.min(1, (dx)/80); left.style.opacity = 0; }
    else { left.style.opacity = right.style.opacity = 0; }
  });
  card.addEventListener('pointerup', e => endSwipe(card, e));
  card.addEventListener('pointercancel', () => {
    card.style.transition = '.2s ease'; card.style.transform = 'translate(0,0) rotate(0)';
    card.querySelector('.badge-left').style.opacity  = 0;
    card.querySelector('.badge-right').style.opacity = 0;
    swipeDrag = null;
  });
  card.addEventListener('dragstart', e => e.preventDefault());
}
function endSwipe(card, e){
  if(!swipeDrag){ return; }
  const dx = e.clientX - swipeDrag.startX;
  swipeDrag = null;
  if(dx <= -SWIPE_THRESHOLD){ decideSwipe(card, 'left'); }
  else if(dx >= SWIPE_THRESHOLD){ decideSwipe(card, 'right'); }
  else{
    card.style.transition = '.2s ease';
    card.style.transform = 'translate(0,0) rotate(0)';
    card.querySelector('.badge-left').style.opacity = 0;
    card.querySelector('.badge-right').style.opacity = 0;
  }
}
async function decideSwipe(card, dir){
  const i = swipeIndex;
  const w = swipeWords[i];
  const isRight = (dir === 'right');
  card.style.transition = '.2s ease';
  const off = (isRight ? 600 : -600);
  card.style.transform = `translate(${off}px,-40px) rotate(${off>0?15:-15}deg)`;
  setTimeout(() => card.remove(), 200);

  if (currentSwipeMode === "unlearned") {
    if (isRight) { addTodaySet('learned', w.id); addToSwipeExcluded(getUserId(), w.id); swipeLearned++; }
    else { addTodaySet('unlearned', w.id); swipeUnlearned++; }
  } else {
    if (isRight) { swipeLearned++; addTodaySet('review_ok', w.id); }
    else { swipeUnlearned++; addTodaySet('review_ng', w.id); }
    addToSwipeExcluded(getUserId(), w.id);
  }

  swipeIndex++;
  updateSwipeHUD();

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ€å¾Œã«åºƒå‘Š
  if (swipeIndex === swipeWords.length) { watchAdGlobal(); }

  if (swipeIndex < swipeWords.length) { await renderSwipeDeck(); }
  else { exitSwipeMode(); }
}
function updateSwipeHUD(){
  const total = swipeWords.length;
  document.getElementById('swipeCounter').textContent = `${swipeIndex}/${total}`;
  if (currentSwipeMode === "unlearned") {
    const learnedSet   = getTodaySet('learned');
    const unlearnedSet = getTodaySet('unlearned');
    document.getElementById('swipeStats').textContent = `è¦šãˆãŸ: ${learnedSet.size} / è¦šãˆã¦ãªã„: ${unlearnedSet.size}`;
  } else {
    document.getElementById('swipeStats').textContent = `OK: ${swipeLearned} / å¿˜ã‚Œã¦ã„ãŸ: ${swipeUnlearned}`;
  }
}
</script>

<!-- åºƒå‘Šãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="adModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div class="modal-content" style="background:white; padding:30px; border-radius:10px; max-width:90%; text-align:center;">
    <h2 style="color:#e91e63;">ã“ã®ãƒ‘ãƒ¼ãƒˆã¯åºƒå‘Šè¦–è´ãŒå¿…è¦ã§ã™</h2>
    <p>åºƒå‘Šã‚’è¦‹ã‚‹ã¨5åˆ†ã ã‘ç¾å¥³ã§è‹±å˜èªã‚’è¡¨ç¾ã™ã‚‹ãƒœã‚¿ãƒ³ãŒé–‹æ”¾ã•ã‚Œã¾ã™ã€‚<br>æœ‰æ–™ãƒ—ãƒ©ãƒ³ãªã‚‰ç„¡åˆ¶é™ã§é–‹æ”¾ã•ã‚Œã¾ã™ã€‚</p>
    <div class="modal-buttons" style="margin-top:20px;">
      <button id="watchAdBtn" class="btn btn-primary" onclick="handleAdAccept()">åºƒå‘Šã‚’è¦‹ã‚‹</button>
      <button id="closeModalBtn" class="btn btn-secondary" onclick="closeAdModal()">ã‚„ã‚ã‚‹</button>
      <button id="upgradeBtn" class="btn btn-premium" onclick="location.href='/premium.html'">ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã§ç„¡åˆ¶é™é–‹æ”¾ (æœˆé¡300å††)ğŸ€</button>
    </div>
  </div>
</div>
</body>
</html>
