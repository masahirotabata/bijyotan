<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>美女単語（ユーザー）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; background: rgb(249, 249, 249); }
    h1, h3 { text-align: center; color: rgb(233, 30, 99); }
    #username, #plan { display: block; text-align: center; margin: 10px 0; font-size: 1.1em; }

    .word-card { background: #eef7ff; border: 1px solid #ccc; border-radius: 8px; margin: 10px auto; padding: 12px; max-width: 90%; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); font-size: 0.95rem; }

    .pagination { text-align: center; margin: 20px 0; display:flex; gap:6px; flex-wrap:wrap; justify-content:center; align-items:center;}
    .pagination button { margin: 2px; padding: 8px 12px; font-size: 0.9rem; }
    .pagination .page-info { font-size:.9rem; color:#555; padding:0 6px; }

    .locked { background: #ffdddd; padding: 10px; text-align: center; }
    .musou-card { background: #fff5f5; border: 1px solid #f48fb1; border-radius: 10px; padding: 10px; margin: 10px 0; }

    button { padding: 10px 20px; border: none; border-radius: 20px; background-color: #ff4081; color: white; font-size: 1rem; margin: 5px; cursor: pointer; }
    button:hover { background-color: #f50057; }

    #user-info { text-align: left; margin: 10px 0 20px; font-size: 1.1rem; padding-left: 10px; }

    #bgEffect { position: absolute; width: 180px; height: 180px; top: 0; left: 50%; transform: translateX(-50%); z-index: -1; }
    .star-bg { background: radial-gradient(circle, #fff 20%, transparent 70%); animation: sparkle 1.5s infinite alternate; }
    .heart-bg { background: url('/images/heart_bg.gif') center center / cover no-repeat; }
    @keyframes sparkle { 0% { opacity: 0.6; transform: scale(1); } 100% { opacity: 1; transform: scale(1.05); } }

    #planText { text-align: left; color: #333; font-weight: bold; }

    #partButtons { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 20px; }

    #statsBox { background: #fff3f8; border: 1px solid #ff99c9; border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 500px; box-shadow: 2px 2px 6px rgba(0,0,0,0.05); font-weight: bold; font-size: 1rem; }
    #learningStatus { text-align: center; margin-bottom: 10px; color: #333; }
    #subStats { display: flex; justify-content: space-between; font-size: 0.95rem; padding: 0 10px; color: #555; }
    #subStats div { flex: 1; text-align: center; }

    #loginBonusPopup { display: none; position: fixed; top: 10%; left: 5%; width: 90%; height: 75%; background: white; border: 2px solid #ccc; z-index: 9999; padding: 20px; overflow: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .swal2-popup.premium-popup { font-family: 'sans-serif'; border-radius: 15px; padding: 20px; max-width: 400px; }
    #stampGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }

    #test-section { text-align: center; margin: 20px 0; }

    #videoModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 999; }
    video { width: 90%; max-height: 80vh; }

    @media (max-width: 480px) {
      h1, h3 { font-size: 1.3rem; }
      button { font-size: 0.9rem; padding: 10px; width: 90%; }
      #partButtons { flex-direction: column; align-items: center; }
      .word-card { font-size: 0.9rem; }
    }

    .btn-premium { background-color: #e91e63; color: white; border: none; padding: 10px 18px; border-radius: 6px; font-size: 1em; margin-top: 10px; cursor: pointer; transition: background-color 0.3s ease; }
    .btn-premium:hover { background-color: #d81b60; }

    .hidden{display:none;}
    #swipeModeBox{ max-width:700px;margin:16px auto;padding:10px; }
    #swipeDeck{ position:relative;height:360px;user-select:none;touch-action:pan-y; }
    .swipe-card{ position:absolute;inset:0;margin:auto;width:92%;max-width:580px;height:340px;background:#fff;border-radius:14px;border:1px solid #eee;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:18px;display:flex;flex-direction:column;justify-content:center;align-items:center;transition:transform .2s ease, opacity .2s ease; }
    .swipe-word{font-size:28px;font-weight:700;margin-bottom:8px;}
    .swipe-mean{color:#555;margin-bottom:12px;}
    .swipe-img{ width:220px;height:300px;object-fit:cover;border-radius:10px;background:#f2f2f2;-webkit-user-drag:none;user-drag:none;user-select:none;pointer-events:none; }
    .swipe-badge{ position:absolute;top:12px;font-weight:700;padding:6px 10px;border-radius:8px;opacity:0; }
    .badge-left{left:12px;background:#fde68a;color:#92400e;}
    .badge-right{right:12px;background:#dcfce7;color:#166534;}
    .swipe-hud{display:flex;justify-content:space-between;align-items:center;margin:6px 6px 10px;}
    .swipe-hints{display:flex;justify-content:space-between;color:#888;margin-top:6px;padding:0 4px;}
    .swipe-card .caption { display: none !important; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<!-- スタンプカードポップアップ -->
<div id="loginBonusPopup">
  <h3>ログインボーナス</h3>
  <div id="stampGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;"></div>
  <button onclick="closeLoginBonus()">OK</button>
</div>

<div id="user-info">
  <div id="username"></div>
  <div id="planText"></div>
  <div id="userLevel"></div>
</div>

<!-- ★ 追加：プレミアム動画の置き場 -->
<div id="premiumVideoContainer" style="text-align:center; margin: 8px 0;"></div>

<div id="levelGirlContainer" style="text-align:center; margin: 10px 0;">
  <div id="bgEffect" class="star-bg"></div>
  <video id="girlVideo" autoplay muted loop playsinline width="180" style="border-radius: 10px;"></video>
</div>

<!-- パート切り替え -->
<div id="partButtons"></div>

<!-- スワイプ学習 -->
<div style="text-align:center; margin:6px 0 14px;">
  <button id="swipeStartBtn" onclick="startSwipeMode()">スワイプ学習を始める</button>
</div>
<div id="swipeModeBox" class="hidden">
  <div class="swipe-hud">
    <button id="swipeExitBtn">一覧に戻る</button>
    <div id="swipeCounter">0 / 0</div>
    <div id="swipeStats">覚えた: 0 / 覚えたい: 0</div>
  </div>
  <div id="swipeDeck"></div>
  <div class="swipe-hints"><span>← 覚えてない</span><span>覚えた →</span></div>
</div>

<div id="statsBox">
  <div id="learningStatus"></div>
  <div id="subStats">
    <div id="loginDays"></div>
    <div id="testStats"></div>
  </div>
</div>

<!-- 広告と課金 -->
<div style="margin: 10px;">
  <button onclick="watchAdGlobal()">広告を見て美女が英単語を表現（5枚有効）</button>
</div>

<div id="test-section" style="text-align: center; margin: 30px 0;">
  <button id="testStartBtn" onclick="startTest()">テストを開始する</button>
  <button id="vocabTestBtn" onclick="startVocabularyTest()">テストを開始する(単語モード)</button>
  <button onclick="goToPart(getUserId(), '無双Part')">無双Partへ</button>
</div>

<div id="weeklyAnswersBox" style="max-width:700px;margin:20px auto;">
  <h3 style="text-align:center;margin:10px 0;">1週間の解答数:(目標解答数:80が目安)</h3>
  <div id="weeklyBars" style="display:flex;gap:8px;justify-content:space-between;align-items:flex-end;height:140px;padding:8px 4px;background:#fff3f8;border:1px solid #ff99c9;border-radius:12px;"></div>
  <div id="weeklyLabels" style="display:flex;gap:8px;justify-content:space-between;font-size:.8rem;margin-top:6px;color:#555;"></div>
</div>

<div id="wordContainer"></div>

<!-- ページャ領域 -->
<div class="pagination" id="pagination"></div>

<!-- 動画モーダル -->
<div id="videoModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:999;">
  <video id="videoPlayer" controls autoplay width="80%"></video>
</div>

<script>
/* =========================
   API base & fetch helper
   ========================= */
const API_BASE =
  location.hostname === 'localhost' || location.hostname === '127.0.0.1'
    ? 'http://localhost:8080'
    : ''; // 本番は同一オリジン

function api(path){ return path.startsWith('http') ? path : (API_BASE + path); }

/* =========================
   状態
   ========================= */
let words = [];
let user  = { id:null, premium:false };
let musouMode = false;

let currentPage = 1;
let pageSize    = 5;
let selectedPart = "part1";
let currentPart  = 1;

let swipeWords = [];
let swipeIndex = 0;
let swipeLearned = 0;
let swipeUnlearned = 0;
let swipeDrag = null;
let currentSwipeMode = "unlearned";
const SWIPE_THRESHOLD = 80;

const parts = [
  { label: "Part1", value: "part1" },
  { label: "Part2", value: "part2" },
  { label: "Part3", value: "part3" },
  { label: "Part4", value: "part4" },
  { label: "Part5", value: "part5" },
];

/* ちょいCSS補助 */
(() => {
  const style = document.createElement('style');
  style.innerHTML = `@keyframes pop {0%{transform:scale(.3);opacity:0}100%{transform:scale(1);opacity:1}}`;
  document.head.appendChild(style);
})();

/* =========================
   起動時
   ========================= */
document.addEventListener("DOMContentLoaded", async () => {
  const userId = getUserIdFromQuery();

  await fetchUserInfo(userId);           // ← ここで user を確定
  if (userId) {
    localStorage.setItem("userId", userId);
    await checkPremiumStatus(userId);
  }

  // ?premium=true で強制プレミアム（デバッグ/決済戻り）
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("premium") === "true") {
    await setUserPremium(userId);
    user.premium = true;
  }

  renderPartButtons();
  await loadWords();
  refreshUserStats();
  showUpdateInfoIfNeeded();
  applyTestParamsAndCommit();
  loadWeeklyAnswers();
});

/* =========================
   共通ユーティリティ
   ========================= */
function getUserIdFromQuery(){ return new URLSearchParams(location.search).get('userId'); }
function getUserId(){ return localStorage.getItem('userId') || getUserIdFromQuery() || 1; }

function toSlugForImage(s){
  return (s||'').toLowerCase().replace(/\s+/g,'_').replace(/['’`"]/g,'').replace(/[^a-z0-9_]/g,'');
}
function imageUrlForWord(w){
  if (w.imageUrl) return w.imageUrl;
  if (w.pictUrl) return w.pictUrl;
  if (w.pictUrlAnimated) return w.pictUrlAnimated;
  return `/images/${toSlugForImage(w.word)}_girl.png`;
}

/* =========================
   アップデート表示
   ========================= */
const latestUpdateVersion = "1.3.0";
const updateMessage = `
  <ul style="text-align: left;">
    <li>🎉 新機能「衣装切り替え」ボタンを追加</li>
    <li>📈 正答数に応じたレベルアップ演出を追加</li>
    <li>🔒 無料ユーザーには一部機能にプレミアム制限</li>
    <li>🐞 軽微なバグ修正とUI改善</li>
  </ul>`;
function showUpdateInfoIfNeeded(){
  const shown = localStorage.getItem("updateInfoShownVersion");
  if (shown !== latestUpdateVersion) {
    Swal.fire({ title:`✨アップデート情報 (v${latestUpdateVersion})✨`, html:updateMessage, icon:'info', confirmButtonText:'閉じる', confirmButtonColor:'#e91e63' });
    localStorage.setItem("updateInfoShownVersion", latestUpdateVersion);
  }
}

/* =========================
   ユーザー／プレミアム
   ========================= */
async function fetchUserInfo(userId){
  try{
    const res = await fetch(api(`/user/${userId}`), { credentials:'include' });
    if(!res.ok) throw new Error('user not found');
    const data = await res.json();
    user = data;
    localStorage.setItem("userId", data.id);
    byId("username").innerText  = `${data.username ?? data.email ?? 'ユーザー'} さん、ようこそ！`;
    byId("planText").innerText  = `プラン: ${data.premium ? 'プレミアム' : '無料'}`;
    byId("userLevel").innerText = `レベル: Lv.${data.level || 1}`;
    updateGirlVisual(data.level || 1);
    await updateLoginPointsIfNeeded(data.id);
    if (typeof data.loginPoints === 'number') showLoginBonus(data.loginPoints);
  }catch(e){
    alert("ユーザー情報が取得できません。ログインし直してください。");
    location.href = "login.html";
  }
}

async function checkPremiumStatus(userId){
  try{
    const res = await fetch(api(`/user/${userId}`));
    const u = await res.json();
    if (u?.premium) {
      const video = document.createElement('video');
      video.src = "videos/run_girl_motion.mp4";
      Object.assign(video, { autoplay:true, muted:true, loop:true, width:300 });
      const c = byId("premiumVideoContainer"); c.innerHTML = ""; c.appendChild(video);
    }
  }catch{}
}

async function setUserPremium(userId){
  try{
    const res = await fetch(api(`/api/user/updatePremium`), {
      method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId })
    });
    if(!res.ok) throw new Error();
    console.log('✅ premium updated');
  }catch(e){ console.warn('premium update failed', e); }
}

/* =========================
   ログインポイント
   ========================= */
async function updateLoginPointsIfNeeded(userId){
  try{
    const res = await fetch(api(`/api/user/updateLoginPoints`), {
      method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId })
    });
    if(res.ok){
      const updated = await res.json();
      if (typeof updated.loginPoints === 'number'){
        showLoginBonus(updated.loginPoints);
        byId("loginDays").textContent = `学習日数: ${updated.loginPoints}日目`;
      }
    }
  }catch{}
}

/* =========================
   パート切り替え
   ========================= */
function renderPartButtons(){
  const box = byId("partButtons");
  box.innerHTML = "";
  parts.forEach(({label, value})=>{
    const b = document.createElement('button');
    b.textContent = label;
    b.onclick = () => selectPart(value);
    if (value === selectedPart) b.style.fontWeight = 'bold';
    box.appendChild(b);
  });
}
function selectPart(part){
  const locked = ["part4","part5","part6","partHealing","musou"];
  const isLocked = locked.includes(part);
  if (!user.premium && isLocked && !isAdEnabled()){
    Swal.fire({
      title:"このパートは広告視聴が必要です",
      html:`<p>広告を見れば<strong>5分間だけ開放</strong>されます。<br><span style="color:#e91e63;font-weight:bold;">🎀プレミアム会員</span>なら、<strong>無制限で開放</strong>されます。</p>`,
      icon:"info", showCancelButton:true, showDenyButton:true,
      confirmButtonText:"広告を見る", cancelButtonText:"やめる", denyButtonText:"🎀 300円で広告なし！美女めくり放題🎀"
    }).then(r=>{
      if (r.isConfirmed){ watchAdGlobal(); selectedPart = part; currentPart = parts.findIndex(p=>p.value===part)+1; currentPage=1; renderPartButtons(); loadWords(); }
      else if (r.isDenied){ showPremiumPopup(); }
    });
  }else{
    selectedPart = part; currentPart = parts.findIndex(p=>p.value===part)+1; currentPage=1;
    renderPartButtons(); loadWords();
  }
}
function changePart(partName){
  currentPart = partName;
  musouMode = (partName === '無双Part');
  const uid = getUserIdFromQuery();
  if (musouMode) goToPart(uid, "無双Part");
  else { currentPage = 1; loadWords(); }
}
function goToPart(userId, partName){
  location.href = `musou.html?userId=${userId}&part=${encodeURIComponent(partName)}`;
}

/* =========================
   単語取得・一覧・ページャ
   ========================= */
async function fetchWordsFromServer(userId, part){
  try{
    const res = await fetch(api(`/api/words?userId=${userId}&part=${part}`));
    if(!res.ok) throw new Error();
    const data = await res.json();
    return data.map(w=>{
      const s = w.status;
      const learned = (s===true || s===1 || s==='1' || s==='true' || s==='LEARNED');
      return {...w, status: !!learned};
    });
  }catch(e){
    alert("単語の取得に失敗しました");
    return [];
  }
}

async function loadWords(){
  const uid = getUserIdFromQuery();
  words = await fetchWordsFromServer(uid, selectedPart);
  currentPage = 1;
  renderWords();
  updateStatusCount();

  byId("loginDays").textContent = `学習日数: ${user.loginPoints || 0}日目`;
  const correct = localStorage.getItem("test_correct") || 0;
  const total   = localStorage.getItem("test_total") || 0;
  byId("testStats").textContent = `正答数: ${correct} / ${total}問中`;
  await refreshUserStats();
}

function renderWords(){
  const cont = byId("wordContainer");
  cont.innerHTML = "";

  const total = words.length;
  const pageCount = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > pageCount) currentPage = pageCount;

  const start = (currentPage-1) * pageSize;
  const pageWords = words.slice(start, start + pageSize);

  pageWords.forEach((w, i)=>{
    const idx = start + i;
    const div = document.createElement('div');
    div.className = 'word-card';
    const checkboxId = `status-${w.id}`;
    const imageId    = `img-${idx}`;
    const baseImg = '/images/beauty.png';
    const specificImg = `/images/${toSlugForImage(w.word)}_girl.png`;
    div.innerHTML = `
      <strong>${w.word}</strong>（${w.meaning}）<br>
      ステータス:
        <input type="checkbox" id="${checkboxId}" ${w.status?'checked':''}
               onchange="toggleStatus(this.checked, ${w.id}, selectedPart)">
        <span id="status-label-${w.id}">${w.status?'学習済み':'未学習'}</span>
      <div>画像パス: <span id="imgpath-${idx}">${baseImg}</span></div>
      <img id="${imageId}" src="${baseImg}" width="150" onerror="this.src='/images/beauty.png'"><br>
      <button onclick="handleToggleImage('${imageId}','btn-${idx}','${baseImg}','${specificImg}','${idx}')">美女で英単語を表現する</button>
    `;
    cont.appendChild(div);
  });

  renderPagination(total);
}

function renderPagination(totalItems){
  const p = byId("pagination");
  p.innerHTML = "";
  const pageCount = Math.max(1, Math.ceil(totalItems / pageSize));

  const mkBtn = (label, disabled, onClick) => {
    const b = document.createElement('button');
    b.textContent = label; b.disabled = disabled; b.onclick = onClick; return b;
  };
  p.appendChild(mkBtn("≪", currentPage===1, ()=>{ currentPage=1; renderWords(); }));
  p.appendChild(mkBtn("＜", currentPage===1, ()=>{ currentPage=Math.max(1,currentPage-1); renderWords(); }));

  for(let i=Math.max(1,currentPage-2); i<=Math.min(pageCount,currentPage+2); i++){
    const b = mkBtn(String(i), false, ()=>{ currentPage=i; renderWords(); });
    if (i===currentPage) b.style.fontWeight='bold';
    p.appendChild(b);
  }

  p.appendChild(mkBtn("＞", currentPage===pageCount, ()=>{ currentPage=Math.min(pageCount,currentPage+1); renderWords(); }));
  p.appendChild(mkBtn("≫", currentPage===pageCount, ()=>{ currentPage=pageCount; renderWords(); }));

  const info = document.createElement('span');
  info.className = 'page-info';
  info.textContent = `ページ ${currentPage} / ${pageCount}（全${totalItems}件）`;
  p.appendChild(info);
}

/* 画像トグル（広告導線） */
let pendingToggle = null;
function getBeautyClickCount(){ const n = parseInt(localStorage.getItem('beauty_clicks')||'0',10); return isNaN(n)?0:n; }
function incBeautyClickCount(){ const n = getBeautyClickCount()+1; localStorage.setItem('beauty_clicks', String(n)); return n; }
function resetBeautyClickCount(){ localStorage.setItem('beauty_clicks','0'); }
function handleToggleImage(imgId, btnId, img1, img2, index){
  const proceed = ()=>{
    const img = byId(imgId);
    const lab = byId(`imgpath-${index}`);
    const cur = img.getAttribute('src');
    if (cur===img1){ img.src=img2; lab.textContent=img2; } else { img.src=img1; lab.textContent=img1; }
  };
  const total = incBeautyClickCount();
  if (!user.premium && total % 6 === 0){ showAdModalForToggle(proceed); return; }
  proceed();
}
function showAdModalForToggle(callback){ pendingToggle = callback; byId('adModal').style.display='flex'; }
function handleAdAccept(){ watchAdGlobal(); closeAdModal(); if(typeof pendingToggle==='function'){ pendingToggle(); pendingToggle=null; } resetBeautyClickCount(); }
function closeAdModal(){ byId('adModal').style.display='none'; pendingToggle=null; }

/* =========================
   学習状態更新
   ========================= */
function toggleStatus(isChecked, wordId, part){
  const uid = getUserIdFromQuery();
  fetch(api('/api/learning/update'), {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ userId: uid, wordId, status: isChecked, part })
  }).then(res=>{
    if(!res.ok){ alert('更新に失敗しました'); return; }
    const w = words.find(x=>x.id===wordId);
    if (w) w.status = isChecked;
    const span = byId(`status-label-${wordId}`);
    if (span) span.innerText = isChecked ? '学習済み' : '未学習';
    updateStatusCount();
  }).catch(()=> alert('通信エラーが発生しました'));
}

async function updateStatusCount(){
  const uid = getUserIdFromQuery();
  try{
    const res = await fetch(api(`/api/learning/count?userId=${uid}&part=${selectedPart}`));
    if(!res.ok) throw new Error();
    const learnedCount = await res.json();
    const totalCount = words.length;
    byId("learningStatus").textContent = `学習済み: ${learnedCount} / 未学習: ${Math.max(0,totalCount-learnedCount)}`;
  }catch{
    byId("learningStatus").textContent = "学習状況の取得に失敗しました";
  }
}

/* =========================
   週次グラフ
   ========================= */
async function loadWeeklyAnswers(){
  const uid = getUserIdFromQuery() || localStorage.getItem('userId') || 1;
  try{
    const res = await fetch(api(`/api/test/weekly?userId=${uid}`));
    if(!res.ok) return;
    const data = await res.json();
    const max  = Math.max(1, ...data.map(d=>d.answers));
    const bars = byId('weeklyBars'); const labels = byId('weeklyLabels');
    bars.innerHTML = ''; labels.innerHTML = '';
    data.forEach(d=>{
      const h = Math.round((d.answers / max) * 120);
      const wrap = document.createElement('div');
      Object.assign(wrap.style, {flex:'1',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-end'});
      const num = document.createElement('div'); num.textContent=d.correct; Object.assign(num.style,{fontSize:'.8rem',color:'#e91e63',marginBottom:'4px'}); wrap.appendChild(num);
      const bar = document.createElement('div'); bar.title=`正解:${d.correct} / 解答:${d.answers}`; Object.assign(bar.style,{width:'24px',height:`${h}px`,borderRadius:'8px',background:'linear-gradient(180deg,#ff7bbd,#ffb3d9)',boxShadow:'0 2px 6px rgba(0,0,0,.08)'}); wrap.appendChild(bar);
      bars.appendChild(wrap);
      const dd = new Date(d.ymd);
      const lbl = document.createElement('div');
      lbl.style.flex='1'; lbl.style.textAlign='center';
      const mmdd = `${(dd.getMonth()+1).toString().padStart(2,'0')}/${dd.getDate().toString().padStart(2,'0')}`;
      const youbi = ['日','月','火','水','木','金','土'][dd.getDay()];
      lbl.innerHTML = `<div>${mmdd}</div><div style="opacity:.7">${youbi}</div>`;
      labels.appendChild(lbl);
    });
  }catch(e){ console.warn('weekly chart load failed', e); }
}

/* =========================
   ログインボーナス
   ========================= */
function showLoginBonus(points){
  const grid = byId('stampGrid'); grid.innerHTML='';
  const displayPoints = Math.max(points,1);
  for(let i=1;i<=30;i++){
    const cell = document.createElement('div');
    Object.assign(cell.style,{width:'60px',height:'60px',border:'1px solid #999',display:'flex',justifyContent:'center',alignItems:'center',background:'#eee'});
    if(i<=displayPoints){
      const img = document.createElement('img');
      Object.assign(img,{src:'/images/stamp_beauty.png',alt:'スタンプ'});
      Object.assign(img.style,{width:'100%',height:'100%',objectFit:'cover',borderRadius:'50%',border:'2px solid pink'});
      if(i===displayPoints) img.style.animation = 'pop .6s ease';
      cell.appendChild(img);
    }else{
      const label = document.createElement('div'); label.textContent=`${i}日目`; label.style.fontSize='12px'; cell.appendChild(label);
    }
    grid.appendChild(cell);
  }
  byId('loginBonusPopup').style.display='block';
}
function closeLoginBonus(){ byId('loginBonusPopup').style.display='none'; }

/* =========================
   レベル演出・見た目
   ========================= */
function updateGirlVisual(level){
  const video = byId("girlVideo");
  const bg = byId("bgEffect");
  video.src = "/videos/girl_idle_loop.mp4";
  if (level >= 20) bg.className = "heart-bg";
  else if (level >= 10) bg.className = "star-bg";
  else bg.className = "normal-bg";
}
function getTitleByLevel(level){
  if (level >= 20) return "ホットパンツの覇者";
  if (level >= 15) return "セクシー学習王";
  if (level >= 10) return "フリフリ美女マスター";
  if (level >= 5)  return "Newbie";
  return "ビギナー";
}
function showLevelUpPopup(newLevel){
  const title = getTitleByLevel(newLevel);
  Swal.fire({
    title:'🎉 LEVEL UP！🎉',
    html:`<p style="font-size: 20px;">新しいレベル: Lv.${newLevel}</p>
          <div style="margin-top: 10px;">称号：<strong>${title}</strong></div>
          <div class="slide-message" style="font-size: 18px; margin-top: 10px;">この調子で頑張ろう！</div>
          <br><button id="shareButton" style="background:#1da1f2;color:white;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;">SNSでシェアする</button>`,
    showConfirmButton:false, timer:6000,
    didOpen:()=>{ byId("shareButton").onclick = ()=>{ const shareText=`私は今レベル${newLevel}で「${title}」に到達しました！ #美女単`; const shareUrl=encodeURIComponent(location.origin); window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${shareUrl}`,'_blank'); }; }
  });
}

/* =========================
   テスト起動
   ========================= */
function startTest(){
  const userId = getUserIdFromQuery();
  if (localStorage.getItem("test_started")) alert("広告を見せる処理（仮）");
  if (user.premium){
    Swal.fire({
      title:"テストモードを選んでね",
      html:`<button id="readingBtn"  class="swal2-confirm swal2-styled" style="margin:5px;">📘 リーディング</button>
            <button id="listeningBtn" class="swal2-confirm swal2-styled" style="background:#3949ab;margin:5px;">🎧 リスニング</button>`,
      showConfirmButton:false,
      didOpen:()=>{
        byId("readingBtn").onclick  = ()=>{ localStorage.setItem("test_started","1"); location.href=`test.html?userId=${userId}&mode=reading`; };
        byId("listeningBtn").onclick = ()=>{ localStorage.setItem("test_started","1"); location.href=`test.html?userId=${userId}&mode=listening`; };
      }
    });
  }else{
    Swal.fire({
      title:"リスニングモードはプレミアム専用🎧",
      html:`<p>今は <strong>リーディングモード</strong>のみご利用いただけます。</p><p>🎀 プレミアム登録で <strong>音声リスニングテスト</strong>も可能に！</p>`,
      showCancelButton:true, confirmButtonText:"リーディングで始める", cancelButtonText:"プレミアムを見る",
    }).then(r=>{
      if (r.isConfirmed){ localStorage.setItem("test_started","1"); location.href=`test.html?userId=${userId}&mode=reading`; }
      else if (r.dismiss === Swal.DismissReason.cancel){ showPremiumPopup(); }
    });
  }
}
function startVocabularyTest(){
  const userId = getUserIdFromQuery();
  if (localStorage.getItem("test_started")) alert("広告を見せる処理（仮）");
  if (user.premium){
    Swal.fire({
      title:"テストモードを選んでね",
      html:`<button id="readingBtn"  class="swal2-confirm swal2-styled" style="margin:5px;">📘 リーディング</button>
            <button id="listeningBtn" class="swal2-confirm swal2-styled" style="background:#3949ab;margin:5px;">🎧 リスニング</button>`,
      showConfirmButton:false,
      didOpen:()=>{
        byId("readingBtn").onclick  = ()=>{ localStorage.setItem("test_started","1"); location.href=`vocabularyTest.html?userId=${userId}&mode=reading`; };
        byId("listeningBtn").onclick = ()=>{ localStorage.setItem("test_started","1"); location.href=`vocabularyTest.html?userId=${userId}&mode=listening`; };
      }
    });
  }else{
    Swal.fire({
      title:"リスニングモードはプレミアム専用🎧",
      html:`<p>今は <strong>リーディングモード</strong>のみご利用いただけます。</p><p>🎀 プレミアム登録で <strong>音声リスニングテスト</strong>も可能に！</p>`,
      showCancelButton:true, confirmButtonText:"リーディングで始める", cancelButtonText:"プレミアムを見る",
    }).then(r=>{
      if (r.isConfirmed){ localStorage.setItem("test_started","1"); location.href=`vocabularyTest.html?userId=${userId}&mode=reading`; }
      else if (r.dismiss === Swal.DismissReason.cancel){ showPremiumPopup(); }
    });
  }
}

/* テスト結果 URL 反映 + commit */
async function applyTestParamsAndCommit(){
  const sp = new URLSearchParams(location.search);
  const from  = sp.get('from');
  const score = parseInt(sp.get('score')||'0',10);
  const total = parseInt(sp.get('total')||'0',10);
  const userId = getUserIdFromQuery() || 1;
  const mode = 'sentence';
  if (from!=='test' || !total) return;
  const stat = byId("testStats");
  if (stat) stat.textContent = `正答数: ${score} / ${total}問中`;

  const localKey = `localTotalCorrect:${userId}`;
  const prevLocal = parseInt(localStorage.getItem(localKey)||'0',10);
  const nextLocal = prevLocal + score;
  localStorage.setItem(localKey, String(nextLocal));
  for (let lv=Math.floor(prevLocal/10)+1; lv<=Math.floor(nextLocal/10); lv++) showLevelUpPopup(lv);

  const committedKey = `committed:${userId}:${mode}:${score}/${total}`;
  if (sessionStorage.getItem(committedKey)==='1') return;
  try{
    const r = await fetch(api('/api/test/commit'), {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId, mode, correct: score, total })
    });
    if(r.ok) sessionStorage.setItem(committedKey,'1');
  }catch{}
}

/* =========================
   累計・レベル同期
   ========================= */
async function refreshUserStats(){
  const uid = getUserIdFromQuery() || localStorage.getItem('userId') || 1;
  try{
    const res = await fetch(api(`/user/${uid}`));
    if (res.ok){
      const u = await res.json();
      const days = (typeof u.loginPoints === 'number') ? u.loginPoints : 0;
      byId("loginDays").textContent = `学習日数: ${days}日目`;
      const totalCorrect = Number(u.testCorrectTotal ?? 0);
      byId("testStats").textContent = `正答数（累計）: ${totalCorrect}`;
      const newLevel = Math.max(1, Math.floor(totalCorrect/10)+1);
      const curLevel = Number(u.level ?? 1);
      if (curLevel !== newLevel){
        try{
          const r = await fetch(api(`/user/updateLevel`), {
            method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: uid, level: newLevel })
          });
          if (r.ok){ const jj = await r.json().catch(()=>({})); u.level = Number(jj.level ?? newLevel); }
          else { u.level = newLevel; }
        }catch{ u.level = newLevel; }
      }
      const lv = Number(u.level ?? 1);
      byId("userLevel").textContent = `レベル: Lv.${lv}`;
      updateGirlVisual(lv);

      const prev = parseInt(localStorage.getItem('previousCorrect')||'0',10);
      const prevLv = Math.floor(prev/10), newLv = Math.floor(totalCorrect/10);
      if (newLv > prevLv){ for(let x=prevLv+1; x<=newLv; x++) showLevelUpPopup(x); }
      localStorage.setItem('previousCorrect', String(totalCorrect));
      return;
    }
  }catch{}
  // フォールバック（直近7日 学習日数）
  try{
    const r2 = await fetch(api(`/api/test/weekly?userId=${uid}`));
    if (r2.ok){
      const w = await r2.json();
      const days = w.filter(d=>d.answers>0).length;
      byId("loginDays").textContent = `学習日数(直近7日): ${days}日`;
    }
  }catch{}
}

/* =========================
   広告処理
   ========================= */
function watchAdGlobal(){
  const expiry = Date.now() + 5*60*1000;
  localStorage.setItem("ad_expiry", String(expiry));
  alert("広告視聴完了！");
  renderWords();
}
function isAdEnabled(){
  const s = localStorage.getItem("ad_expiry");
  return s && Date.now() < parseInt(s,10);
}

/* =========================
   プレミアム案内
   ========================= */
function showPremiumPopup(){
  Swal.fire({
    title:'🎀 美女単プレミアムプラン 🎀',
    html:`<div style="text-align:left; font-size:.95rem;">
      <p>全モード解放＆広告なしの贅沢体験</p>
      <ul style="line-height:1.6;">
        <li>✔ リスニングモード解放</li>
        <li>✔ テスト回数無制限＆成績履歴も保存</li>
      </ul>
      <p style="font-weight:bold; font-size:1.1rem;">💰 月額500円（税込）</p>
      <p style="color:red;">✨ 今だけ初月300円キャンペーン中 ✨</p>
      <small>SNSでシェアすると1週間無料体験🎁</small>
    </div>`,
    showCancelButton:true,
    confirmButtonText:"プレミアムに登録する",
    cancelButtonText:"あとで見る",
    customClass:{ popup:'premium-popup', confirmButton:'btn-premium' }
  }).then(r=>{ if(r.isConfirmed) location.href="/premium.html"; });
}

/* =========================
   動画モーダル
   ========================= */
function playVideo(url){
  const m = byId("videoModal"), v = byId("videoPlayer");
  v.src = url; m.style.display='flex';
  m.onclick = ()=>{ m.style.display='none'; v.pause(); v.currentTime=0; };
}

/* =========================
   スワイプ学習
   ========================= */
function swipeTodayKey(userId){
  const d = new Date();
  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  return `swipeExcluded:${userId}:${ymd}`;
}
function todayKey(type){
  const d = new Date();
  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  return `swipe:${type}:${getUserId()}:${ymd}`;
}
function getTodaySet(type){ const raw = localStorage.getItem(todayKey(type)); return new Set(raw ? JSON.parse(raw) : []); }
function addTodaySet(type, wordId){ const s = getTodaySet(type); s.add(wordId); localStorage.setItem(todayKey(type), JSON.stringify([...s])); }
function getSwipeExcludedSet(userId){ const raw = localStorage.getItem(swipeTodayKey(userId)); return new Set(raw ? JSON.parse(raw) : []); }
function addToSwipeExcluded(userId, wordId){ const key = swipeTodayKey(userId); const s = getSwipeExcludedSet(userId); s.add(wordId); localStorage.setItem(key, JSON.stringify([...s])); }

function setSwipeModeVisible(show){
  toggleHidden('swipeModeBox', !show);
  toggleHidden('wordContainer', show);
  toggleHidden('pagination', show);
  toggleHidden('test-section', show);
  toggleHidden('weeklyAnswersBox', show);
}
function toggleHidden(id, hidden){ byId(id).classList.toggle('hidden', hidden); }

function startSwipeMode(partValue = selectedPart){
  selectedPart = partValue;
  const locked = ["part4", "part5", "part6", "partHealing", "musou"];
  if(!user.premium && locked.includes(selectedPart) && !isAdEnabled()){ showPremiumPopup(); return; }
  Swal.fire({
    title:"美女スワイプ学習🎀",
    html:"学習開始前と終了時に広告が表示されます（計2回）<br>美女と一緒に楽しく学習しましょう！",
    icon:"info", confirmButtonText:"広告を見る", confirmButtonColor:"#e91e63", allowOutsideClick:false
  }).then(()=>{ watchAdGlobal(); showSwipeModeSelection(); });
}
function showSwipeModeSelection(){
  Swal.fire({
    title:"モードを選んでね",
    html:`<div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button id="btnUnlearned" class="swal2-confirm swal2-styled">未学習を覚える</button>
      <button id="btnReview"   class="swal2-confirm swal2-styled" style="background:#3949ab">復習チェック</button>
    </div>`,
    showConfirmButton:false,
    didOpen:()=>{
      byId("btnUnlearned").onclick = ()=>{ currentSwipeMode="unlearned"; Swal.close(); initSwipeMode("unlearned"); };
      byId("btnReview").onclick   = ()=>{ currentSwipeMode="review";    Swal.close(); initSwipeMode("review"); };
    }
  });
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

async function buildSwipeDeck(mode="unlearned"){
  const uid = getUserIdFromQuery() || getUserId();
  const excluded = getSwipeExcludedSet(uid);
  const allUnlearned = words.filter(w=>!w.status);
  const allLearned   = words.filter(w=> w.status);
  let unlearned = allUnlearned.filter(w=>!excluded.has(w.id));
  let learned   = allLearned.filter(w=>!excluded.has(w.id));
  if (mode==="review" && learned.length===0 && allLearned.length>0) learned = allLearned.slice();
  shuffle(unlearned); shuffle(learned);
  if (mode==="unlearned") return shuffle(unlearned.slice(0,10));
  if (mode==="review")    return shuffle(learned.slice(0,10));
  return shuffle([ ...unlearned.slice(0,25), ...learned.slice(0,5) ]);
}

async function initSwipeMode(mode="unlearned"){
  currentSwipeMode = mode;
  setSwipeModeVisible(true);
  const uid = getUserIdFromQuery() || 1;
  if (!Array.isArray(words) || words.length===0) words = await fetchWordsFromServer(uid, selectedPart);
  swipeWords = await buildSwipeDeck(mode);
  if (swipeWords.length===0){
    Swal.fire({icon:'info', title:(mode==='review'?'今日は復習用の単語が見つかりませんでした':'今日は出題する未学習がありません'), text:'パート変更や明日またチャレンジしてね！'});
    setSwipeModeVisible(false); return;
  }
  swipeIndex = 0; swipeLearned = 0; swipeUnlearned = 0;
  await renderSwipeDeck();
  updateSwipeHUD();
  byId('swipeExitBtn').onclick = exitSwipeMode;
}
function exitSwipeMode(){ setSwipeModeVisible(false); renderWords(); updateStatusCount(); }

async function renderSwipeDeck(){
  const deck = byId('swipeDeck'); deck.innerHTML='';
  if (!Array.isArray(swipeWords) || swipeWords.length===0) swipeWords = await buildSwipeDeck(currentSwipeMode);
  const show = swipeWords.slice(swipeIndex, Math.min(swipeIndex+3, swipeWords.length));
  show.forEach((w, idx)=>{
    const card = document.createElement('div');
    card.className='swipe-card'; card.style.zIndex=String(100-idx); card.dataset.index=String(swipeIndex+idx);
    const src = imageUrlForWord(w);
    card.innerHTML = `
      <div class="swipe-badge badge-left">覚えてない</div>
      <div class="swipe-badge badge-right">覚えた！</div>
      <div class="swipe-word">${w.word}</div>
      <div class="swipe-mean">(${w.meaning})</div>
      <img class="swipe-img" src="${src}" alt="" draggable="false">
    `;
    card.querySelector('.swipe-img').onerror = (e)=>{ e.target.src='/images/beauty.png'; };
    attachSwipeHandlers(card);
    deck.appendChild(card);
  });
}
function attachSwipeHandlers(card){
  card.addEventListener('pointerdown', e=>{
    e.preventDefault(); card.setPointerCapture(e.pointerId);
    swipeDrag = {startX:e.clientX, startY:e.clientY, el:card};
    card.style.transition = 'none';
  });
  card.addEventListener('pointermove', e=>{
    if(!swipeDrag || swipeDrag.el!==card) return;
    const dx=e.clientX-swipeDrag.startX, dy=e.clientY-swipeDrag.startY, rot=dx*0.05;
    card.style.transform = `translate(${dx}px,${dy}px) rotate(${rot}deg)`;
    const L=card.querySelector('.badge-left'), R=card.querySelector('.badge-right');
    if (dx<-20){ L.style.opacity=Math.min(1,(-dx)/80); R.style.opacity=0; }
    else if(dx>20){ R.style.opacity=Math.min(1,(dx)/80); L.style.opacity=0; }
    else { L.style.opacity=R.style.opacity=0; }
  });
  card.addEventListener('pointerup', e=>endSwipe(card,e));
  card.addEventListener('pointercancel', ()=>{
    card.style.transition='.2s ease'; card.style.transform='translate(0,0) rotate(0)';
    card.querySelector('.badge-left').style.opacity = 0;
    card.querySelector('.badge-right').style.opacity = 0;
    swipeDrag=null;
  });
  card.addEventListener('dragstart', e=>e.preventDefault());
}
function endSwipe(card,e){
  if(!swipeDrag) return;
  const dx = e.clientX - swipeDrag.startX; swipeDrag=null;
  if (dx <= -SWIPE_THRESHOLD) decideSwipe(card,'left');
  else if (dx >= SWIPE_THRESHOLD) decideSwipe(card,'right');
  else {
    card.style.transition='.2s ease'; card.style.transform='translate(0,0) rotate(0)';
    card.querySelector('.badge-left').style.opacity=0;
    card.querySelector('.badge-right').style.opacity=0;
  }
}
async function decideSwipe(card, dir){
  const i = swipeIndex, w = swipeWords[i], isRight=(dir==='right');
  card.style.transition='.2s ease'; const off = isRight?600:-600;
  card.style.transform = `translate(${off}px,-40px) rotate(${off>0?15:-15}deg)`; setTimeout(()=>card.remove(),200);

  if (currentSwipeMode==="unlearned"){
    if (isRight){ addTodaySet('learned', w.id); addToSwipeExcluded(getUserId(), w.id); swipeLearned++; }
    else { addTodaySet('unlearned', w.id); swipeUnlearned++; }
  }else{
    if (isRight){ swipeLearned++; addTodaySet('review_ok', w.id); }
    else { swipeUnlearned++; addTodaySet('review_ng', w.id); }
    addToSwipeExcluded(getUserId(), w.id);
  }

  swipeIndex++; updateSwipeHUD();
  if (swipeIndex === swipeWords.length) watchAdGlobal();
  if (swipeIndex < swipeWords.length) await renderSwipeDeck();
  else exitSwipeMode();
}
function updateSwipeHUD(){
  const total = swipeWords.length;
  byId('swipeCounter').textContent = `${swipeIndex}/${total}`;
  if (currentSwipeMode==="unlearned"){
    const a=getTodaySet('learned'), b=getTodaySet('unlearned');
    byId('swipeStats').textContent = `覚えた: ${a.size} / 覚えてない: ${b.size}`;
  }else{
    byId('swipeStats').textContent = `OK: ${swipeLearned} / 忘れていた: ${swipeUnlearned}`;
  }
}

/* =========================
   DOM helpers
   ========================= */
function byId(id){ return document.getElementById(id); }
</script>


<!-- 広告・プレミアムモーダル -->
<div id="adModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div class="modal-content" style="background:white; padding:30px; border-radius:10px; max-width:90%; text-align:center;">
    <h2 style="color:#e91e63;">このパートは広告視聴が必要です</h2>
    <p>広告を見ると5分だけ美女で英単語を表現するボタンが開放されます。<br>有料プランなら無制限で開放されます。</p>
    <div class="modal-buttons" style="margin-top:20px;">
      <button id="watchAdBtn" class="btn btn-primary" onclick="handleAdAccept()">広告を見る</button>
      <button id="closeModalBtn" class="btn btn-secondary" onclick="closeAdModal()">やめる</button>
      <button id="upgradeBtn" class="btn btn-premium" onclick="location.href='/premium.html'">🎀 プレミアムで無制限開放 (月額300円)🎀</button>
    </div>
  </div>
</div>
</body>
</html>
