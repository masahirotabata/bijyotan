<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç¾å¥³å˜èªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
      background: rgb(249, 249, 249);
    }

    h1, h3 {
      text-align: center;
      color: rgb(233, 30, 99);
    }

    #username, #plan {
      display: block;
      text-align: center;
      margin: 10px 0;
      font-size: 1.1em;
    }
    
/* ç”»é¢ã‚’ç‹­ã‚ã‚‹ï¼šä¸»è¦ãƒ–ãƒ­ãƒƒã‚¯ã¯æœ€å¤§å¹…ã‚’çµ±ä¸€ã—ã¦ä¸­å¤®ã« */
#user-info, #levelGirlContainer, #partButtons, #statsBox,
#test-section, #weeklyAnswersBox, #wordContainer, #pagination,
#partPaginationTop, #partPagination {
  max-width: 420px;
  margin-left: auto;
  margin-right: auto;
}

/* å˜èªã‚«ãƒ¼ãƒ‰ï¼šãƒ‡ãƒ•ã‚©ã‚‚å°‘ã—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
.word-card{
  padding: 10px 12px;
  margin: 10px auto;
}

/* ç”»åƒã‚’å°ã•ã‚å›ºå®šæ¯”ç‡ã« */
.word-card img{
  width: 88px;
  height: 132px;          /* 3:2ï½3:5ç¨‹åº¦ã«åã‚ã‚‹ */
  object-fit: cover;
  border-radius: 8px;
}

/* ===== ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– ===== */
@media (max-width: 480px){

  /* ä»¥å‰ã®ã€Œå…¨ãƒœã‚¿ãƒ³å¹…90%ã€ã‚’ã‚„ã‚ã‚‹ï¼šç¸¦ã®ä¼¸ã³é˜²æ­¢ */
  button{ font-size: 0.95rem; padding: 10px; }

  /* å¿…è¦ãªå ´æ‰€ã ã‘å¹…åºƒãƒœã‚¿ãƒ³ã«ã™ã‚‹ */
  #wordContainer .word-card button,
  #test-section button,
  #swipeStartBtn,
  #swipeModeBox .swipe-hud button {
    width: 100%;
    max-width: 320px;
  }

  #partButtons button{ flex: 0 0 auto; }

  /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚‚æ¨ªä¸¦ã³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§çœã‚¹ãƒšãƒ¼ã‚¹ */
/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚‚æ¨ªä¸¦ã³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§çœã‚¹ãƒšãƒ¼ã‚¹ */
.pagination{
  display: flex;
  gap: 6px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  flex-wrap: nowrap;
  justify-content: center; /* ä¸­å¤®æƒãˆã«å¤‰æ›´ */
  padding: 6px 2px;
}
  .pagination button{
    flex: 0 0 auto;
    min-width: 36px;
    height: 32px;
  }
  
  /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®è¦ªè¦ç´ ã«ä¸­å¤®å¯„ã›ã®å¹…èª¿æ•´ */
#partPaginationTop, #partPagination, .pagination {
  display: flex;
  justify-content: center; /* ä¸­å¤®å¯„ã› */
  width: 100%; /* å¹…ã‚’100%ã«è¨­å®š */
  max-width: 420px; /* æœ€å¤§å¹…è¨­å®š */
  margin: 0 auto; /* ä¸­å¤®ã«é…ç½® */
}

  /* å˜èªã‚«ãƒ¼ãƒ‰ï¼š2ã‚«ãƒ©ãƒ åŒ–ã§ç¸¦é•·ã‚’è§£æ¶ˆ */
  .word-card{
    display: grid;
    grid-template-columns: 88px 1fr;
    grid-template-areas:
      "img text"
      "img action";
    align-items: center;
    gap: 8px 10px;
    font-size: 0.95rem;
  }
  .wc-img{ grid-area: img; }
  .wc-body{ grid-area: text; }
  .wc-actions{ grid-area: action; }

  .word-card strong{ display:block; margin-bottom: 4px; font-size: 1rem; }
  .word-card .meta{ color:#666; font-size: .85rem; margin-bottom: 4px; }

  /* ãƒ’ãƒ¼ãƒ­ãƒ¼ã®å¥³ã®å­å‹•ç”»ã®é«˜ã•ã‚’æŠ‘ãˆã‚‹ */
  #levelGirlContainer video{ width: 160px; }
  #statsBox{ padding: 12px; }
  #weeklyAnswersBox{ padding: 0 4px; }
}


    .locked {
      background: #ffdddd;
      padding: 10px;
      text-align: center;
    }
    
    .musou-card {
	  background: #fff5f5;
	  border: 1px solid #f48fb1;
	  border-radius: 10px;
	  padding: 10px;
	  margin: 10px 0;
	}
    

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      background-color:#e91e63;
      color: white;
      font-size: 1rem;
      margin: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #f50057;
    }
    
#user-info {
  text-align: left; /* â† ä¸­å¤®ã‹ã‚‰å·¦å¯„ã›ã«å¤‰æ›´ */
  margin: 10px 0 20px;
  font-size: 1.1rem;
  padding-left: 10px;
}

#bgEffect {
  position: absolute;
  width: 180px;
  height: 180px;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  z-index: -1;
}

.star-bg {
  background: radial-gradient(circle, #fff 20%, transparent 70%);
  animation: sparkle 1.5s infinite alternate;
}

.heart-bg{ background: radial-gradient(circle,#ffd1e6 30%, transparent 70%); }

@keyframes sparkle {
  0% { opacity: 0.6; transform: scale(1); }
  100% { opacity: 1; transform: scale(1.05); }
}


#planText {
  text-align: left; /* â† ä¸­å¤®ã‹ã‚‰å·¦å¯„ã›ã«å¤‰æ›´ */
  color: #333;
  font-weight: bold;
}

    #partButtons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    #statsBox {
  background: #fff3f8;
  border: 1px solid #ff99c9;
  border-radius: 12px;
  padding: 15px;
  margin: 15px auto;
  max-width: 500px;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.05);
  font-weight: bold;
  font-size: 1rem;
}

#learningStatus {
  text-align: center;
  margin-bottom: 10px;
  color: #333;
}

#subStats {
  display: flex;
  justify-content: space-between;
  font-size: 0.95rem;
  padding: 0 10px;
  color: #555;
}

#subStats div {
  flex: 1;
  text-align: center;
}
    
    
    

    #loginBonusPopup {
      display: none;
      position: fixed;
      top: 10%;
      left: 5%;
      width: 90%;
      height: 75%;
      background: white;
      border: 2px solid #ccc;
      z-index: 9999;
      padding: 20px;
      overflow: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .swal2-popup.premium-popup {
  font-family: 'sans-serif';
  border-radius: 15px;
  padding: 20px;
  max-width: 400px;
}

    #stampGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      gap: 10px;
    }

    #test-section {
      text-align: center;
      margin: 20px 0;
    }

    #videoModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    video {
      width: 90%;
      max-height: 80vh;
    }

  /* å¿…è¦ãªå ´æ‰€ã ã‘å€‹åˆ¥ã«å¹…ã‚’åºƒã’ãŸã„å ´åˆã¯æ˜ç¤ºçš„ã«æŒ‡å®š */
  #test-section button,
  #swipeStartBtn,
  #swipeModeBox .swipe-hud button {
    width: 90%;
    max-width: 320px;
  }

  /* Partãƒœã‚¿ãƒ³ã‚’æ¨ªä¸€åˆ—ã§ã‚¹ãƒ¯ã‚¤ãƒ—å¯èƒ½ã« */
  #partButtons {
    display: flex;
    gap: 8px;
    overflow-x: auto;           /* â† æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    -webkit-overflow-scrolling: touch;
    flex-wrap: nowrap;          /* æŠ˜ã‚Šè¿”ã•ãªã„ */
    justify-content: flex-start;
    padding-top: max(6px, env(safe-area-inset-top));
  }
  #partButtons button {
    flex: 0 0 auto;             /* åç¸®ã•ã›ãªã„ */
  }

  /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¨ªä¸¦ã³ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ã« */
  .pagination {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    flex-wrap: nowrap;          /* é‡è¦ï¼šç¸¦ã«æŠ˜ã‚Šè¿”ã•ãªã„ */
    justify-content: flex-start;
    padding: 6px 2px;
  }
  .pagination button {
    flex: 0 0 auto;
    width: auto;                /* 90%ã®å½±éŸ¿ã‚’æ‰“ã¡æ¶ˆã™ */
    min-width: 44px;            /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
    height: 36px;
  }

      .word-card {
        font-size: 0.9rem;
      }
    
    .btn-premium {
    background-color: #e91e63;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    font-size: 1em;
    margin-top: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .btn-premium:hover {
    background-color: #d81b60;
  }
  
  /* æ—¢å­˜CSSã®æœ«å°¾ã«è¿½åŠ  */
.hidden{display:none;}

#swipeModeBox{
  max-width:700px;margin:16px auto;padding:10px;
}
#swipeDeck{
  position:relative;height:360px;user-select:none;touch-action:pan-y;
}
.swipe-card{
  position:absolute;inset:0;margin:auto;width:92%;max-width:580px;height:340px;
  background:#fff;border-radius:14px;border:1px solid #eee;
  box-shadow:0 10px 24px rgba(0,0,0,.08);
  padding:18px;display:flex;flex-direction:column;justify-content:center;align-items:center;
  transition:transform .2s ease, opacity .2s ease;
}
.swipe-word{font-size:28px;font-weight:700;margin-bottom:8px;}
.swipe-mean{color:#555;margin-bottom:12px;}
.swipe-img{
  width:220px;height:300px;object-fit:cover;border-radius:10px;background:#f2f2f2;
  -webkit-user-drag: none;      /* Safari/Chrome */
  user-drag: none;
  user-select: none;
  pointer-events: none;          /* â† ãƒ‰ãƒ©ãƒƒã‚°ã®èµ·ç‚¹ã‚’å¸¸ã«ã‚«ãƒ¼ãƒ‰ã«ã™ã‚‹ */
}

.swipe-badge{
  position:absolute;top:12px;font-weight:700;padding:6px 10px;border-radius:8px;opacity:0;
}
.badge-left{left:12px;background:#fde68a;color:#92400e;}     /* è¦šãˆã¦ãªã„ */
.badge-right{right:12px;background:#dcfce7;color:#166534;}    /* è¦šãˆãŸ */

.swipe-hud{display:flex;justify-content:space-between;align-items:center;margin:6px 6px 10px;}
.swipe-hints{display:flex;justify-content:space-between;color:#888;margin-top:6px;padding:0 4px;}
@media (prefers-reduced-motion: reduce){
  .swipe-card{ transition: none; }
  .star-bg{ animation: none; }
  .caption{ display: none !important; }
}

/* ===== Desktop layout improvements ===== */
@media (min-width: 768px){
  /* ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ­ãƒƒã‚¯ã®å¹…ã‚’åºƒã’ã‚‹ */
#user-info, #levelGirlContainer, #partButtons, #statsBox,
#test-section, #weeklyAnswersBox, #wordContainer, #pagination, #paginationTop,
#partPaginationTop, #partPagination{
   max-width: 900px;
   margin-left: auto;
   margin-right: auto;
 }

  /* å˜èªã‚«ãƒ¼ãƒ‰ã‚’3ã‚«ãƒ©ãƒ ã§æ¨ªä¸¦ã³ã«ï¼ˆç”»åƒ / ãƒ†ã‚­ã‚¹ãƒˆ / ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
  .word-card{
    display: grid;
    grid-template-columns: 140px 1fr auto;
    grid-template-areas: "img text action";
    align-items: center;
    gap: 12px 16px;
    padding: 14px 16px;
  }
  .wc-img{ grid-area: img; }
  .wc-body{ grid-area: text; }
  .wc-actions{ grid-area: action; justify-self: end; }

  .word-card img{ width: 140px; height: 210px; }

  /* ãƒœã‚¿ãƒ³ã®ç„¡é§„ãªæ¨ªå¹…ã‚’è§£é™¤ï¼ˆPCã§ã¯è‡ªå‹•å¹…ï¼‰ */
  #test-section button,
  #swipeStartBtn,
  #swipeModeBox .swipe-hud button {
    width: auto;
    max-width: none;
  }

  /* ãƒ‘ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚„ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯ä¸­å¤®å¯„ã›ãƒ»æŠ˜ã‚Šè¿”ã— */
  #partButtons{ justify-content: center; overflow: visible; flex-wrap: wrap; }
  .pagination{ justify-content: center; overflow: visible; }
}

/* ãƒ’ãƒ¼ãƒ­ãƒ¼èƒŒæ™¯ã®ãƒ”ãƒ³ã‚¯ä¸¸ã¯ãƒ¢ãƒã‚¤ãƒ«ã ã‘è¡¨ç¤ºã€PCã§ã¯éè¡¨ç¤º */
#levelGirlContainer{ position: relative; }
@media (min-width: 600px){ #bgEffect{ display:none; } }

/* pagination condensed */
.pagination .ellipsis{
  padding: 0 6px;
  color:#888;
  align-self:center;
}
.pagination button.active{
  background-color:#d81b60;
  font-weight:700;
}
.pagination button[disabled]{
  opacity:.5;
  cursor: default;
}

  
  </style>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="loginBonusPopup" style="display:none; position: fixed; top: 10%; left: 10%; width: 80%; height: 70%; background: white; border: 2px solid #ccc; z-index: 9999; padding: 20px; overflow: auto;">
  <h3>ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹</h3>
  <div id="stampGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;"></div>
  <button onclick="closeLoginBonus()">OK</button>
</div>

<div id="user-info">
  <div id="username"></div>
  <div id="planText"></div>
  <div id="userLevel"></div> <!-- â† è¿½åŠ  -->
</div>
<div id="levelGirlContainer" style="text-align:center; margin: 10px 0;">
  <div id="bgEffect" class="star-bg"></div>
  <video id="girlVideo" src="/videos/girl_idle_loop.mp4" autoplay muted loop playsinline width="180" style="border-radius:10px;"></video>

</div>

<!-- è¿½åŠ ï¼šPartç”¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šï¼‰ -->
<div class="pagination" id="partPaginationTop"></div>

<!-- ãƒ‘ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ -->
<div id="partButtons"></div>

<!-- è¿½åŠ ï¼šPartç”¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ï¼‰ -->
<div class="pagination" id="partPagination"></div>
<!-- ã“ã‚Œã‚’è¿½åŠ  -->
<div style="text-align:center; margin:6px 0 14px;">
  <button id="swipeStartBtn" onclick="startSwipeMode()">
    ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ã‚’å§‹ã‚ã‚‹
  </button>
</div>
<div id="swipeModeBox" class="hidden">
  <div class="swipe-hud">
    <button id="swipeExitBtn">ä¸€è¦§ã«æˆ»ã‚‹</button>
    <div id="swipeCounter">0 / 0</div>
    <div id="swipeStats">è¦šãˆãŸ: 0 / è¦šãˆãŸã„: 0</div>
  </div>

  <div id="swipeDeck">
    <!-- ã“ã“ã«ã‚«ãƒ¼ãƒ‰ã‚’é‡ã­ã¦æç”» -->
  </div>

  <div class="swipe-hints">
    <span>â† è¦šãˆã¦ãªã„</span>
    <span>è¦šãˆãŸ â†’</span>
  </div>
</div>


<div id="statsBox">
  <div id="learningStatus"></div>
  <div id="subStats">
    <div id="loginDays"></div>
    <div id="testStats"></div>
  </div>
</div>

<!-- åºƒå‘Šã¨èª²é‡‘ -->
<div style="margin: 10px;">
  <button onclick="watchAdGlobal()">åºƒå‘Šã‚’è¦‹ã¦ç¾å¥³ãŒè‹±å˜èªã‚’è¡¨ç¾ï¼ˆ5æšæœ‰åŠ¹ï¼‰</button>
</div>
<!-- <div style="margin: 10px;">
  <button onclick="showPremiumPopup()">100å††ã§ãƒ›ãƒƒãƒˆãƒ‘ãƒ³ãƒ„ç¾å¥³è§£æ”¾</button>
</div> -->

<div id="test-section" style="text-align: center; margin: 30px 0;">
<button id="testStartBtn" onclick="startTest()">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹</button>
<button id="testStartBtnVocab" onclick="startVocabularyTest()">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹(å˜èªãƒ¢ãƒ¼ãƒ‰)</button>
  <button onclick="goToPart(getUserId(), 'ç„¡åŒPart')">ç„¡åŒPartã¸</button>
</div>
<div id="weeklyAnswersBox" style="max-width:700px;margin:20px auto;">
  <h3 style="text-align:center;margin:10px 0;">1é€±é–“ã®è§£ç­”æ•°:(ç›®æ¨™è§£ç­”æ•°:80ãŒç›®å®‰)</h3>
  <div id="weeklyBars" style="display:flex;gap:8px;justify-content:space-between;align-items:flex-end;height:140px;padding:8px 4px;background:#fff3f8;border:1px solid #ff99c9;border-radius:12px;"></div>
  <div id="weeklyLabels" style="display:flex;gap:8px;justify-content:space-between;font-size:.8rem;margin-top:6px;color:#555;"></div>
</div>

<!-- è¿½åŠ ï¼šä¸Šå´ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="pagination" id="paginationTop"></div>

<div id="wordContainer"></div>
<div class="pagination" id="pagination"></div>
<!-- HTMLã®ä¸€ç•ªä¸‹ã«è¿½åŠ  -->
<div id="videoModal" style="display:none; position:fixed; top:0; left:0; 
  width:100%; height:100%; background-color:rgba(0,0,0,0.8); 
  justify-content:center; align-items:center; z-index:999;">
  <video id="videoPlayer" controls autoplay width="80%"></video>
</div>

<script>
// ã™ã¹ã¦ã®fetchã‚’åŒä¸€ã‚ªãƒªã‚¸ãƒ³ & Cookieä»˜ãã§
const apiFetch = (path, opts = {}) => fetch(path, { credentials: 'include', ...opts });
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä½¿ã£ã¦ã„ã‚‹ã®ã«æœªå®£è¨€ã ã£ãŸã®ã§ç”¨æ„
let musouMode = false;
let words = [];
let user = { id: null, isPremium: false, canWatchVideo: false };
let currentPage = 1;
const pageSize = 5;
let selectedPart = "part1"; // â† åˆæœŸå€¤ã‚’è¨­å®š
let currentPart = 1; // åˆæœŸå€¤ã¨ã—ã¦ Part1 = 1 ã‚’è¨­å®š

const style = document.createElement('style');
style.innerHTML = `
@keyframes pop {
  0% { transform: scale(0.3); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}`;
document.head.appendChild(style);



//è¡¨ç¤ºåã¨å®Ÿéš›ã®partåã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
const parts = [
  { label: "Part1", value: "part1" },
  { label: "Part2", value: "part2" },
  { label: "Part3", value: "part3" },
  { label: "Part4", value: "part4" },
  { label: "Part5", value: "part5" },
/*   { label: "Part6", value: "part6" },
  { label: "ç™’ã—Part", value: "partHealing" } */
];

document.addEventListener("DOMContentLoaded", async () => {
	  const userId = getUserIdFromQuery();

	  await fetchUserInfo(userId); // â† å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
	  if (userId) {
	    localStorage.setItem("userId", userId);
	    await checkPremiumStatus(userId); // â† ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¤å®š
	  }

	  const urlParams = new URLSearchParams(window.location.search);
	  if (urlParams.get("premium") === "true") {
	    await setUserPremium(userId);
	    user.isPremium = true;
	  }

	  renderPartButtons();
	  await loadWords();
	  // â† ã“ã‚Œã‚’è¿½åŠ 
	  refreshUserStats();

	  // âœ… å…¨éƒ¨å®Œäº†ã—ã¦ã‹ã‚‰ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
	  showUpdateInfoIfNeeded();
	});

//URLã®ãƒ†ã‚¹ãƒˆçµæœã‚’UIã¸åæ˜ ã—ã€å¿…è¦ãªã‚‰ã‚³ãƒŸãƒƒãƒˆã‚‚æ‰“ã¤
async function applyTestParamsAndCommit() {
  const sp = new URLSearchParams(location.search);
  const from  = sp.get('from');
  const score = parseInt(sp.get('score') || '0', 10);
  const total = parseInt(sp.get('total') || '0', 10);
  const userId = getUserIdFromQuery() || 1;
  const mode = 'sentence';

  if (from !== 'test' || !total) return;

  // ã¾ãšç”»é¢ã‚’å³æ™‚æ›´æ–°ï¼ˆã‚µãƒ¼ãƒé…å»¶ã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯çµæœã‚’è¦‹ã‚‰ã‚Œã‚‹ï¼‰
  const testStats = document.getElementById("testStats");
  if (testStats) testStats.textContent = `æ­£ç­”æ•°: ${score} / ${total}å•ä¸­`;

  // ãƒ¬ãƒ™ãƒ«æ¼”å‡ºï¼ˆæš«å®šï¼‰ï¼šç›´è¿‘ã®åˆè¨ˆæ­£ç­”ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç©ã¿ä¸Šã’è¡¨ç¤º
  const localTotalCorrectKey = `localTotalCorrect:${userId}`;
  const prevLocal = parseInt(localStorage.getItem(localTotalCorrectKey) || '0', 10);
  const newLocal  = prevLocal + score;
  localStorage.setItem(localTotalCorrectKey, String(newLocal));

  const prevLevel = Math.floor(prevLocal / 10);
  const newLevel  = Math.floor(newLocal / 10);
  for (let lv = prevLevel + 1; lv <= newLevel; lv++) showLevelUpPopup(lv);

  // ã™ã§ã« test.html å´ã§ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
  const committedKey = `committed:${userId}:${mode}:${score}/${total}`;
  if (sessionStorage.getItem(committedKey) === '1') return;

  // æœªã‚³ãƒŸãƒƒãƒˆãªã‚‰ã“ã“ã§ãƒªãƒˆãƒ©ã‚¤ã‚³ãƒŸãƒƒãƒˆ
  try {
    const res = await fetch('/api/test/commit', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId, mode, correct: score, total })
    });
    if (res.ok) {
      sessionStorage.setItem(committedKey, '1');
    } else {
      console.warn('user.htmlå´ã‚³ãƒŸãƒƒãƒˆå¤±æ•—', res.status);
    }
  } catch (e) {
    console.warn('user.htmlå´ã‚³ãƒŸãƒƒãƒˆä¾‹å¤–', e);
  }
}

// æ—¢å­˜ã® DOMContentLoaded å¾Œã‚„ loadWords() å®Œäº†å¾Œã«å‘¼ã‚“ã§OK
document.addEventListener('DOMContentLoaded', () => {
  applyTestParamsAndCommit();
});


//âœ… ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå±¥æ­´ï¼ˆä¾‹ï¼‰
const latestUpdateVersion = "1.3.0"; // â† æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³
const updateMessage = `
  <ul style="text-align: left;">
    <li>ğŸ‰ æ–°æ©Ÿèƒ½ã€Œè¡£è£…åˆ‡ã‚Šæ›¿ãˆã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ </li>
    <li>ğŸ“ˆ æ­£ç­”æ•°ã«å¿œã˜ãŸãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡ºã‚’è¿½åŠ </li>
    <li>ğŸ”’ ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ä¸€éƒ¨æ©Ÿèƒ½ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¶é™</li>
    <li>ğŸ è»½å¾®ãªãƒã‚°ä¿®æ­£ã¨UIæ”¹å–„</li>
  </ul>
`;

// âœ… åˆå›ãƒ­ã‚°ã‚¤ãƒ³ or ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´æ™‚ã®ã¿è¡¨ç¤º
function showUpdateInfoIfNeeded() {
  const shownVersion = localStorage.getItem("updateInfoShownVersion");
  if (shownVersion !== latestUpdateVersion) {
    Swal.fire({
      title: "âœ¨ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ± (v" + latestUpdateVersion + ")âœ¨",
      html: updateMessage,
      icon: "info",
      confirmButtonText: "é–‰ã˜ã‚‹",
      confirmButtonColor: "#e91e63"
    });

    // è¡¨ç¤ºæ¸ˆã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦ä¿å­˜
    localStorage.setItem("updateInfoShownVersion", latestUpdateVersion);
  }
}

	
async function checkPremiumStatus(userId) {
	  try {
	   const res = await fetch(`/user/${encodeURIComponent(userId)}`, {
		     credentials: 'include'
			});
	    const u = await res.json();
	    if (u.premium === true) {
	      // æ—¢å­˜ã® girlVideo ã‚’ä½¿ç”¨ã—ã€å­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
	      const v = document.getElementById("girlVideo");
	      if (v) {
	        const prefer = "/videos/run_girl_motion.mp4";
	        const fallback = "/videos/girl_idle_loop.mp4";
	        v.onerror = () => { v.src = fallback; };
	        v.src = prefer;
	      }
	    }
	  } catch (err) {
	    console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—", err);
	  }
	}






function changePart(partName) {
	  currentPart = partName;
	  musouMode = (partName === 'ç„¡åŒPart');

	  const userId = new URLSearchParams(window.location.search).get('userId');
	  
	  if (musouMode) {
	    // ç„¡åŒPartã ã‘åˆ¥ãƒšãƒ¼ã‚¸ã«é·ç§»
	    goToPart(userId, "ç„¡åŒPart"); // â†’ musou.html?userId=1&part=ç„¡åŒPart ã«é·ç§»
	  } else {
	    // é€šå¸¸Partã®å˜èªã‚’èª­ã¿è¾¼ã¿
	    loadWords();
	  }
	}
	
//å˜èªã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã‚¹ãƒ©ãƒƒã‚°ã‚’ä½œã‚‹ï¼ˆæ—¢å­˜ã«æˆ»ã™ï¼‰
function toSlugForImage(s) {
  return (s || "")
    .toLowerCase()
    .replace(/\s+/g, "_")
    .replace(/['â€™`"]/g, "")
    .replace(/[^a-z0-9_]/g, "");
}

//å˜èªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æœ€é©ãªç”»åƒURLã‚’æ±ºå®š
function imageUrlForWord(w) {
  if (w.imageUrl) return w.imageUrl;
  if (w.pictUrl)  return w.pictUrl;
  if (w.pictUrlAnimated) return w.pictUrlAnimated; // ã‚ã‚Œã°å„ªå…ˆ
  const slug = toSlugForImage(w.word);
  return `/images/${slug}_girl.png`;               // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€™è£œ
}

async function uploadAndNormalize(file, mode = 'cover'){ // 'cover' or 'contain'
	  const form = new FormData();
	  form.append('file', file);

	  const res = await fetch(`/api/images/normalize/${mode}`, {
	    method: 'POST',
	    body: form
	  });
	  if(!res.ok) throw new Error('ç”»åƒã®æ­£è¦åŒ–ã«å¤±æ•—');
	  return await res.json(); // { url, width, height, mode }
	}

	// ä¾‹ï¼šinput type="file" ã® change ã§
	async function onFileChange(e){
	  const file = e.target.files[0];
	  if(!file) return;
	  const { url } = await uploadAndNormalize(file, 'cover'); // ã¾ãŸã¯ 'contain'
	  // è¿”ã£ã¦ããŸURLã‚’ãã®ã¾ã¾ <img src="..."> ã«ã‚»ãƒƒãƒˆ
	  // ã“ã‚Œã§å…¨ç”»åƒãŒ 3:5 ã®åŒã˜æ¯”ç‡ã§ä¿ç®¡ & è¡¨ç¤ºã•ã‚Œã¾ã™
	}


	
function goToPart(userId, partName) {
	  const url = `musou.html?userId=${userId}&part=${encodeURIComponent(partName)}`;
	  window.location.href = url;
	}

function renderWordCard(word) {
	  if (musouMode) {
	    return `
	      <div class="musou-card">
	        <h3>${word.word}ï¼ˆ${word.meaning}ï¼‰</h3>
	        <audio controls src="${word.audioUrl}"></audio>
	        <video controls width="200" src="${word.videoUrl}"></video>
	        <img src="${word.imageUrl}" width="100" />
	        <button onclick="${user.premium ? `playAll('${word.word}')` : 'showPremiumPopup()'}">ç¾å¥³ã‚’å‹•ã‹ã™</button>
	      </div>
	    `;
	  } else {
	    return `
	      <div class="normal-card">
	        <strong>${word.word}ï¼ˆ${word.meaning}ï¼‰</strong><br>
	        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <input type="checkbox" ${word.status ? 'checked' : ''}>
	        <br>
	        <img src="${word.imageUrl}" width="100">
	        <br>
	        <button onclick="${user.premium ? `playVideo('${word.videoUrl}')` : 'showPremiumPopup()'}">ç¾å¥³ã‚’å‹•ã‹ã™</button>
	      </div>
	    `;
	  }
	}

function getUserId() {
	  return localStorage.getItem("userId") || new URLSearchParams(window.location.search).get("userId") || 1;
	}


function showLevelUpPopup(newLevel) {
	  const title = getTitleByLevel(newLevel);
	  Swal.fire({
	    title: 'ğŸ‰ LEVEL UPï¼ğŸ‰',
	    html: `
	      <p style="font-size: 20px;">æ–°ã—ã„ãƒ¬ãƒ™ãƒ«: Lv.${newLevel}</p>
	      <div style="margin-top: 10px;">ç§°å·ï¼š<strong>${title}</strong></div>
	      <div class="slide-message" style="font-size: 18px; margin-top: 10px;">ã“ã®èª¿å­ã§é ‘å¼µã‚ã†ï¼</div>
	      <br>
	      <button id="shareButton" style="background:#1da1f2;color:white;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;">
	        SNSã§ã‚·ã‚§ã‚¢ã™ã‚‹
	      </button>
	    `,
	    showConfirmButton: false,
	    timer: 6000,
	    didOpen: () => {
	      document.getElementById("shareButton").addEventListener("click", () => {
	        const shareText = `ç§ã¯ä»Šãƒ¬ãƒ™ãƒ«${newLevel}ã§ã€Œ${title}ã€ã«åˆ°é”ã—ã¾ã—ãŸï¼ #ç¾å¥³å˜`;
	        const shareUrl = encodeURIComponent("https://your-app-url.com");
	        const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${shareUrl}`;
	        window.open(tweetUrl, '_blank');
	      });
	    }
	  });
	}


//è¿½åŠ ï¼šPartç”¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°
let partsPage = 1;
const partsPerPage = 4; // 1ãƒšãƒ¼ã‚¸ã«å‡ºã™Partæ•°ï¼ˆãŠå¥½ã¿ã§ï¼‰

// ç½®ãæ›ãˆï¼šãƒœã‚¿ãƒ³ã®æç”»ï¼ˆãƒšãƒ¼ã‚¸å†…ã®Partã ã‘è¡¨ç¤ºï¼‰
function renderPartButtons() {
  const container = document.getElementById("partButtons");
  container.innerHTML = "";

  const start = (partsPage - 1) * partsPerPage;
  const view = parts.slice(start, start + partsPerPage);

  view.forEach(({ label, value }) => {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.onclick = () => selectPart(value);
    if (value === selectedPart) btn.style.fontWeight = "bold";
    container.appendChild(btn);
  });

  renderPartPagination(); // â† ãƒšãƒ¼ã‚¸ç•ªå·ã‚‚æ›´æ–°
}

// è¿½åŠ ï¼šPartç”¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
function renderPartPagination() {
  const pageCount = Math.ceil(parts.length / partsPerPage);
  const top = document.getElementById("partPaginationTop");
  const bottom = document.getElementById("partPagination");
  const containers = [top, bottom].filter(Boolean);

  containers.forEach(c => { c.innerHTML = ""; });
  if (pageCount <= 1) {
    containers.forEach(c => c.classList.add("hidden"));
    return;
  }
  containers.forEach(c => c.classList.remove("hidden"));

  const build = (wrap) => {
    const makeBtn = (label, page, disabled = false, active = false) => {
      const btn = document.createElement("button");
      btn.textContent = label;
      if (disabled) btn.disabled = true;
      if (active) btn.classList.add("active");
      btn.addEventListener("click", () => {
        if (disabled || !page || page === partsPage) return;

        const oldTop = wrap.getBoundingClientRect().top;
        partsPage = page;
        renderPartButtons(); // â† å†æç”»ï¼ˆè‡ªåˆ†ã‚‚æ›´æ–°ã•ã‚Œã‚‹ï¼‰
        requestAnimationFrame(() => {
          const newTop = wrap.getBoundingClientRect().top;
          window.scrollBy(0, newTop - oldTop); // æŠ¼ã—ãŸä½ç½®ã«ç•™ã¾ã‚‹
        });
      });
      return btn;
    };

    const addPage = (n) => wrap.appendChild(makeBtn(String(n), n, false, n === partsPage));
    const addDots = () => {
      const s = document.createElement("span");
      s.className = "ellipsis";
      s.textContent = "â€¦";
      wrap.appendChild(s);
    };

    wrap.appendChild(makeBtn("â€¹", partsPage - 1, partsPage === 1));

    if (pageCount <= 5) {
      for (let i = 1; i <= pageCount; i++) addPage(i);
    } else if (partsPage <= 3) {
      addPage(1); addPage(2); addPage(3); addDots(); addPage(pageCount);
    } else if (partsPage >= pageCount - 2) {
      addPage(1); addDots(); addPage(pageCount - 2); addPage(pageCount - 1); addPage(pageCount);
    } else {
      addPage(1); addDots();
      addPage(partsPage - 1); addPage(partsPage); addPage(partsPage + 1);
      addDots(); addPage(pageCount);
    }

    wrap.appendChild(makeBtn("â€º", partsPage + 1, partsPage === pageCount));
  };

  containers.forEach(build);
}

// ä¿®æ­£ï¼šParté¸æŠæ™‚ã«ã€Œãã®PartãŒè¼‰ã£ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã€ã‚’è‡ªå‹•è¡¨ç¤º
function selectPart(part) {
  const lockedParts = ["part4", "part5", "part6", "partHealing", "musou"];
  const isLockedPart = lockedParts.includes(part);

  const show = () => {
    selectedPart = part;
    const idx = Math.max(0, parts.findIndex(p => p.value === part));
    partsPage = Math.floor(idx / partsPerPage) + 1; // ãã®PartãŒè¼‰ã£ã¦ã„ã‚‹ã€ŒPartãƒšãƒ¼ã‚¸ã€ã‚’è¡¨ç¤º
    currentPart = idx + 1;
    currentPage = 1;
    renderPartButtons();
    loadWords();
  };

  if (!user.premium && isLockedPart && !isAdEnabled()) {
    Swal.fire({
      title: "ã“ã®ãƒ‘ãƒ¼ãƒˆã¯åºƒå‘Šè¦–è´ãŒå¿…è¦ã§ã™",
      html: `<p>åºƒå‘Šã‚’è¦‹ã‚Œã°<strong>5åˆ†é–“ã ã‘é–‹æ”¾</strong>ã•ã‚Œã¾ã™ã€‚<br>
             <span style="color:#e91e63;font-weight:bold;">ğŸ€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡</span>ãªã‚‰ã€<strong>ç„¡åˆ¶é™ã§é–‹æ”¾</strong>ã•ã‚Œã¾ã™ã€‚</p>`,
      icon: "info",
      showCancelButton: true,
      showDenyButton: true,
      confirmButtonText: "åºƒå‘Šã‚’è¦‹ã‚‹",
      cancelButtonText: "ã‚„ã‚ã‚‹",
      denyButtonText: "ğŸ€ 300å††ã§åºƒå‘Šãªã—ï¼ç¾å¥³ã‚ãã‚Šæ”¾é¡ŒğŸ€"
    }).then(result => {
      if (result.isConfirmed) {
        watchAdGlobal();
        show();
      } else if (result.isDenied) {
        showPremiumPopup();
      }
    });
  } else {
    show();
  }
}

function getUserIdFromQuery() {
  const params = new URLSearchParams(window.location.search);
  return params.get('userId');
}

async function fetchUserInfo(userId) {
  const res = await apiFetch(`/user/${encodeURIComponent(userId)}`);
  if (!res.ok) {
    alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
    window.location.href = "login.html";
    return;
  }
  const data = await res.json();
  user = data;

  localStorage.setItem("userId", data.id);
  document.getElementById("username").innerText = `${data.username} ã•ã‚“ã€ã‚ˆã†ã“ãï¼`;
  document.getElementById("planText").innerText = `ãƒ—ãƒ©ãƒ³: ${data.premium ? "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ " : "ç„¡æ–™"}`;
  document.getElementById("userLevel").innerText = `ãƒ¬ãƒ™ãƒ«: Lv.${data.level || 1}`;
  updateGirlVisual(data.level || 1);

  await updateLoginPointsIfNeeded(data.id);

  if (typeof data.loginPoints === 'number') {
    showLoginBonus(data.loginPoints);
  }
}


async function updateLoginPointsIfNeeded(userId) {
  try {
    const res = await apiFetch(`/api/user/${encodeURIComponent(userId)}/update-login-points`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });

    if (res.ok && res.status !== 204) {
      const updated = await res.json().catch(() => null);
      if (updated && typeof updated.loginPoints === 'number') {
        showLoginBonus(updated.loginPoints);
        const el = document.getElementById("loginDays");
        if (el) el.textContent = `å­¦ç¿’æ—¥æ•°: ${updated.loginPoints}æ—¥ç›®`;
      }
    }
  } catch (err) {
    console.warn("ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆæ›´æ–°å¤±æ•—", err);
  }
}


async function fetchWordsFromServer(userId, part) {
  const res = await apiFetch(
    `/api/words?userId=${encodeURIComponent(userId)}&part=${encodeURIComponent(part)}`
  );
  if (!res.ok) {
    console.error('å˜èªå–å¾—å¤±æ•—', res.status, await res.text().catch(()=>'')); 
    alert("å˜èªã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return [];
  }
  const data = await res.json();

  return data.map(word => {
    const s = word.status;
    const learned =
      s === true || s === 1 || s === '1' || s === 'true' || s === 'LEARNED';
    return { ...word, status: !!learned };
  });
}


//=== åºƒå‘Šè¡¨ç¤ºãƒˆãƒªã‚¬ç”¨ã®ã‚«ã‚¦ãƒ³ã‚¿ã¨ä¿ç•™å®Ÿè¡Œ ===
let pendingToggle = null;

function getBeautyClickCount() {
  const n = parseInt(localStorage.getItem('beauty_clicks') || '0', 10);
  return isNaN(n) ? 0 : n;
}
function incBeautyClickCount() {
  const n = getBeautyClickCount() + 1;
  localStorage.setItem('beauty_clicks', String(n));
  return n;
}
function resetBeautyClickCount() {
  localStorage.setItem('beauty_clicks', '0');
}

// åºƒå‘Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦ã€é–‰ã˜ãŸã‚‰å‡¦ç†å†é–‹ã§ãã‚‹ã‚ˆã†ã«ä¿ç•™
function showAdModalForToggle(callback) {
  pendingToggle = callback;
  document.getElementById('adModal').style.display = 'flex';
}

// æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³IDã«å¯¾å¿œï¼ˆä¸‹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLãã®ã¾ã¾ä½¿ãˆã¾ã™ï¼‰
function handleAdAccept() {
  // è¦–è´å‡¦ç†ï¼ˆæ—¢å­˜ã®5åˆ†è§£æ”¾ã‚’æµç”¨ï¼‰
  watchAdGlobal();
  closeAdModal();
  if (typeof pendingToggle === 'function') {
    pendingToggle();
    pendingToggle = null;
  }
  resetBeautyClickCount(); // 6å›ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
}
function closeAdModal() {
  document.getElementById('adModal').style.display = 'none';
  pendingToggle = null;
}

function renderWords() {
	  const container = document.getElementById("wordContainer");
	  container.innerHTML = "";

	  const start = (currentPage - 1) * pageSize;
	  const pageWords = words.slice(start, start + pageSize);

	  pageWords.forEach((word, index) => {
	    const div = document.createElement("div");
	    div.className = "word-card";

	    const isPremium = !!(user && (user.premium === true || user.premium === 'true'));
	    const actionButton = 
	      /* `<button onclick="playVideo('${word.pictUrlAnimated || ""}')">ç¾å¥³ã‚’å‹•ã‹ã™</button>` */
	      ""; // ç„¡æ–™ã¯éè¡¨ç¤º

	    const checkboxId = `status-${word.id}`;
	    const checked = word.status ? "checked" : "";
	    const labelText = word.status ? "å­¦ç¿’æ¸ˆã¿" : "æœªå­¦ç¿’";

	    const imageId = `img-${index}`;
	    const toggleButtonId = `toggle-${index}`;
	    const baseImg = '/images/beauty.png';
	    const slug = toSlugForImage(word.word);
	    const specificImg = `/images/${slug}_girl.png`;

	    div.innerHTML = `
	    	  <div class="wc-img">
	    	<img id="${imageId}" src="${baseImg}" alt="${word.word}" loading="lazy" decoding="async">
	    	  </div>

	    	  <div class="wc-body">
	    	    <strong>${word.word}</strong>
	    	    <div class="meta">ï¼ˆ${word.meaning}ï¼‰</div>
	    	    <div class="meta">
	    	      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
	    	      <input type="checkbox" id="${checkboxId}" ${checked}
	    	        onchange="toggleStatus(this.checked, ${word.id}, selectedPart)">
	    	      <span id="status-label-${word.id}">${labelText}</span>
	    	    </div>
	    	    <div class="meta">ç”»åƒãƒ‘ã‚¹: <span id="imgpath-${index}">${baseImg}</span></div>
	    	  </div>

	    	  <div class="wc-actions">
	    	    <button id="${toggleButtonId}"
	    	      onclick="handleToggleImage('${imageId}','${toggleButtonId}','${baseImg}','${specificImg}','${index}')">
	    	      ç¾å¥³ã§è‹±å˜èªã‚’è¡¨ç¾ã™ã‚‹
	    	    </button>
	    	    ${actionButton ? `<div style="margin-top:6px">${actionButton}</div>` : ""}
	    	  </div>
	    	`;


	    container.appendChild(div);
	  });

	  renderPagination(words.length);
	}


function toggleImage(imgId, btnId, img1, img2, index) {
	  const imgElem = document.getElementById(imgId);
	  const pathLabel = document.getElementById(`imgpath-${index}`);
	  const currentSrc = imgElem.getAttribute("src");

	  if (currentSrc === img1) {
	    imgElem.src = img2;
	    pathLabel.textContent = img2;
	  } else {
	    imgElem.src = img1;
	    pathLabel.textContent = img1;
	  }
	}

function handleToggleImage(imgId, btnId, img1, img2, index) {
	  // å®Ÿéš›ã®åˆ‡æ›¿å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯åŒ–
	  const proceed = () => toggleImage(imgId, btnId, img1, img2, index);

	  // ã‚¯ãƒªãƒƒã‚¯å›æ•°ã‚’å¢—ã‚„ã—ã¦å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿æŒï¼‰
	  const total = incBeautyClickCount();

	  // éãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã¯ 6 å›ã”ã¨ã«åºƒå‘Šè¡¨ç¤º â†’ è¦–è´å¾Œã«ç¶šãå®Ÿè¡Œ
	  if (!user.premium && total % 6 === 0) {
	    showAdModalForToggle(proceed);
	    return;
	  }

	  // åºƒå‘Šå¯¾è±¡ã§ãªã„å ´åˆã¯ãã®ã¾ã¾åˆ‡æ›¿
	  proceed();
	}


function renderPagination(totalItems) {
	  const pageCount = Math.ceil(totalItems / pageSize);
	  const top = document.getElementById("paginationTop");
	  const bottom = document.getElementById("pagination");
	  const containers = [top, bottom].filter(Boolean);

	  // ã‚¯ãƒªã‚¢
	  containers.forEach(c => c.innerHTML = "");
	  if (pageCount <= 1) return;

	  const build = (wrap) => {
	    const makeBtn = (label, page, disabled = false, active = false) => {
	      const btn = document.createElement("button");
	      btn.textContent = label;
	      if (disabled) btn.disabled = true;
	      if (active) btn.classList.add("active");

	      btn.addEventListener("click", () => {
	        if (disabled || !page || page === currentPage) return;

	        // æŠ¼ã—ãŸâ€œãã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³â€ã®ä½ç½®ã‚’åŸºæº–ã«ã‚¢ãƒ³ã‚«ãƒ¼
	        const oldTop = wrap.getBoundingClientRect().top;

	        currentPage = page;
	        renderWords(); // ä¸Šä¸‹ã¨ã‚‚å†æç”»ã•ã‚Œã‚‹

	        requestAnimationFrame(() => {
	          const newTop = wrap.getBoundingClientRect().top;
	          window.scrollBy(0, newTop - oldTop);
	        });
	      });

	      return btn;
	    };

	    const addPage = (n) => wrap.appendChild(makeBtn(String(n), n, false, n === currentPage));
	    const addDots = () => {
	      const s = document.createElement("span");
	      s.className = "ellipsis";
	      s.textContent = "â€¦";
	      wrap.appendChild(s);
	    };

	    // â€¹ å‰ã¸
	    wrap.appendChild(makeBtn("â€¹", currentPage - 1, currentPage === 1));

	    // æœ¬ä½“
	    if (pageCount <= 5) {
	      for (let i = 1; i <= pageCount; i++) addPage(i);
	    } else if (currentPage <= 3) {
	      addPage(1); addPage(2); addPage(3);
	      addDots();
	      addPage(pageCount);
	    } else if (currentPage >= pageCount - 2) {
	      addPage(1);
	      addDots();
	      addPage(pageCount - 2); addPage(pageCount - 1); addPage(pageCount);
	    } else {
	      addPage(1);
	      addDots();
	      addPage(currentPage - 1); addPage(currentPage); addPage(currentPage + 1);
	      addDots();
	      addPage(pageCount);
	    }

	    // â€º æ¬¡ã¸
	    wrap.appendChild(makeBtn("â€º", currentPage + 1, currentPage === pageCount));
	  };

	  containers.forEach(build);
	}



async function loadWords() {
	  const userId = getUserIdFromQuery();
	  words = await fetchWordsFromServer(userId, selectedPart);
	  renderWords();

	  // âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆã‚’åæ˜ 
	  updateStatusCount();

	  // âœ… ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ•°è¡¨ç¤º
	  document.getElementById("loginDays").textContent = `å­¦ç¿’æ—¥æ•°: ${user.loginPoints || 0}æ—¥ç›®`;

	  // âœ… ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
	  // login.html ã¾ãŸã¯ login.jså†…ã§ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œ
	  const correct = localStorage.getItem("test_correct") || 0;
	  const total = localStorage.getItem("test_total") || 0;
	  document.getElementById("testStats").textContent = `æ­£ç­”æ•°: ${correct} / ${total}å•ä¸­`;
	  await refreshUserStats();
	}

function watchAdGlobal() {
	  const now = Date.now();
	  const expiry = now + 5 * 60 * 1000; // 5åˆ†é–“æœ‰åŠ¹
	  localStorage.setItem("ad_expiry", expiry.toString());

	  alert("åºƒå‘Šè¦–è´å®Œäº†ï¼");
	  renderWords(); // â† ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’å³æ™‚åæ˜ 
	}
	
function isAdEnabled() {
	  const expiry = localStorage.getItem("ad_expiry");
	  return expiry && Date.now() < parseInt(expiry);
	}


function unlockCasualSuit() {
  alert("1000å††ã§ç¾å¥³ã‚¹ãƒ¼ãƒ„è§£æ”¾ï¼ˆä»®ï¼‰");
}

function playVideo(videoUrl) {
	  const modal = document.getElementById("videoModal");
	  const player = document.getElementById("videoPlayer");
	  player.src = videoUrl;
	  modal.style.display = "flex";

	  modal.onclick = () => {
	    modal.style.display = "none";
	    player.pause();
	    player.currentTime = 0;
	  };
	}
function updateGirlVisual(level) {
	  const v = document.getElementById("girlVideo");
	  const bg = document.getElementById("bgEffect");
	  if (!v || !bg) return;

	  // 404ãªã©ã§èª­ã¿è¾¼ã‚ãªã„æ™‚ã¯å‹•ç”»ã‚’æ¶ˆã™ï¼ˆUIãŒå´©ã‚Œãªã„ã‚ˆã†ã«ï¼‰
	  v.onerror = () => { v.remove(); };

	  // ã©ã®ãƒ¬ãƒ™ãƒ«ã§ã‚‚å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¯åŒã˜ãªã‚‰æ¯å›å·®ã—æ›¿ãˆãªãã¦ã‚‚OKã§ã™ãŒã€
	  // å¿µã®ãŸã‚ç¾åœ¨ã¨é•ã†å ´åˆã ã‘è¨­å®šã—ã¾ã™ã€‚
	  const src = "/videos/girl_idle_loop.mp4";
	  if (v.getAttribute("src") !== src) v.src = src;

	  if (level >= 20) {
	    bg.className = "heart-bg";
	  } else if (level >= 10) {
	    bg.className = "star-bg";
	  } else {
	    bg.className = "star-bg"; // normal-bg ãŒæœªå®šç¾©ãªã®ã§ã¨ã‚Šã‚ãˆãš star-bg ã«çµ±ä¸€
	  }
	}


function toggleStatus(isChecked, wordId, part) {
	  const userId = getUserIdFromQuery();

	  fetch('/api/learning/update', {
	    method: 'PUT',
	    headers: {
	      'Content-Type': 'application/json'
	    },
	    body: JSON.stringify({
	      userId: userId,
	      wordId: wordId,
	      status: isChecked,
	      part: part
	    })
	  })
	  .then(response => {
	    if (!response.ok) {
	      alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
	      return;
	    }

	    // æˆåŠŸæ™‚ã®ã¿åæ˜ 
	    const word = words.find(w => w.id === wordId);
	    if (word) {
	      word.status = isChecked;
	      const statusSpan = document.getElementById(`status-label-${wordId}`);
	      if (statusSpan) {
	        statusSpan.innerText = isChecked ? "å­¦ç¿’æ¸ˆã¿" : "æœªå­¦ç¿’";
	      }
	    }

	    updateStatusCount();
	  })
	  .catch(err => {
	    console.error(err);
	    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
	  });
	}



async function updateStatusCount() {
  const userId = getUserIdFromQuery();

  try {
    const res = await apiFetch(
      `/api/learning/count?userId=${encodeURIComponent(userId)}&part=${encodeURIComponent(selectedPart)}`
    );
    if (!res.ok) throw new Error("å­¦ç¿’æ¸ˆã¿æ•°ã®å–å¾—ã«å¤±æ•—");

    const learnedCount = await res.json();
    const totalCount = words.length;
    const unlearnedCount = Math.max(0, totalCount - learnedCount);

    const statusDiv = document.getElementById("learningStatus");
    statusDiv.textContent = `å­¦ç¿’æ¸ˆã¿: ${learnedCount} / æœªå­¦ç¿’: ${unlearnedCount}`;
  } catch (err) {
    console.error(err);
    document.getElementById("learningStatus").textContent = "å­¦ç¿’çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
}


//ç½®ãæ›ãˆç‰ˆï¼šæ•°å€¤ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
async function loadWeeklyAnswers(){
  const userId = getUserIdFromQuery() || localStorage.getItem('userId') || 1;
  try{
    const res = await fetch(`/api/test/weekly?userId=${userId}`);
    if(!res.ok) return;
    const data = await res.json(); // [{ymd, answers, correct} Ã—7]

    // æ£’ã®é«˜ã•ã¯è§£ç­”æ•°ã‚’åŸºæº–ã«
    const max = Math.max(1, ...data.map(d => d.answers));
    const bars = document.getElementById('weeklyBars');
    const labels = document.getElementById('weeklyLabels');
    bars.innerHTML = ''; labels.innerHTML = '';

    data.forEach(d => {
      const h = Math.round((d.answers / max) * 120); // æœ€å¤§120px
      const wrap = document.createElement('div');
      wrap.style.flex = '1';
      wrap.style.display = 'flex';
      wrap.style.flexDirection = 'column';
      wrap.style.alignItems = 'center';
      wrap.style.justifyContent = 'flex-end';

      // ä¸Šã«æ­£è§£æ•°ã‚’è¡¨ç¤º
      const num = document.createElement('div');
      num.textContent = d.correct;   // æ­£è§£æ•°ã®ã¿
      num.style.fontSize = '.8rem';
      num.style.color = '#e91e63';
      num.style.marginBottom = '4px';
      wrap.appendChild(num);

      // æ£’ï¼ˆè§£ç­”æ•°ã‚’åŸºæº–ã«ã—ãŸé«˜ã•ï¼‰
      const bar = document.createElement('div');
      bar.title = `æ­£è§£:${d.correct} / è§£ç­”:${d.answers}`; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§æ­£è§£/è§£ç­”
      bar.style.width = '24px';
      bar.style.height = `${h}px`;
      bar.style.borderRadius = '8px';
      bar.style.background = 'linear-gradient(180deg,#ff7bbd,#ffb3d9)';
      bar.style.boxShadow = '0 2px 6px rgba(0,0,0,.08)';
      wrap.appendChild(bar);

      bars.appendChild(wrap);

      // æ—¥ä»˜ãƒ©ãƒ™ãƒ«
      const dd = new Date(d.ymd);
      const label = document.createElement('div');
      const mmdd = `${(dd.getMonth()+1).toString().padStart(2,'0')}/${dd.getDate().toString().padStart(2,'0')}`;
      const youbi = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dd.getDay()];
      label.style.flex='1';
      label.style.textAlign='center';
      label.innerHTML = `<div>${mmdd}</div><div style="opacity:.7">${youbi}</div>`;
      labels.appendChild(label);
    });
  }catch(e){
    console.warn('weekly chart load failed', e);
  }
}



	// DOMContentLoaded å¾Œã®ã©ã“ã‹ã§å‘¼ã¶
	document.addEventListener("DOMContentLoaded", loadWeeklyAnswers);


	
function showLoginBonus(points) {
	  const grid = document.getElementById('stampGrid');
	  grid.innerHTML = '';

	  // â­ loginPointsãŒ0ã§ã‚‚ã€1æ—¥ç›®ã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¡¨ç¤º
	  const displayPoints = Math.max(points, 1);

	  for (let i = 1; i <= 30; i++) {
	    const cell = document.createElement('div');
	    cell.style.width = '60px';
	    cell.style.height = '60px';
	    cell.style.border = '1px solid #999';
	    cell.style.display = 'flex';
	    cell.style.justifyContent = 'center';
	    cell.style.alignItems = 'center';
	    cell.style.backgroundColor = '#eee';

	    if (i <= displayPoints) {
	      const img = document.createElement('img');
	      img.src = '/images/stamp_beauty.png';
	      img.alt = 'ã‚¹ã‚¿ãƒ³ãƒ—';
	      img.style.width = '100%';
	      img.style.height = '100%';
	      img.style.objectFit = 'cover';
	      img.style.borderRadius = '50%';
	      img.style.border = '2px solid pink';
	      if (i === displayPoints) img.style.animation = 'pop 0.6s ease';
	      cell.appendChild(img);
	    } else {
	      const label = document.createElement('div');
	      label.textContent = `${i}æ—¥ç›®`;
	      label.style.fontSize = '12px';
	      cell.appendChild(label);
	    }

	    grid.appendChild(cell);
	  }

	  document.getElementById('loginBonusPopup').style.display = 'block';
	}
	
	function getTitleByLevel(level) {
		  if (level >= 20) return "ãƒ›ãƒƒãƒˆãƒ‘ãƒ³ãƒ„ã®è¦‡è€…";
		  if (level >= 15) return "ã‚»ã‚¯ã‚·ãƒ¼å­¦ç¿’ç‹";
		  if (level >= 10) return "ãƒ•ãƒªãƒ•ãƒªç¾å¥³ãƒã‚¹ã‚¿ãƒ¼";
		  if (level >= 5) return "Newbie";
		  return "ãƒ“ã‚®ãƒŠãƒ¼";
		}

	function closeLoginBonus() {
	  document.getElementById("loginBonusPopup").style.display = "none";
	}
	
	function showPremiumPopup() {
		  Swal.fire({
		    title: 'ğŸ€ ç¾å¥³å˜ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ ğŸ€',
		    html: `
		      <div style="text-align:left; font-size: 0.95rem;">
		        <p>å…¨ãƒ¢ãƒ¼ãƒ‰è§£æ”¾ï¼†åºƒå‘Šãªã—ã®è´…æ²¢ä½“é¨“</p>
		        <ul style="line-height:1.6;">
		          <li>âœ” ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰è§£æ”¾</li>
		          <li>âœ” ãƒ†ã‚¹ãƒˆå›æ•°ç„¡åˆ¶é™ï¼†æˆç¸¾å±¥æ­´ã‚‚ä¿å­˜</li>
		        </ul>
		        <p style="font-weight:bold; font-size:1.1rem;">ğŸ’° æœˆé¡500å††ï¼ˆç¨è¾¼ï¼‰</p>
		        <p style="color:red;">âœ¨ ä»Šã ã‘åˆæœˆ300å††ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸­ âœ¨</p>
		        <small>SNSã§ã‚·ã‚§ã‚¢ã™ã‚‹ã¨1é€±é–“ç„¡æ–™ä½“é¨“ğŸ</small>
		      </div>
		    `,
		    showCancelButton: true,
		    confirmButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«ç™»éŒ²ã™ã‚‹",
		    cancelButtonText: "ã‚ã¨ã§è¦‹ã‚‹",
		    customClass: {
		      popup: 'premium-popup',
		      confirmButton: 'btn-premium'
		    }
		  }).then(result => {
		    if (result.isConfirmed) {
		      window.location.href = "/premium.html"; // ãƒ—ãƒ©ãƒ³ç™»éŒ²ãƒšãƒ¼ã‚¸ã¸é·ç§»
		    }
		  });
		}
	
	function subscribePremium() {
		  fetch('/api/payment/create-checkout-session', {
		    method: 'POST',
		    headers: { 'Content-Type': 'application/json' },
		    body: JSON.stringify({ userId: 1 }) // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
		  })
		  .then(res => res.json())
		  .then(data => {
		    window.location.href = data.checkoutUrl;
		  });
		}



	function startTest() {
		  const userId = new URLSearchParams(window.location.search).get("userId");
		  const testCount = localStorage.getItem("test_started");

		  if (testCount) {
		    alert("åºƒå‘Šã‚’è¦‹ã›ã‚‹å‡¦ç†ï¼ˆä»®ï¼‰");
		  }

		  if (user.premium) {
		    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¢ãƒ¼ãƒ‰é¸æŠå¯èƒ½
		    Swal.fire({
		      title: "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
		      html: `
		        <button id="readingBtn" class="swal2-confirm swal2-styled" style="margin: 5px;">ğŸ“˜ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</button>
		        <button id="listeningBtn" class="swal2-confirm swal2-styled" style="background:#3949ab;margin: 5px;">ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
		      `,
		      showConfirmButton: false,
		      didOpen: () => {
		        document.getElementById("readingBtn").addEventListener("click", () => {
		          localStorage.setItem("test_started", "1");
		          window.location.href = `test.html?userId=${userId}&mode=reading`;
		        });
		        document.getElementById("listeningBtn").addEventListener("click", () => {
		          localStorage.setItem("test_started", "1");
		          window.location.href = `test.html?userId=${userId}&mode=listening`;
		        });
		      }
		    });
		  } else {
		    // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ã¿ï¼ˆåºƒå‘Šä»˜ãï¼‰
		    Swal.fire({
		      title: "ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ å°‚ç”¨ğŸ§",
		      html: `
		        <p>ä»Šã¯ <strong>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰</strong>ã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
		        <p>ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç™»éŒ²ã§ <strong>éŸ³å£°ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</strong>ã‚‚å¯èƒ½ã«ï¼</p>
		      `,
		      showCancelButton: true,
		      confirmButtonText: "ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§å§‹ã‚ã‚‹",
		      cancelButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’è¦‹ã‚‹",
		    }).then(result => {
		      if (result.isConfirmed) {
		        localStorage.setItem("test_started", "1");
		        window.location.href = `test.html?userId=${userId}&mode=reading`;
		      } else if (result.dismiss === Swal.DismissReason.cancel) {
		        showPremiumPopup(); // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ¡ˆå†…ã‚’è¡¨ç¤º
		      }
		    });
		  }
		}
	
	function startVocabularyTest() {
		  const userId = new URLSearchParams(window.location.search).get("userId");
		  const testCount = localStorage.getItem("test_started");

		  if (testCount) {
		    alert("åºƒå‘Šã‚’è¦‹ã›ã‚‹å‡¦ç†ï¼ˆä»®ï¼‰");
		  }

		  if (user.premium) {
		    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¢ãƒ¼ãƒ‰é¸æŠå¯èƒ½
		    Swal.fire({
		      title: "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
		      html: `
		        <button id="readingBtn" class="swal2-confirm swal2-styled" style="margin: 5px;">ğŸ“˜ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</button>
		        <button id="listeningBtn" class="swal2-confirm swal2-styled" style="background:#3949ab;margin: 5px;">ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
		      `,
		      showConfirmButton: false,
		      didOpen: () => {
		        document.getElementById("readingBtn").addEventListener("click", () => {
		          localStorage.setItem("test_started", "1");
		          window.location.href = `vocabularyTest.html?userId=${userId}&mode=reading`;
		        });
		        document.getElementById("listeningBtn").addEventListener("click", () => {
		          localStorage.setItem("test_started", "1");
		          window.location.href = `vocabularyTest.html?userId=${userId}&mode=listening`;
		        });
		      }
		    });
		  } else {
		    // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ã¿ï¼ˆåºƒå‘Šä»˜ãï¼‰
		    Swal.fire({
		      title: "ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ å°‚ç”¨ğŸ§",
		      html: `
		        <p>ä»Šã¯ <strong>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰</strong>ã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
		        <p>ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç™»éŒ²ã§ <strong>éŸ³å£°ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</strong>ã‚‚å¯èƒ½ã«ï¼</p>
		      `,
		      showCancelButton: true,
		      confirmButtonText: "ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§å§‹ã‚ã‚‹",
		      cancelButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’è¦‹ã‚‹",
		    }).then(result => {
		      if (result.isConfirmed) {
		        localStorage.setItem("test_started", "1");
		        window.location.href = `test.html?userId=${userId}&mode=reading`;
		      } else if (result.dismiss === Swal.DismissReason.cancel) {
		        showPremiumPopup(); // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ¡ˆå†…ã‚’è¡¨ç¤º
		      }
		    });
		  }
		}


	// ç´¯è¨ˆæ­£ç­”ã¨å­¦ç¿’æ—¥æ•°ã‚’ /user/{id} ã‹ã‚‰æ›´æ–°ã€‚
	// loginPoints ãŒãªã‘ã‚Œã° /api/test/weekly ã‹ã‚‰ç›´è¿‘7æ—¥ã®ã€Œå›ç­”>0æ—¥æ•°ã€ã‚’è¡¨ç¤ºã€‚
	async function refreshUserStats() {
	  const userId = getUserIdFromQuery() || localStorage.getItem('userId') || 1;

	  try {
	    const res = await fetch(`/user/${userId}`);
	    if (res.ok) {
	      const u = await res.json();

	      // å­¦ç¿’æ—¥æ•°
	      const days = (typeof u.loginPoints === 'number') ? u.loginPoints : 0;
	      document.getElementById("loginDays").textContent = `å­¦ç¿’æ—¥æ•°: ${days}æ—¥ç›®`;

	      // ç´¯è¨ˆæ­£ç­”ï¼ˆ/api/test/commit ã§å¢—ãˆã‚‹ã®ã¯ã“ã£ã¡ï¼‰
	   	  const totalCorrect = Number(u.testCorrectTotal ?? 0);
	      document.getElementById("testStats").textContent = `æ­£ç­”æ•°ï¼ˆç´¯è¨ˆï¼‰: ${totalCorrect}`;
	      
	      // â˜… ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—ã—ã€DBã«åæ˜ 
	     const newLevel = Math.max(1, Math.floor(totalCorrect / 10) + 1);
     const currentLevel = Number(u.level ?? 1);
     if (currentLevel !== newLevel) {
       // ã‚µãƒ¼ãƒã«ä¿å­˜ï¼ˆURLä¿®æ­£æ¸ˆã¿ï¼‰
       const r = await fetch(`/user/updateLevel`, {
         method: 'PUT',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ userId, level: newLevel })
       });
       if (r.ok) {
         const json = await r.json().catch(() => ({}));
         u.level = Number(json.level ?? newLevel); // è¿”å´ãªã‘ã‚Œã°è¨ˆç®—å€¤
       } else {
         // ä¿å­˜ã«å¤±æ•—ã—ã¦ã‚‚UIã¯é€²ã‚ã‚‹ï¼ˆä½“é¨“å„ªå…ˆï¼æ¬¡å›å†åŒæœŸï¼‰
         u.level = newLevel;
       }
     }
	   		  // è¡¨ç¤ºæ›´æ–°ï¼ˆDBå€¤ã‚’å„ªå…ˆï¼‰
	      	  const levelEl = document.getElementById("userLevel");
		      const lv = Number(u.level ?? 1);
		      if (levelEl) levelEl.textContent = `ãƒ¬ãƒ™ãƒ«: Lv.${lv}`;
		      updateGirlVisual(lv);

	      // ãƒ¬ãƒ™ãƒ«æ¼”å‡ºã®ãŸã‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°
	      const prev = parseInt(localStorage.getItem('previousCorrect') || '0', 10);
	      const prevLv = Math.floor(prev / 10);
	      const newLv  = Math.floor(totalCorrect / 10);
	      if (newLv > prevLv) {
	        for (let lv = prevLv + 1; lv <= newLv; lv++) showLevelUpPopup(lv);
	      }
	      localStorage.setItem('previousCorrect', String(totalCorrect));
	      return;
	    }
	  } catch (e) {
	    console.warn('refreshUserStats /user fetch failed', e);
	  }

	  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼š/weekly ã‹ã‚‰ç›´è¿‘7æ—¥ã§ã€Œå›ç­”>0ã®æ—¥ã€ã‚’å­¦ç¿’æ—¥æ•°ã¨ã—ã¦è¡¨ç¤º
	  try {
	    const r2 = await fetch(`/api/test/weekly?userId=${userId}`);
	    if (r2.ok) {
	      const w = await r2.json(); // [{ymd, answers, correct} ...]
	      const days = w.filter(d => d.answers > 0).length;
	      document.getElementById("loginDays").textContent = `å­¦ç¿’æ—¥æ•°(ç›´è¿‘7æ—¥): ${days}æ—¥`;
	    }
	  } catch (e) {
	    /* ç„¡è¦– */
	  }
	}

async function setUserPremium(userId) {
  try {
    const res = await apiFetch(`/api/user/updatePremium`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    if (!res.ok) throw new Error("æ›´æ–°ã«å¤±æ•—");
    console.log("âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã‚’DBã«åæ˜ ã—ã¾ã—ãŸ");
  } catch (err) {
    console.error("âŒ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è¨­å®šå¤±æ•—:", err);
  }
}

	
	// ===== ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ =====
	let swipeWords = [];      // ä»Šã®ãƒ‘ãƒ¼ãƒˆã®å˜èªé…åˆ—ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ï¼‰
	let swipeIndex = 0;       // å…ˆé ­ã‹ã‚‰ä½•æšç›®ã‹
	let swipeLearned = 0;     // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã€Œè¦šãˆãŸã€ã«ã—ãŸæ•°
	let swipeUnlearned = 0;   // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã€Œè¦šãˆã¦ãªã„ã€ã«ã—ãŸæ•°
	let swipeDrag = null;     // {startX, startY, el}
	// æ—¢å­˜ã®ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨å¤‰æ•°ã®è¿‘ãã«è¿½åŠ 
	let currentSwipeMode = "unlearned"; // 'unlearned' or 'review'
	const SWIPE_THRESHOLD = 80; // ä½•pxä»¥ä¸Šã§ç¢ºå®šã¨ã¿ãªã™
	const AD_EVERY = 7;         // 7ã‚¹ãƒ¯ã‚¤ãƒ—æ¯ã«åºƒå‘Š
	
	// ğŸ”¸ ä»Šæ—¥ã®æ—¥ä»˜ã‚­ãƒ¼
	function swipeTodayKey(userId){
	  const d = new Date();
	  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
	  return `swipeExcluded:${userId}:${ymd}`;   // ä¾‹: swipeExcluded:1:2025-08-24
	}
	
	function todayKey(type){
		  const d = new Date();
		  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
		  return `swipe:${type}:${getUserId()}:${ymd}`;
		}

		function getTodaySet(type){
		  const raw = localStorage.getItem(todayKey(type));
		  return new Set(raw ? JSON.parse(raw) : []);
		}

		function addTodaySet(type, wordId){
		  const set = getTodaySet(type);
		  set.add(wordId);
		  localStorage.setItem(todayKey(type), JSON.stringify([...set]));
		}


	// ğŸ”¸ ä»Šæ—¥ã®é™¤å¤–ã‚»ãƒƒãƒˆã‚’å–å¾— / è¿½åŠ ä¿å­˜
	function getSwipeExcludedSet(userId){
	  // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰è‡ªå‹•çš„ã«ãƒªã‚»ãƒƒãƒˆï¼ˆã‚­ãƒ¼ã‚‚å¤‰ã‚ã‚‹ï¼‰
	  const raw = localStorage.getItem(swipeTodayKey(userId));
	  return new Set(raw ? JSON.parse(raw) : []);
	}
	function addToSwipeExcluded(userId, wordId){
	  const key = swipeTodayKey(userId);
	  const set = getSwipeExcludedSet(userId);
	  set.add(wordId);
	  localStorage.setItem(key, JSON.stringify([...set]));
	}
	
	function setSwipeModeVisible(show){
		  document.getElementById('swipeModeBox').classList.toggle('hidden', !show);
		  // ä¸€è¦§ç³»ã‚’éš ã™/æˆ»ã™
		  document.getElementById('wordContainer').classList.toggle('hidden', show);
		  document.getElementById('pagination').classList.toggle('hidden', show);
		  const pagTop = document.getElementById('paginationTop');
		  if (pagTop) pagTop.classList.toggle('hidden', show);
		  document.getElementById('test-section').classList.toggle('hidden', show);
		  document.getElementById('weeklyAnswersBox').classList.toggle('hidden', show);
		}

	// âœ… ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’é–‹å§‹æ™‚ï¼šæœ€åˆã«åºƒå‘Š â†’ çµ‚äº†å¾Œãƒ¢ãƒ¼ãƒ‰é¸æŠ
	function startSwipeMode(partValue = selectedPart){
	  selectedPart = partValue;

	  const lockedParts = ["part4", "part5", "part6", "partHealing", "musou"];
	  const isLocked = lockedParts.includes(selectedPart);
	  if(!user.premium && isLocked && !isAdEnabled()){
	    showPremiumPopup();
	    return;
	  }

	  // âœ… é–‹å§‹æ™‚ã«åºƒå‘Šè¡¨ç¤º
	  Swal.fire({
	    title: "ç¾å¥³ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ğŸ€",
	    html: "ã€Œå­¦ç¿’é–‹å§‹å‰ã¨çµ‚äº†æ™‚ã«åºƒå‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆè¨ˆ2å›ï¼‰<br>ç¾å¥³ã¨ä¸€ç·’ã«æ¥½ã—ãå­¦ç¿’ã—ã¾ã—ã‚‡ã†ï¼ã€",
	    icon: "info",
	    confirmButtonText: "åºƒå‘Šã‚’è¦‹ã‚‹",
	    confirmButtonColor: "#e91e63",
	    allowOutsideClick: false
	  }).then(() => {
	    // å®Ÿéš›ã«åºƒå‘Šè¡¨ç¤ºï¼ˆã“ã“ã§AdMobç­‰ã®å‹•ç”»åºƒå‘Šã‚’å†ç”Ÿã™ã‚‹ï¼‰
	    watchAdGlobal();

	    // çµ‚äº†å¾Œã«ãƒ¢ãƒ¼ãƒ‰é¸æŠã¸
	    showSwipeModeSelection();
	  });
	}

	// âœ… ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆåˆ†é›¢ã—ã¦ä½¿ã„ã‚„ã™ãï¼‰
	function showSwipeModeSelection() {
	  Swal.fire({
	    title: "ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
	    html: `
	      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
	        <button id="btnUnlearned" class="swal2-confirm swal2-styled">æœªå­¦ç¿’ã‚’è¦šãˆã‚‹</button>
	        <button id="btnReview" class="swal2-confirm swal2-styled" style="background:#3949ab">å¾©ç¿’ãƒã‚§ãƒƒã‚¯</button>
	      </div>
	    `,
	    showConfirmButton: false,
	    didOpen: () => {
	      document.getElementById("btnUnlearned").onclick = () => {
	        currentSwipeMode = "unlearned";
	        Swal.close();
	        initSwipeMode("unlearned");
	      };
	      document.getElementById("btnReview").onclick = () => {
	        currentSwipeMode = "review";
	        Swal.close();
	        initSwipeMode("review");
	      };
	    }
	  });
	}



	// æ—¢å­˜ã® initSwipeMode ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ
	async function initSwipeMode(mode = "unlearned"){
	  currentSwipeMode = mode;
	  setSwipeModeVisible(true);

	  const userId = getUserIdFromQuery() || 1;
	  if (!Array.isArray(words) || words.length === 0) {
	    words = await fetchWordsFromServer(userId, selectedPart);
	  }

	  // ãƒ‡ãƒƒã‚­ä½œæˆï¼ˆæœªå­¦ç¿’30 / å¾©ç¿’30 / ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯25+5ï¼‰
	  swipeWords = await buildSwipeDeck(mode);

	  if (swipeWords.length === 0) {
	    const msg = (mode === "review")
	      ? "ä»Šæ—¥ã¯å¾©ç¿’ç”¨ã®å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
	      : "ä»Šæ—¥ã¯å‡ºé¡Œã™ã‚‹æœªå­¦ç¿’ãŒã‚ã‚Šã¾ã›ã‚“";
	    Swal.fire({icon:'info', title: msg, text:'ãƒ‘ãƒ¼ãƒˆå¤‰æ›´ã‚„æ˜æ—¥ã¾ãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã­ï¼'});
	    setSwipeModeVisible(false);
	    return;
	  }

	  swipeIndex = 0;
	  swipeLearned = 0;   // æœªå­¦ç¿’: è¦šãˆãŸ / å¾©ç¿’: OK
	  swipeUnlearned = 0; // æœªå­¦ç¿’: è¦šãˆã¦ãªã„ / å¾©ç¿’: å¿˜ã‚Œã¦ã„ãŸ

	  await renderSwipeDeck();
	  updateSwipeHUD();
	  document.getElementById('swipeExitBtn').onclick = exitSwipeMode;
	}

	function exitSwipeMode(){
	  setSwipeModeVisible(false);                      // â† ä¸€è¦§ã¸æˆ»ã™
	  renderWords();
	  updateStatusCount();
	}

		
		// ğŸ”¸ ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ãƒ‡ãƒƒã‚­ã‚’çµ„ã‚€ï¼ˆæœªå­¦ç¿’ã®ã¿ + ä»Šæ—¥ã®é™¤å¤–ã‚’å¼•ãï¼‰
// ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆFisherâ€“Yatesï¼‰
// ãƒ©ãƒ³ãƒ€ãƒ ã«é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆin-placeï¼‰
// in-place shuffle
function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/**
 * æœªå­¦ç¿’ã‚’å„ªå…ˆã—ã¦ N æšã§ãƒ‡ãƒƒã‚­æ§‹ç¯‰ï¼ˆæœªå­¦ç¿’:reviewRatio[0], å¾©ç¿’:reviewRatio[1]ï¼‰
 * è¶³ã‚Šãªã„ã¨ãã¯ç›¸äº’ã«èé€šã—ã€ãã‚Œã§ã‚‚è¶³ã‚Šãªã‘ã‚Œã°é™¤å¤–ç„¡è¦–ã§è£œå……
 */
//shuffle ã¯ãã®ã¾ã¾åˆ©ç”¨

//æ—¢å­˜ã® buildSwipeDeck ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ
async function buildSwipeDeck(mode = "unlearned"){
  const userId   = getUserIdFromQuery() || getUserId();
  const excluded = getSwipeExcludedSet(userId);

  const allUnlearned = words.filter(w => !w.status);
  const allLearned   = words.filter(w =>  w.status);

  // æ—¢å®šã¯ã€Œä»Šæ—¥ã®é™¤å¤–ã‚’å¤–ã™ã€
  let unlearned = allUnlearned.filter(w => !excluded.has(w.id));
  let learned   = allLearned.filter(w   => !excluded.has(w.id));

  // â˜… å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§å€™è£œ0ãªã‚‰ã€é™¤å¤–ã‚’ç„¡è¦–ã—ã¦ã§ã‚‚å‡ºã™ï¼ˆèµ·å‹•ã§ããªã„ã®ã‚’é˜²ãï¼‰
  if (mode === "review" && learned.length === 0 && allLearned.length > 0) {
    learned = allLearned.slice();
  }

  shuffle(unlearned);
  shuffle(learned);

  if (mode === "unlearned") return shuffle(unlearned.slice(0, 10));
  if (mode === "review")    return shuffle(learned.slice(0, 10));

  return shuffle([
    ...unlearned.slice(0,25),
    ...learned.slice(0,5)
  ]);
}




	// ãƒ‡ãƒƒã‚­æç”»ï¼ˆå…ˆé ­3æšã ã‘ç©ã‚€ï¼‰
// ãƒ‡ãƒƒã‚­æç”»ï¼ˆå…ˆé ­3æšã ã‘ç©ã‚€ï¼‰
async function renderSwipeDeck(){
  // DOMã®ãƒ‡ãƒƒã‚­è¦ç´ 
  const deckEl = document.getElementById('swipeDeck');
  deckEl.innerHTML = '';

  // swipeWords ãŒã¾ã ç”¨æ„ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½œã‚‹
if (!Array.isArray(swipeWords) || swipeWords.length === 0) {
	// ç¾åœ¨é¸æŠä¸­ã®ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒƒã‚­ã‚’ä½œã‚‹
	swipeWords = await buildSwipeDeck(currentSwipeMode);
	console.log('deck size:', swipeWords.length,
            'unlearned total:', words.filter(w=>!w.status).length,
            'learned total:', words.filter(w=> w.status).length);
}

  // ä»Šã®ä½ç½®ã‹ã‚‰3æšã ã‘æç”»
  const show = swipeWords.slice(swipeIndex, Math.min(swipeIndex + 3, swipeWords.length));

  show.forEach((w, idx) => {
    const card = document.createElement('div');
    card.className = 'swipe-card';
    card.style.zIndex = String(100 - idx);
    card.dataset.index = String(swipeIndex + idx);

    const src = imageUrlForWord(w);

    card.innerHTML = `
    	  <div class="swipe-badge badge-left">è¦šãˆã¦ãªã„</div>
    	  <div class="swipe-badge badge-right">è¦šãˆãŸï¼</div>
    	  <div class="swipe-word">${w.word}</div>
    	  <div class="swipe-mean">(${w.meaning})</div>
    	  <img class="swipe-img" src="${src}" alt="" draggable="false">
    	`;

    // ç”»åƒãŒ404ã®æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const imgEl = card.querySelector('.swipe-img');
    imgEl.onerror = () => { imgEl.src = '/images/beauty.png'; };

    attachSwipeHandlers(card);
    deckEl.appendChild(card);
  });
}


	// 1æšã®ã‚«ãƒ¼ãƒ‰ã«ãƒ‰ãƒ©ãƒƒã‚°/ã‚¿ãƒƒãƒæ“ä½œã‚’ä»˜ä¸
function attachSwipeHandlers(card){
  card.addEventListener('pointerdown', e => {
    e.preventDefault();                 // â† æ—¢å®šå‹•ä½œ(ç”»åƒãƒ‰ãƒ©ãƒƒã‚°ç­‰)ã‚’æŠ‘æ­¢
    card.setPointerCapture(e.pointerId);
    swipeDrag = {startX:e.clientX, startY:e.clientY, el:card};
    card.style.transition = 'none';
  });

  card.addEventListener('pointermove', e => {
    if(!swipeDrag || swipeDrag.el!==card) return;
    const dx = e.clientX - swipeDrag.startX;
    const dy = e.clientY - swipeDrag.startY;
    const rot = dx * 0.05;
    card.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;
    const left  = card.querySelector('.badge-left');
    const right = card.querySelector('.badge-right');
    if(dx < -20){ left.style.opacity = Math.min(1, (-dx)/80); right.style.opacity = 0; }
    else if(dx > 20){ right.style.opacity = Math.min(1, (dx)/80); left.style.opacity = 0; }
    else { left.style.opacity = right.style.opacity = 0; }
  });

  card.addEventListener('pointerup',     e => endSwipe(card, e));

  // â† ã“ã“ã‚’â€œãƒªã‚»ãƒƒãƒˆã®ã¿â€ã«
  card.addEventListener('pointercancel', () => {
    card.style.transition = '.2s ease';
    card.style.transform = 'translate(0,0) rotate(0)';
    card.querySelector('.badge-left').style.opacity  = 0;
    card.querySelector('.badge-right').style.opacity = 0;
    swipeDrag = null;
  });

  // å¿µã®ãŸã‚ HTML5 ã® dragstart ã‚‚æ®ºã™
  card.addEventListener('dragstart', e => e.preventDefault());
}


	function endSwipe(card, e){
	  if(!swipeDrag){ return; }
	  const dx = e.clientX - swipeDrag.startX;
	  swipeDrag = null;

	  // ç¢ºå®šåˆ¤å®š
	  if(dx <= -SWIPE_THRESHOLD){
	    // å·¦ï¼šè¦šãˆã¦ãªã„
	    decideSwipe(card, 'left');
	  }else if(dx >= SWIPE_THRESHOLD){
	    // å³ï¼šè¦šãˆãŸ
	    decideSwipe(card, 'right');
	  }else{
	    // æˆ»ã™
	    card.style.transition = '.2s ease';
	    card.style.transform = 'translate(0,0) rotate(0)';
	    card.querySelector('.badge-left').style.opacity = 0;
	    card.querySelector('.badge-right').style.opacity = 0;
	  }
	}

	// åæ˜ ï¼†æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã¸
// æ—¢å­˜ã® decideSwipe ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ
async function decideSwipe(card, dir){
  const i = swipeIndex;
  const w = swipeWords[i];
  const isRight = (dir === 'right'); // å³=è‰¯ã„åˆ¤å®š

  // è¦‹ãŸç›®ã‚¢ãƒ‹ãƒ¡
  card.style.transition = '.2s ease';
  const off = (isRight ? 600 : -600);
  card.style.transform = `translate(${off}px,-40px) rotate(${off>0?15:-15}deg)`;
  setTimeout(() => card.remove(), 200);

  // âœ… DBæ›´æ–°ã¯ã—ãªã„ã€‚ã™ã¹ã¦â€œä»Šæ—¥ã®ãƒ¡ãƒ¢â€ã«ä¿å­˜ã™ã‚‹ã ã‘ã€‚
  if (currentSwipeMode === "unlearned") {
    // æœªå­¦ç¿’ãƒ¢ãƒ¼ãƒ‰: å³=è¦šãˆãŸ, å·¦=è¦šãˆã¦ãªã„
    if (isRight) {
      addTodaySet('learned', w.id);    // å½“æ—¥ã®é”æˆ
      addToSwipeExcluded(getUserId(), w.id); // ä»Šæ—¥ã¯å‡ºã•ãªã„
      swipeLearned++;
    } else {
      addTodaySet('unlearned', w.id);  // å½“æ—¥ã®æœªé”
      swipeUnlearned++;
    }
  } else { // review
    // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰: å³=OK, å·¦=å¿˜ã‚Œã¦ã„ãŸ
    if (isRight) {
      swipeLearned++;                  // ã‚»ãƒƒã‚·ãƒ§ãƒ³OKã‚«ã‚¦ãƒ³ãƒˆ
      addTodaySet('review_ok', w.id);  // ä»»æ„ã®è¨˜éŒ²
    } else {
      swipeUnlearned++;                // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¿˜ã‚Œã‚«ã‚¦ãƒ³ãƒˆ
      addTodaySet('review_ng', w.id);  // ä»»æ„ã®è¨˜éŒ²
      // ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰å¿˜ã‚Œã¦ã„ãŸã‚‚ã®ã‚’â€œæ˜æ—¥ã®æœªå­¦ç¿’å€™è£œâ€ã«ã—ãŸã„ãªã‚‰ã€ã“ã“ã§åˆ¥ã‚­ãƒ¼ã«ä¿å­˜ã—ã¦ãŠã
    }
    addToSwipeExcluded(getUserId(), w.id); // å¾©ç¿’ã§ã‚‚ä»Šæ—¥ã¯é‡è¤‡ã•ã›ãªã„
  }

  swipeIndex++;
  updateSwipeHUD();
  
//âœ… åºƒå‘Šè¡¨ç¤ºï¼š7æšã”ã¨ã€ã¾ãŸã¯æœ€å¾Œã®1æš
  if (swipeIndex === swipeWords.length) {
  watchAdGlobal();
  }

  if (swipeIndex < swipeWords.length) {
    await renderSwipeDeck();
  } else {
    exitSwipeMode(); // ä¸€è¦§ã¸æˆ»ã‚‹ï¼ˆDBæ›´æ–°ãªã—ï¼‰
  }
}



//æ—¢å­˜ã® updateSwipeHUD ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ
function updateSwipeHUD(){
  const total = swipeWords.length;
  document.getElementById('swipeCounter').textContent = `${swipeIndex}/${total}`;

  if (currentSwipeMode === "unlearned") {
    // å½“æ—¥ãƒ¡ãƒ¢ï¼ˆæœªå­¦ç¿’ç”¨ï¼‰
    const learnedSet   = getTodaySet('learned');
    const unlearnedSet = getTodaySet('unlearned');
    document.getElementById('swipeStats').textContent =
      `è¦šãˆãŸ: ${learnedSet.size} / è¦šãˆã¦ãªã„: ${unlearnedSet.size}`;
  } else {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå¾©ç¿’ç”¨ï¼‰
    document.getElementById('swipeStats').textContent =
      `OK: ${swipeLearned} / å¿˜ã‚Œã¦ã„ãŸ: ${swipeUnlearned}`;
  }
}




	// ã‚‚ã—ã€Œã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ã€ãƒœã‚¿ãƒ³ã‚’ã©ã“ã‹ã«è¿½åŠ ã™ã‚‹ãªã‚‰ï¼š
	// <button onclick="startSwipeMode()">ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ã‚’å§‹ã‚ã‚‹</button>
    async function onSwipeRightLearned(word){
  // 1) ã‚µãƒ¼ãƒã«å­¦ç¿’æ¸ˆã¿ã‚’åæ˜ ï¼ˆæ—¢å­˜ã®æ›´æ–°APIã‚’ä½¿ã†ï¼‰
  try{
    await fetch('/api/learning/update', {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        userId: getUserId(),
        wordId: word.id,
        status: true,
        part: selectedPart
      })
    });
    // 2) ãƒ•ãƒ­ãƒ³ãƒˆã® words ã‚‚å³æ™‚æ›´æ–°
    const w = words.find(x => x.id === word.id);
    if (w) w.status = true;

    // 3) ä»Šæ—¥ã®ã‚¹ãƒ¯ã‚¤ãƒ—é™¤å¤–ã«è¿½åŠ ï¼ˆæ¬¡ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã¯å‡ºãªã„ï¼‰
    addToSwipeExcluded(getUserId(), word.id);
  }catch(e){
    console.warn('å­¦ç¿’æ¸ˆã¿åæ˜ å¤±æ•—', e);
  }
}
    
    const SWIPE_TUTOR_KEY = 'swipe_tutorial_shown_v1';

    function showSwipeHowToIfNeeded(){
      if (localStorage.getItem(SWIPE_TUTOR_KEY) === '1') return;
      Swal.fire({
        title: 'ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ã®ã‚³ãƒ„',
        html: `
          <div style="text-align:left;line-height:1.8">
            <p>ãƒ»å³ã‚¹ãƒ¯ã‚¤ãƒ— = <b>è¦šãˆãŸï¼â†’ å­¦ç¿’æ¸ˆã¿ã«åæ˜ </b></p>
            <p>ãƒ»å·¦ã‚¹ãƒ¯ã‚¤ãƒ— = ã¾ã è¦šãˆã¦ãªã„ï¼ˆãƒ‡ãƒƒã‚­å¾Œæ–¹ã¸ï¼‰</p>
            <p>ãƒ»ä»Šæ—¥è¦šãˆãŸå˜èªã¯ã€<b>ãã®æ—¥ã¯å†è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</b></p>
            <p>ãƒ»å¯¾è±¡ã¯ <b>æœªå­¦ç¿’ã ã‘</b>ã€‚åŠ¹ç‡ã‚ˆãè¦šãˆã‚ˆã†ï¼</p>
          </div>
        `,
        confirmButtonText: 'OK',
        confirmButtonColor: '#e91e63'
      }).then(()=> localStorage.setItem(SWIPE_TUTOR_KEY,'1'));
    }


	</script>
ã€€ã€€<!-- ã‚«ã‚¹ã‚¿ãƒ åºƒå‘Šãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="adModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div class="modal-content" style="background:white; padding:30px; border-radius:10px; max-width:90%; text-align:center;">
    <h2 style="color:#e91e63;"><i class="fas fa-info-circle"></i> ã“ã®ãƒ‘ãƒ¼ãƒˆã¯åºƒå‘Šè¦–è´ãŒå¿…è¦ã§ã™</h2>
    <p>åºƒå‘Šã‚’è¦‹ã‚‹ã¨5æšã ã‘ç¾å¥³ã§è‹±å˜èªã‚’è¡¨ç¾ã™ã‚‹ãƒœã‚¿ãƒ³ãŒé–‹æ”¾ã•ã‚Œã¾ã™ã€‚<br>æœ‰æ–™ãƒ—ãƒ©ãƒ³ãªã‚‰ç„¡åˆ¶é™ã§é–‹æ”¾ã•ã‚Œã¾ã™ã€‚</p>
    <div class="modal-buttons" style="margin-top:20px;">
      <button id="watchAdBtn" class="btn btn-primary" onclick="handleAdAccept()">åºƒå‘Šã‚’è¦‹ã‚‹</button>
      <button id="closeModalBtn" class="btn btn-secondary" onclick="closeAdModal()">ã‚„ã‚ã‚‹</button>
      <button id="upgradeBtn" class="btn btn-premium" onclick="location.href='/premium.html'">ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã§ç„¡åˆ¶é™é–‹æ”¾ (æœˆé¡300å††)ğŸ€</button>
    </div>
  </div>
</div>
	</body>
	</html>
