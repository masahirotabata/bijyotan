<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç¾å¥³å˜èªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</title>
 <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">


  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
      background: rgb(249, 249, 249);
    }

    h1, h3 {
      text-align: center;
      color: rgb(233, 30, 99);
    }

    #username, #plan {
      display: block;
      text-align: center;
      margin: 10px 0;
      font-size: 1.1em;
    }
    
/* ç”»é¢ã‚’ç‹­ã‚ã‚‹ï¼šä¸»è¦ãƒ–ãƒ­ãƒƒã‚¯ã¯æœ€å¤§å¹…ã‚’çµ±ä¸€ã—ã¦ä¸­å¤®ã« */
#levelGirlContainer, #partButtons, #statsBox, #test-section, #weeklyAnswersBox, #wordContainer, #pagination, #partPagination  {
  max-width: 420px;
  margin-left: auto;
  margin-right: auto;
}

/* å˜èªã‚«ãƒ¼ãƒ‰ï¼šãƒ‡ãƒ•ã‚©ã‚‚å°‘ã—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
.word-card{
  padding: 10px 12px;
  margin: 10px auto;
}

/* ç”»åƒã‚’å°ã•ã‚å›ºå®šæ¯”ç‡ã« */
.word-card img{
  width: 88px;
  height: 132px;          /* 3:2ï½3:5ç¨‹åº¦ã«åã‚ã‚‹ */
  object-fit: cover;
  border-radius: 8px;
}

/* ===== ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– ===== */
@media (max-width: 480px){

   body.swipe-open{ overflow:hidden; }               /* èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åœæ­¢ */

  #swipeModeBox.fullscreen{
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;            /* æ—§ç«¯æœ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
    height: 100svh;           /* iOS 15+ */
    height: 100dvh;           /* æ–°ã—ã„å‹•çš„vh */
    background:#fff;
    z-index: 10000;
    margin: 0;
    padding:
      max(8px, env(safe-area-inset-top))
      8px
      max(10px, env(safe-area-inset-bottom));
    display: grid;
    grid-template-rows: auto 1fr auto;  /* ä¸Š:HUD / ä¸­:ãƒ‡ãƒƒã‚­ / ä¸‹:ãƒ’ãƒ³ãƒˆ */
    gap: 6px;
  }

  /* ä¸­å¤®ã®ãƒ‡ãƒƒã‚­ã¯æ®‹ã‚Šé ˜åŸŸã‚’ãƒ•ãƒ«ã§ä½¿ã† */
  #swipeDeck{ height: auto; display: grid; align-items: center; }

  /* ã‚«ãƒ¼ãƒ‰ã‚’ç”»é¢ã„ã£ã±ã„ã«æ‹¡å¤§ï¼ˆã¯ã¿å‡ºã•ãªã„ã‚ˆã† clampï¼‰ */
  .swipe-card{
    width: min(92vw, 560px);
    height: clamp(320px, 74dvh, 720px);
  }

  /* HUD/ãƒ’ãƒ³ãƒˆã‚’å›ºå®šã£ã½ãè¦‹ã›ã‚‹ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãšã‚Œãªã„ï¼‰ */
  .swipe-hud{ position: sticky; top: 0; background:#fff; padding-bottom: 4px; }
  .swipe-hints{ position: sticky; bottom: 0; background:#fff; padding-top: 4px; }

  /* ä»¥å‰ã®ã€Œå…¨ãƒœã‚¿ãƒ³å¹…90%ã€ã‚’ã‚„ã‚ã‚‹ï¼šç¸¦ã®ä¼¸ã³é˜²æ­¢ */
  button{ font-size: 0.95rem; padding: 10px; }

  /* å¿…è¦ãªå ´æ‰€ã ã‘å¹…åºƒãƒœã‚¿ãƒ³ã«ã™ã‚‹ */
  #wordContainer .word-card button,
  #swipeStartBtn,
  #swipeModeBox .swipe-hud button {
    width: 100%;
    max-width: 320px;
  }

  /* å˜èªã‚«ãƒ¼ãƒ‰ï¼š2ã‚«ãƒ©ãƒ åŒ–ã§ç¸¦é•·ã‚’è§£æ¶ˆ */
  .word-card{
    display: grid;
    grid-template-columns: 88px 1fr;
    grid-template-areas:
      "img text"
      "img action";
    align-items: center;
    gap: 8px 10px;
    font-size: 0.95rem;
  }
  .wc-img{ grid-area: img; }
  .wc-body{ grid-area: text; }
  .wc-actions{ grid-area: action; }

  .word-card strong{ display:block; margin-bottom: 4px; font-size: 1rem; }
  .word-card .meta{ color:#666; font-size: .85rem; margin-bottom: 4px; }

  /* ãƒ’ãƒ¼ãƒ­ãƒ¼ã®å¥³ã®å­å‹•ç”»ã®é«˜ã•ã‚’æŠ‘ãˆã‚‹ */
  #levelGirlContainer video{ width: 160px; }
  #statsBox{ padding: 12px; }
  #weeklyAnswersBox{ padding: 0 4px; }
}


    .locked {
      background: #ffdddd;
      padding: 10px;
      text-align: center;
    }
    
    .musou-card {
	  background: #fff5f5;
	  border: 1px solid #f48fb1;
	  border-radius: 10px;
	  padding: 10px;
	  margin: 10px 0;
	}
    

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      background-color:#e91e63;
      color: white;
      font-size: 1rem;
      margin: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #f50057;
    }
    
#user-info {
  text-align: left; /* â† ä¸­å¤®ã‹ã‚‰å·¦å¯„ã›ã«å¤‰æ›´ */
  margin: 10px 0 20px;
  font-size: 1.1rem;
  padding-left: 10px;
}

#bgEffect {
  position: absolute;
  width: 180px;
  height: 180px;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  z-index: -1;
}

.star-bg {
  background: radial-gradient(circle, #fff 20%, transparent 70%);
  animation: sparkle 1.5s infinite alternate;
}

.heart-bg{ background: radial-gradient(circle,#ffd1e6 30%, transparent 70%); }

@keyframes sparkle {
  0% { opacity: 0.6; transform: scale(1); }
  100% { opacity: 1; transform: scale(1.05); }
}


#planText {
  text-align: left; /* â† ä¸­å¤®ã‹ã‚‰å·¦å¯„ã›ã«å¤‰æ›´ */
  color: #333;
  font-weight: bold;
}

/* Partãƒœã‚¿ãƒ³ï¼ˆå…±é€šï¼‰ */
#partButtons{
  display:flex;
  gap:8px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  flex-wrap:nowrap;
  justify-content:flex-start; /* PCã§ä¸­å¤®å¯„ã›ã«ä¸Šæ›¸ã */
  padding-top:max(6px, env(safe-area-inset-top));
}
#partButtons button{ flex:0 0 auto; }
    
    #statsBox {
  background: #fff3f8;
  border: 1px solid #ff99c9;
  border-radius: 12px;
  padding: 15px;
  margin: 15px auto;
  max-width: 500px;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.05);
  font-weight: bold;
  font-size: 1rem;
}

#learningStatus {
  text-align: center;
  margin-bottom: 10px;
  color: #333;
}

#subStats {
  display: flex;
  justify-content: space-between;
  font-size: 0.95rem;
  padding: 0 10px;
  color: #555;
}

#subStats div {
  flex: 1;
  text-align: center;
}
    
    
    

    #loginBonusPopup {
      display: none;
      position: fixed;
      top: 10%;
      left: 5%;
      width: 90%;
      height: 75%;
      background: white;
      border: 2px solid #ccc;
      z-index: 9999;
      padding: 20px;
      overflow: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .swal2-popup.premium-popup {
  font-family: 'sans-serif';
  border-radius: 15px;
  padding: 20px;
  max-width: 400px;
}

    #stampGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      gap: 10px;
    }

    #test-section {
      text-align: center;
      margin: 20px 0;
    }

    #videoModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    video {
      width: 90%;
      max-height: 80vh;
    }

  /* å¿…è¦ãªå ´æ‰€ã ã‘å€‹åˆ¥ã«å¹…ã‚’åºƒã’ãŸã„å ´åˆã¯æ˜ç¤ºçš„ã«æŒ‡å®š */
  #swipeStartBtn,
  #swipeModeBox .swipe-hud button {
    width: 90%;
    max-width: 320px;
  }

  /* Partãƒœã‚¿ãƒ³ã‚’æ¨ªä¸€åˆ—ã§ã‚¹ãƒ¯ã‚¤ãƒ—å¯èƒ½ã« */
  #partButtons {
    display: flex;
    gap: 8px;
    overflow-x: auto;           /* â† æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    -webkit-overflow-scrolling: touch;
    flex-wrap: nowrap;          /* æŠ˜ã‚Šè¿”ã•ãªã„ */
    justify-content: flex-start;
    padding-top: max(6px, env(safe-area-inset-top));
  }
  #partButtons button {
    flex: 0 0 auto;             /* åç¸®ã•ã›ãªã„ */
  }

.word-card {
        font-size: 0.9rem;
}
.btn { padding:10px 16px; border-radius:8px; border:none; cursor:pointer; }
.btn-primary { background:#e91e63; color:#fff; }
.btn-secondary { background:#999; color:#fff; }
    
.btn-premium {
    background-color: #e91e63;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    font-size: 1em;
    margin-top: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.btn-premium:hover {
    background-color: #d81b60;
}
  
  /* æ—¢å­˜CSSã®æœ«å°¾ã«è¿½åŠ  */
.hidden{display:none;}

#swipeModeBox{
  max-width:700px;margin:16px auto;padding:10px;
}
#swipeDeck{
  position:relative;height:360px;user-select:none;touch-action:pan-y;
}
.swipe-card{
  position:absolute;inset:0;margin:auto;width:92%;max-width:580px;height:340px;
  background:#fff;border-radius:14px;border:1px solid #eee;
  box-shadow:0 10px 24px rgba(0,0,0,.08);
  padding:18px;display:flex;flex-direction:column;justify-content:center;align-items:center;
  transition:transform .2s ease, opacity .2s ease;
}
.swipe-word{font-size:28px;font-weight:700;margin-bottom:8px;}
.swipe-mean{color:#555;margin-bottom:12px;}
.swipe-img{
  width:220px;height:300px;object-fit:cover;border-radius:10px;background:#f2f2f2;
  -webkit-user-drag: none;      /* Safari/Chrome */
  user-drag: none;
  user-select: none;
  pointer-events: none;          /* â† ãƒ‰ãƒ©ãƒƒã‚°ã®èµ·ç‚¹ã‚’å¸¸ã«ã‚«ãƒ¼ãƒ‰ã«ã™ã‚‹ */
}

.swipe-badge{
  position:absolute;top:12px;font-weight:700;padding:6px 10px;border-radius:8px;opacity:0;
}
.badge-left{left:12px;background:#fde68a;color:#92400e;}     /* è¦šãˆã¦ãªã„ */
.badge-right{right:12px;background:#dcfce7;color:#166534;}    /* è¦šãˆãŸ */

.swipe-hud{display:flex;justify-content:space-between;align-items:center;margin:6px 6px 10px;}
.swipe-hints{display:flex;justify-content:space-between;color:#888;margin-top:6px;padding:0 4px;}
@media (prefers-reduced-motion: reduce){
  .swipe-card{ transition: none; }
  .star-bg{ animation: none; }
  .caption{ display: none !important; }
}

/* ===== Desktop layout improvements ===== */
/* Desktop */

  /* å˜èªã‚«ãƒ¼ãƒ‰ï¼š3ã‚«ãƒ©ãƒ ï¼ˆç”»åƒ / ãƒ†ã‚­ã‚¹ãƒˆ / ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
  .word-card{
    display: grid;
    grid-template-columns: 140px 1fr auto;
    grid-template-areas: "img text action";
    align-items: center;
    gap: 12px 16px;
    padding: 14px 16px;
  }
  .wc-img{ grid-area: img; }
  .wc-body{ grid-area: text; }
  .wc-actions{ grid-area: action; justify-self: end; }

  .word-card img{ width: 140px; height: 210px; }

  /* PCã§ã¯ãƒœã‚¿ãƒ³å¹…ã‚’è‡ªå‹• */
  #test-section button,
  #swipeStartBtn,
  #swipeModeBox .swipe-hud button {
    width: auto;
    max-width: none;
  }

  /* ãƒ‘ãƒ¼ãƒˆãƒœã‚¿ãƒ³/ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­å¤®å¯„ã› */
  #partButtons{ justify-content: center; overflow: visible; flex-wrap: wrap; }
  .pagination{ justify-content: center; overflow: visible; }

/* ãƒ’ãƒ¼ãƒ­ãƒ¼èƒŒæ™¯ã®ãƒ”ãƒ³ã‚¯ä¸¸ã¯ãƒ¢ãƒã‚¤ãƒ«ã ã‘è¡¨ç¤ºã€PCã§ã¯éè¡¨ç¤º */
#levelGirlContainer{ position: relative; }
@media (min-width: 600px){ #bgEffect{ display:none; } }

/* --- Login Bonus modal --- */
/* ã“ã‚Œã«çµ±ä¸€ï¼šJSã§ display ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆflexã¯JSã§å½“ã¦ã‚‹ï¼‰ */
#loginBonusPopup{
  display:none;           /* â† ã“ã“ã¯ none ã®ã¾ã¾ */
  position:fixed;
  inset:4vh 3vw;
  background:#fff;
  border:2px solid #ccc;
  border-radius:12px;
  z-index:9999;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
  padding:12px 12px 0;
  overflow:hidden;
  /* display:flex;  â† å‰Šé™¤ï¼*/
  /* flex-direction:column; â† å‰Šé™¤ï¼*/
}
#stampScroll{
  flex:1;                 /* ã“ã“ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸ */
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:8px 2px 12px;
}
#stampGrid{
  display:grid;
  grid-template-columns: repeat(6, minmax(50px,1fr));
  gap:10px;
}
#loginBonusOkBtn{
  position:sticky; bottom:0;
  margin:8px auto calc(env(safe-area-inset-bottom) + 8px);
  width:min(380px, 90%);
}

/* æœ«å°¾ã«è¿½è¨˜ï¼šä½ç½®ã‚’è©°ã‚ã‚‹ */
#swipeModeBox{
  margin: 8px auto 0 !important;   /* ä¸Šã®ä½™ç™½ã‚’å°ã•ã */
}
#swipeDeck{
  height: 340px !important;        /* ã‚ãšã‹ã«æµ…ãã—ã¦ç”»é¢ä¸Šå¯„ã› */
}
.swipe-hud{ margin: 4px 6px 8px !important; }

/* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯åˆ—æ•°ã‚’æ¸›ã‚‰ã—OKã‚’æŠ¼ã—ã‚„ã™ã */
@media (max-width:480px){
  #stampGrid{ grid-template-columns: repeat(4, minmax(56px,1fr)); }
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«æ™‚ã¯èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹ */
body.modal-open{ overflow:hidden; height:100vh; }

/* CSSã®ä¸€ç•ªæœ€å¾Œã«è¿½åŠ ï¼ˆã‚¹ãƒãƒ›å…¨ç”»é¢æ™‚ã®â€œå‹ã¡â€ãƒ«ãƒ¼ãƒ«ï¼‰ */
@media (max-width:480px){
  #swipeModeBox.fullscreen .swipe-card{
    height: clamp(320px, 74dvh, 720px) !important;
    width: min(92vw, 560px);
  }
  #swipeModeBox.fullscreen #swipeDeck{
    height: auto !important;
    min-height: 74dvh; /* å¿µã®ãŸã‚ */
  }
	
  #swipeModeBox:not(.fullscreen) #swipeDeck{
    height: 340px;            /* â† é€šå¸¸è¡¨ç¤ºã®ã¨ãã ã‘é©ç”¨ */
  }
}

/* ===== Centering fixes (override) ===== */
#levelGirlContainer,
#test-section,
#weeklyAnswersBox,
#partButtons,
#wordContainer,
#pagination,
#partPagination {
  margin-left: auto !important;
  margin-right: auto !important;
  text-align: center !important;
}

#partButtons { justify-content: center !important; }
#test-section button, #swipeStartBtn { width: min(320px, 90%); }

/* ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã« */
#test-section{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
#test-section button{
  width:auto !important;   /* ä¸Šã® â€œå¹…100%â€ æŒ‡å®šã‚’æ‰“ã¡æ¶ˆã™ */
}

button:focus-visible { outline: 3px solid #e91e63; outline-offset: 2px; }

/* pagination condensed */
.pagination .ellipsis{
  padding: 0 6px;
  color:#888;
  align-self:center;
}
.pagination button.active{
  background-color:#d81b60;
  font-weight:700;
}
.pagination button[disabled]{
  opacity:.5;
  cursor: default;
}

	
  #partButtons{ justify-content: center; overflow: visible; flex-wrap: wrap; }
  .pagination{ justify-content: center; overflow: visible; }

  /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚‚æ¨ªä¸¦ã³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§çœã‚¹ãƒšãƒ¼ã‚¹ */
  .pagination{
    display:flex;
    gap:8px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    flex-wrap:nowrap;
    justify-content:center;
    padding:6px 2px;
  }
  .pagination button{
    flex:0 0 auto;
    min-width:44px;
    height:36px;
  }
  #partPagination, .pagination{
    display:flex;
    justify-content:center;
    width:100%;
    max-width:420px;
    margin:0 auto;
  }

  /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…±é€š/å‡ç¸®ï¼‰ */
.pagination{
  display:flex;
  gap:8px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  flex-wrap:nowrap;
  justify-content:center;
  padding:6px 2px;
}
	  
.pagination .ellipsis{ padding:0 6px; color:#888; align-self:center; }
.pagination button.active{ background-color:#d81b60; font-weight:700; }
.pagination button[disabled]{ opacity:.5; cursor:default; }

@media (min-width: 768px){
  /* å˜èªã‚«ãƒ¼ãƒ‰ï¼š3ã‚«ãƒ©ãƒ ï¼ˆç”»åƒ / ãƒ†ã‚­ã‚¹ãƒˆ / ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ */
  .word-card{
    display: grid;
    grid-template-columns: 140px 1fr auto;
    grid-template-areas: "img text action";
    align-items: center;
    gap: 12px 16px;
    padding: 14px 16px;
  }
  .wc-img{ grid-area: img; }
  .wc-body{ grid-area: text; }
  .wc-actions{ grid-area: action; justify-self: end; }

  .word-card img{ width: 140px; height: 210px; }

  #test-section button,
  #swipeStartBtn,
  #swipeModeBox .swipe-hud button {
    width: auto;
    max-width: none;
  }
}
ã€€/* === ã‚¹ã‚¯ã‚·ãƒ§å†ç¾ç”¨ã®æœ€çµ‚ä¸Šæ›¸ã === */

/* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼šå¹…ã¨å·¦å¯„ã› */
@media (min-width: 768px){
  /* çµ±ä¸€å¹…ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ ã‚„é€±é–“ã‚°ãƒ©ãƒ•ã¯ä¸­ãã‚‰ã„ã€å˜èªãƒªã‚¹ãƒˆã¯åºƒã‚ */
  #statsBox{ max-width: 760px; }
  #weeklyAnswersBox{ max-width: 760px; }
  #wordContainer{ max-width: 920px; text-align: initial !important; }
  #pagination{ max-width: 920px; }

  /* å˜èªã‚«ãƒ¼ãƒ‰ï¼šç”»åƒ/æœ¬æ–‡/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .word-card{
    display: grid;
    grid-template-columns: 140px 1fr auto;
    grid-template-areas: "img text action";
    align-items: center;
    gap: 12px 16px;
    padding: 14px 16px;
  }
  .wc-img{ grid-area: img; }
  .wc-body{ grid-area: text; text-align: left; }
  .wc-actions{ grid-area: action; justify-self: end; }

  .word-card img{ width: 140px; height: 210px; object-fit: cover; border-radius: 8px; }
}

/* ãƒ¢ãƒã‚¤ãƒ«ï¼š2ã‚«ãƒ©ãƒ ã§ç¸¦é•·ã‚’è§£æ¶ˆï¼ˆæ—¢å­˜ã¨åŒæ–¹å‘ã®ä¸Šæ›¸ãï¼‰ */
@media (max-width: 480px){
  #wordContainer{ max-width: 420px; text-align: initial !important; }

  .word-card{
    display: grid;
    grid-template-columns: 88px 1fr;
    grid-template-areas:
      "img text"
      "img action";
    align-items: center;
    gap: 8px 10px;
    padding: 10px 12px;
  }
  .wc-img{ grid-area: img; }
  .wc-body{ grid-area: text; text-align: left; }
  .wc-actions{ grid-area: action; justify-self: start; }

  .word-card img{ width: 88px; height: 132px; object-fit: cover; border-radius: 8px; }
}

/* ãƒ‘ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼†ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®è¦‹ãŸç›®ï¼ˆãƒ”ãƒ«å‹/ä¸­å¤®å¯„ã›ï¼‰ */
#partButtons{ justify-content: center !important; overflow: visible; flex-wrap: wrap; }
#partButtons button,
.pagination button{
  border-radius: 9999px;
  padding: 10px 16px;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ ã®è‰²å‘³ã¯ã‚¹ã‚¯ã‚·ãƒ§æº–æ‹ ã®ãƒ”ãƒ³ã‚¯ç³»ã« */
h1, h3, #learningStatus{ color: #e91e63; }

/* å˜èªã‚«ãƒ¼ãƒ‰å†…ã®æ–‡å­—ã‚µã‚¤ã‚ºã¨ä½™ç™½ã‚’å¾®èª¿æ•´ */
.word-card strong{ display:block; margin-bottom: 4px; font-size: 1rem; }
.word-card .meta{ color:#666; font-size:.85rem; margin-bottom:4px; }

/* â€œä¸­å¤®å¯„ã›å¼·åˆ¶â€ã‚’æ‰“ã¡æ¶ˆã—ï¼ˆæ—¢å­˜ã® !important ã«å‹ã¤ãŸã‚å†å®£è¨€ï¼‰ */
#wordContainer, #wordContainer *{ text-align: initial !important; }

/* === Weekly chart (screenshot style) === */
#weeklyAnswersBox{ max-width:760px; margin:20px auto; }
.weekly-wrap{
  background:#fff3f8; border:1px solid #ff99c9; border-radius:12px;
  padding:8px 6px;
}
.weekly-bars{
  display:flex; gap:12px; justify-content:space-between; align-items:flex-end;
  height:160px;
}
.weekly-day{
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
}
.weekly-num{ font-size:.8rem; color:#e91e63; margin-bottom:6px; }
.weekly-bar{
  width:26px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.08);
  background:linear-gradient(180deg,#ff7bbd,#ffb3d9);
}
.weekly-labels{
  display:flex; gap:12px; justify-content:space-between;
  font-size:.8rem; color:#555; margin-top:6px;
}
.weekly-label{ flex:1; text-align:center; }
@media (max-width:480px){
  .weekly-bars{ height:140px; gap:8px; }
  .weekly-bar{ width:22px; }
}

/* --- HOTFIX 2025-09-03 ------------------------------------ */
/* â‘  ãƒœã‚¿ãƒ³ãŒç¸¦æ›¸ãã«ãªã‚‹ã®ã‚’å¼·åˆ¶ã§æ­¢ã‚ã‚‹ï¼ˆæ¨ªæ›¸ãï¼†æŠ˜è¿”ã—ç¦æ­¢ï¼‰ */
.wc-actions button{
  writing-mode: horizontal-tb !important;
  text-orientation: mixed !important;
  transform: none !important;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* â‘¡ é€±é–“ã‚°ãƒ©ãƒ•ãŒã‚¹ãƒãƒ›ã§æ¶ˆãˆã‚‹ã®ã‚’é˜²ãï¼ˆé«˜ã•/è¡¨ç¤ºã®ä¿é™ºï¼‰ */
#weeklyBars, #weeklyLabels { display: flex !important; }
.weekly-bars { min-height: 140px; }
.weekly-bar  { width: 22px; min-height: 6px; }

/* â‘¢ â€œã‚¬ã‚¿ã‚¬ã‚¿â€å¯¾ç­–ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼‹ç”»åƒã®ã‚µã‚¤ã‚ºã‚’å›ºå®š */
html, body { overflow-x: hidden; }
img, video { max-width: 100%; height: auto; }

/* å˜èªã‚«ãƒ¼ãƒ‰ã®ç”»åƒã‚µã‚¤ã‚ºã‚’å›ºå®šï¼ˆå´©ã‚Œé˜²æ­¢ï¼‰ */
.word-card img { width: 88px; height: 132px; object-fit: cover; }

/* â‘£ PCæ™‚ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—ãŒç‹­ããªã‚Šéããªã„ã‚ˆã†ã«å¹…ã‚’ç¢ºä¿ */
@media (min-width: 481px){
  .word-card { grid-template-columns: 110px 1fr 180px; }
}
@media (max-width: 480px){
  .wc-actions { width: 100%; }
  .wc-actions button { width: 100%; }
}

/* ãƒœã‚¿ãƒ³ã‚’å¿…ãšæ¨ªæ›¸ããƒ»1è¡Œãƒ»ã‚°ãƒªãƒƒãƒ‰ã®å°‚ç”¨åˆ—ã« */
.wc-actions{ width:100%; display:flex; flex-direction:column; gap:6px; }
.wc-actions button{
  writing-mode: horizontal-tb !important;
  text-orientation: mixed !important;
  white-space: nowrap;
  width: 100%;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯åŒ–ã—ã¦ãƒœã‚¿ãƒ³ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã« */
.wc-body .meta{ display:block; line-height:1.5; }

/* PCæ™‚ã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—ã®æœ€å°å¹…ã‚’ç¢ºä¿ */
@media (min-width: 481px){
  .word-card{ grid-template-columns: 110px 1fr 180px; }
}

#weeklyBars, #weeklyLabels{ display:flex !important; }
.weekly-bars{ min-height:140px; align-items:flex-end; }
.weekly-bar { width:22px; min-height:6px; }
@media (min-width:481px){ .weekly-bars{ min-height:160px; } .weekly-bar{ width:26px; } }


/* â‘¤ å¿µã®ãŸã‚å…¨ãƒœã‚¿ãƒ³ã‚‚å¼·åˆ¶æ¨ªæ›¸ã */
button { writing-mode: horizontal-tb; }

/* --- å›ºå®šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒœã‚¿ãƒ³â€œã‚¬ã‚¿ã‚¬ã‚¿â€é˜²æ­¢ï¼‰ --- */
:root{
  --card-img-w: 88px;
  --card-img-h: 132px;
  --card-action-w: 220px; /* â† ãƒœã‚¿ãƒ³åˆ—ã®å›ºå®šå¹…ï¼ˆPCæ™‚ï¼‰ */
}

/* ç”»åƒã¯å¸¸ã«åŒã˜ã‚µã‚¤ã‚ºã§ç¢ºä¿ï¼ˆèª­ã¿æ›¿ãˆæ™‚ã®æºã‚Œé˜²æ­¢ï¼‰ */
.word-card img{
  width: var(--card-img-w) !important;
  height: var(--card-img-h) !important;
  object-fit: cover;
  border-radius: 8px;
}

/* PCå¹…ã¯ ç”»åƒ / æœ¬æ–‡ / ãƒœã‚¿ãƒ³åˆ— ã®3ã‚«ãƒ©ãƒ ã§ãƒœã‚¿ãƒ³åˆ—ã‚’å›ºå®šå¹…ã« */
@media (min-width: 769px){
  .word-card{
    grid-template-columns: var(--card-img-w) 1fr var(--card-action-w) !important;
    grid-template-areas: "img text action";
  }
  .wc-actions{
    width: var(--card-action-w);
    justify-self: end;
  }
}

/* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ wc-actions ã‚’100%å¹…ã§ç¸¦ç©ã¿ï¼ˆå¹…ã¯ä¸€å®šï¼‰ */
@media (max-width: 768px){
  .wc-actions{ width: 100%; display:flex; flex-direction:column; gap:6px; }
  .wc-actions button{ width: 100%; }
}

/* ãƒœã‚¿ãƒ³ã¯å¿…ãšæ¨ªæ›¸ããƒ»1è¡Œã«ã—ã¦å¹…ãƒ–ãƒ¬é˜²æ­¢ */
.wc-actions button{
  writing-mode: horizontal-tb !important;
  white-space: nowrap;
  display: inline-flex; align-items:center; justify-content:center;
}

/* â€œç”»åƒãƒ‘ã‚¹â€è¡ŒãŒé•·ãã¦æ¨ªå¹…ã‚’æŠ¼ã—åºƒã’ãªã„ã‚ˆã†çœç•¥è¡¨ç¤º */
#wordContainer span[id^="imgpath-"]{
  display:inline-block; max-width:100%;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}

/* --- é€±æ¬¡ã‚°ãƒ©ãƒ•ï¼šã‚¹ãƒãƒ›(ï½768px)ã§ã‚‚å¿…ãšè¡¨ç¤º --- */
@media (max-width: 768px){
  #weeklyAnswersBox{ display:block !important; }
  #weeklyAnswersBox .weekly-wrap{ display:block !important; }
  #weeklyBars, #weeklyLabels{ display:flex !important; }
  .weekly-bars{ min-height:140px !important; gap:8px; }
  .weekly-bar{ width:22px !important; min-height:6px; }
}

  /* ãƒãƒƒã‚¸ã®è¦‹ãŸç›® */
  #cardCounter {
    position:absolute; top:-10px; right:-10px;
    background:#e91e63; color:#fff; font-size:14px; font-weight:700;
    padding:4px 8px; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,.2);
    cursor:pointer; user-select:none; transition:opacity .2s ease;
  }
  /* åºƒå‘ŠæˆåŠŸã§ã®â€œã”è¤’ç¾â€æ¼”å‡ºï¼ˆå¤§ãã‚ï¼†é»„è‰²ã«ç™ºå…‰ï¼‰ */
  @keyframes popGlow {
    0%   { transform:scale(1);   background:#e91e63; box-shadow:0 0 4px rgba(233,30,99,.5); }
    40%  { transform:scale(1.3); background:#ffeb3b; box-shadow:0 0 16px rgba(255,235,59,.9); }
    100% { transform:scale(1);   background:#e91e63; box-shadow:0 0 4px rgba(233,30,99,.5); }
  }
  .pop-glow { animation:popGlow .8s ease-out; }

  /* æ¯å›æ›´æ–°æ™‚ã®è»½ã„ãƒãƒ³æ¼”å‡ºï¼ˆè‰²ã¯å›ºå®šï¼‰ */
  @keyframes popSoft {
    0%   { transform:scale(1); }
    50%  { transform:scale(1.12); }
    100% { transform:scale(1); }
  }
  .pop-soft { animation:popSoft .25s ease-out; }

#cardCounter { transition: transform .18s ease, background-color .18s ease, opacity .18s ease; }
.pop-soft { animation: pop .18s ease; }
.pop-glow { animation: pop .22s ease; background-color: #ffd54f !important; } /* ä¸€ç¬ã”è¤’ç¾è‰² */

#cardCounter.pop-glow { animation: pop .28s ease; box-shadow: inset 0 0 .6rem rgba(255,215,64,.65); }
#cardCounter.pop-soft { animation: pop .2s ease; }
  
  </style>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="loginBonusPopup">
  <h3 id="loginBonusTitle">ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹</h3>
  <div id="stampScroll"><div id="stampGrid"></div></div>
  <button id="loginBonusOkBtn" onclick="closeLoginBonus()">OK</button>
</div>


<div id="user-info">
  <div id="username"></div>
  <div id="planText"></div>
  <div id="userLevel"></div> <!-- â† è¿½åŠ  -->
</div>
<div id="levelGirlContainer" style="text-align:center; margin: 10px 0;">
  <div id="bgEffect" class="star-bg"></div>
  <video id="girlVideo" preload="metadata" autoplay muted loop playsinline width="180" style="border-radius:10px;"></video>
</div>

<!-- ãƒ‘ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ -->
<div id="partButtons"></div>

<!-- è¿½åŠ ï¼šPartç”¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ï¼‰ -->
<div class="pagination" id="partPagination"></div>
<!-- ã“ã‚Œã‚’è¿½åŠ  -->
<div style="text-align:center; margin:6px 0 14px;">
  <button id="swipeStartBtn" onclick="startSwipeMode()">
    ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ã‚’å§‹ã‚ã‚‹
  </button>
</div>
<div id="swipeModeBox" class="hidden">
  <div class="swipe-hud">
    <button id="swipeExitBtn">ä¸€è¦§ã«æˆ»ã‚‹</button>
   <div id="swipeCounter" aria-live="polite">0 / 0</div>
    <div id="swipeStats" aria-live="polite">è¦šãˆãŸ: 0 / è¦šãˆãŸã„: 0</div>
  </div>

  <div id="swipeDeck">
    <!-- ã“ã“ã«ã‚«ãƒ¼ãƒ‰ã‚’é‡ã­ã¦æç”» -->
  </div>

  <div class="swipe-hints">
    <span>â† è¦šãˆã¦ãªã„</span>
    <span>è¦šãˆãŸ â†’</span>
  </div>
</div>


<div id="statsBox">
  <div id="learningStatus" aria-live="polite"></div>
  <div id="subStats">
    <div id="loginDays"></div>
    <div id="testStats"></div>
  </div>
</div>

<!-- åºƒå‘Šã¨èª²é‡‘ -->
<div style="margin: 10px;">
  <button onclick="watchAdGlobal()">åºƒå‘Šã‚’è¦‹ã¦ç¾å¥³ãŒè‹±å˜èªã‚’è¡¨ç¾</button>
</div>
<!-- <div style="margin: 10px;">
  <button onclick="showPremiumPopup()">100å††ã§ãƒ›ãƒƒãƒˆãƒ‘ãƒ³ãƒ„ç¾å¥³è§£æ”¾</button>
</div> -->

<div id="test-section" style="text-align: center; margin: 30px 0;">
<button id="testStartBtn" onclick="startTest()">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹</button>
<button id="testStartBtnVocab" onclick="startVocabularyTest()">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹(å˜èªãƒ¢ãƒ¼ãƒ‰)</button>
<!-- <button onclick="goToPart(getUserId(), 'ç„¡åŒPart')">ç„¡åŒPartã¸</button> -->
</div>
	
<div id="weeklyAnswersBox">
  <h3 style="text-align:center;margin:10px 0;">1é€±é–“ã®è§£ç­”æ•°:(ç›®æ¨™è§£ç­”æ•°:80ãŒç›®å®‰)</h3>
  <div class="weekly-wrap">
    <div id="weeklyBars" class="weekly-bars"></div>
  </div>
  <div id="weeklyLabels" class="weekly-labels"></div>
</div>

<div id="cardWrap" style="position:relative; display:inline-block;">
  <div id="cardCounter">æ®‹ã‚Š 0 æš</div>

  <div id="cardArea" style="width:300px; height:400px; border:1px solid #ccc; border-radius:8px; background:#fff; overflow:hidden;">
    <!-- showNextCard() ãŒã“ã“ã¸ã‚«ãƒ¼ãƒ‰è¦ç´ (ç”»åƒãªã©)ã‚’å·®ã—è¾¼ã‚€ -->
  </div>
</div>
<div id="wordContainer"></div>
<div class="pagination" id="pagination"></div>
<!-- HTMLã®ä¸€ç•ªä¸‹ã«è¿½åŠ  -->
<div id="videoModal" style="display:none; position:fixed; top:0; left:0; 
  width:100%; height:100%; background-color:rgba(0,0,0,0.8); 
  justify-content:center; align-items:center; z-index:999;">
  <video id="videoPlayer" controls autoplay width="80%"></video>
</div>

<script>
// ç½®ãæ›ãˆï¼šapiFetch ã®å…ˆé ­ä»˜è¿‘
const apiFetch = (path, opts = {}) => {
  const method = (opts.method || 'GET').toUpperCase();
  const needsCSRF = !['GET','HEAD','OPTIONS'].includes(method);

  // === CSRF ã‚’è‡ªå‹•æ¤œå‡ºï¼ˆRails or Springä¸¡å¯¾å¿œï¼‰ ===
  const pickCSRFFromPageOrCookie = () => {
    const meta = document.querySelector('meta[name="csrf-token"]')?.content; // Rails
    if (meta) return { header: 'X-CSRF-Token', token: meta };

    const ck = document.cookie;
    const mSpring = ck.match(/(?:^|;\s*)XSRF-TOKEN=([^;]+)/); // Spring
    if (mSpring) return { header: 'X-CSRF-TOKEN', token: decodeURIComponent(mSpring[1]) };

    const mLegacy = ck.match(/(?:^|;\s*)_csrf=([^;]+)/);      // æ—§è¨­å®š
    if (mLegacy) return { header: 'X-CSRF-Token', token: decodeURIComponent(mLegacy[1]) };

    return null;
  };

  const headers = new Headers({ Accept: 'application/json', ...(opts.headers || {}) });
  if (needsCSRF && !headers.has('X-CSRF-Token') && !headers.has('X-CSRF-TOKEN')) {
    const c = pickCSRFFromPageOrCookie();
    if (c) headers.set(c.header, c.token);
  }
  return fetch(path, { credentials: 'include', ...opts, headers });
};


// JSONã—ã‹å—ã‘ä»˜ã‘ãªã„fetchï¼ˆCookieä»˜ããƒ»éJSONã¯ä¾‹å¤–ï¼‰
async function fetchJSON(url, opts = {}) {
  const res = await apiFetch(url, opts);
  const ct = (res.headers.get('content-type') || '').toLowerCase();

  const redirectedToLogin =
    res.redirected && /\/login(?:\.html)?$/.test(new URL(res.url, location.origin).pathname);

  if (redirectedToLogin || res.status === 401 || res.status === 403) {
    const err = new Error('unauthorized'); err.code = 'UNAUTHORIZED'; throw err;
  }

ã€€  // â† ã“ã“ã‚’è¿½åŠ ï¼š204ã¯ç´ é€šã—
  if (res.status === 204) return null;
	
  if (!ct.includes('application/json')) {
    const err = new Error('non-json'); err.code = 'NON_JSON'; err.status = res.status; throw err;
  }
  if (!res.ok) { // â˜… è¿½åŠ ï¼š4xx/5xx ã¯ä¾‹å¤–
    const err = new Error(`bad-status:${res.status}`);
    err.code = 'BAD_STATUS'; err.status = res.status; throw err;
  }
  return res.json();
}


// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä½¿ã£ã¦ã„ã‚‹ã®ã«æœªå®£è¨€ã ã£ãŸã®ã§ç”¨æ„
let musouMode = false;
let words = [];
let user = { id: null, premium: false, canWatchVideo: false }; // isPremium å»ƒæ­¢
let currentPage = 1;
const pageSize = 5;
let selectedPart = "part1"; // â† åˆæœŸå€¤ã‚’è¨­å®š
let currentPart = 1; // åˆæœŸå€¤ã¨ã—ã¦ Part1 = 1 ã‚’è¨­å®š
const AD_EVERY_TOGGLE = 6;
const AD_EVERY_SWIPE  = 7;

const style = document.createElement('style');
style.innerHTML = `
@keyframes pop {
  0% { transform: scale(0.3); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}`;
document.head.appendChild(style);



//è¡¨ç¤ºåã¨å®Ÿéš›ã®partåã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
const parts = [
  { label: "Part1", value: "part1" },
  { label: "Part2", value: "part2" },
  { label: "Part3", value: "part3" },
  { label: "Part4", value: "part4" },
  { label: "Part5", value: "part5" },
/*   { label: "Part6", value: "part6" },
  { label: "ç™’ã—Part", value: "partHealing" } */
];

document.addEventListener("DOMContentLoaded", initApp);

async function initApp() {
const ok = await fetchUserInfo();
if (!ok) {
  // ã‚µãƒ¼ãƒèµ·å‹•å¾…ã¡ã‚„ä¸€æ™‚çš„ãª HTML å¿œç­”ã€‚UIã«æ¡ˆå†…ã‚’å‡ºã—ã¦è‡ªå‹•å†è©¦è¡Œ
  const s = document.getElementById("learningStatus");
  if (s) s.textContent = "ã‚µãƒ¼ãƒèµ·å‹•ä¸­â€¦è‡ªå‹•ã§å†è©¦è¡Œã—ã¾ã™";
  setTimeout(initApp, 1200);
  return;
}

const urlParams = new URLSearchParams(window.location.search);
const sessionId = urlParams.get('session_id');
if (sessionId) {
  try {
    const r = await apiFetch(`/api/payment/confirm?session_id=${encodeURIComponent(sessionId)}`);
    const j = await r.json();
    user.premium = !!j.premium;
  } catch {}
}

renderPartButtons();
await loadWords();
await refreshUserStats();
showUpdateInfoIfNeeded();
ensureHeroVideo();
placeSwipeBoxAboveStartButton();
await loadWeeklyAnswers(); 
}

//URLã®ãƒ†ã‚¹ãƒˆçµæœã‚’UIã¸åæ˜ ã—ã€å¿…è¦ãªã‚‰ã‚³ãƒŸãƒƒãƒˆã‚‚æ‰“ã¤
async function applyTestParamsAndCommit() {
  const sp = new URLSearchParams(location.search);
  const from  = sp.get('from');
  const score = parseInt(sp.get('score') || '0', 10);
  const total = parseInt(sp.get('total') || '0', 10);
  const userId = getUserIdFromQuery() || 1;
  const mode = 'sentence';

  if (from !== 'test' || !total) return;

  // ã¾ãšç”»é¢ã‚’å³æ™‚æ›´æ–°ï¼ˆã‚µãƒ¼ãƒé…å»¶ã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯çµæœã‚’è¦‹ã‚‰ã‚Œã‚‹ï¼‰
  const testStats = document.getElementById("testStats");
  if (testStats) testStats.textContent = `æ­£ç­”æ•°: ${score} / ${total}å•ä¸­`;

  // ãƒ¬ãƒ™ãƒ«æ¼”å‡ºï¼ˆæš«å®šï¼‰ï¼šç›´è¿‘ã®åˆè¨ˆæ­£ç­”ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç©ã¿ä¸Šã’è¡¨ç¤º
  const localTotalCorrectKey = `localTotalCorrect:${userId}`;
  const prevLocal = parseInt(localStorage.getItem(localTotalCorrectKey) || '0', 10);
  const newLocal  = prevLocal + score;
  localStorage.setItem(localTotalCorrectKey, String(newLocal));

  const prevLevel = Math.floor(prevLocal / 10);
  const newLevel  = Math.floor(newLocal / 10);
  for (let lv = prevLevel + 1; lv <= newLevel; lv++) showLevelUpPopup(lv);

  // ã™ã§ã« test.html å´ã§ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
  const committedKey = `committed:${userId}:${mode}:${score}/${total}`;
  if (sessionStorage.getItem(committedKey) === '1') return;

  // æœªã‚³ãƒŸãƒƒãƒˆãªã‚‰ã“ã“ã§ãƒªãƒˆãƒ©ã‚¤ã‚³ãƒŸãƒƒãƒˆ
  try {
   const res = await apiFetch('/api/test/commit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mode, correct: score, total }) });
    if (res.ok) {
      sessionStorage.setItem(committedKey, '1');
    } else {
      console.warn('user.htmlå´ã‚³ãƒŸãƒƒãƒˆå¤±æ•—', res.status);
    }
  } catch (e) {
    console.warn('user.htmlå´ã‚³ãƒŸãƒƒãƒˆä¾‹å¤–', e);
  }
}

// æ—¢å­˜ã® DOMContentLoaded å¾Œã‚„ loadWords() å®Œäº†å¾Œã«å‘¼ã‚“ã§OK
document.addEventListener('DOMContentLoaded', () => {
ã€€applyTestParamsAndCommit();
ã€€document.getElementById('watchAdBtn')?.addEventListener('click', handleAdAccept);
ã€€document.getElementById('cancelAdBtn')?.addEventListener('click', closeAdModal);

});


//âœ… ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå±¥æ­´ï¼ˆä¾‹ï¼‰
const latestUpdateVersion = "1.3.0"; // â† æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³
const updateMessage = `
  <ul style="text-align: left;">
    <li>ğŸ‰ æ–°æ©Ÿèƒ½ã€Œè¡£è£…åˆ‡ã‚Šæ›¿ãˆã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ </li>
    <li>ğŸ“ˆ æ­£ç­”æ•°ã«å¿œã˜ãŸãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡ºã‚’è¿½åŠ </li>
    <li>ğŸ”’ ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ä¸€éƒ¨æ©Ÿèƒ½ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¶é™</li>
    <li>ğŸ è»½å¾®ãªãƒã‚°ä¿®æ­£ã¨UIæ”¹å–„</li>
  </ul>
`;

// ç½®ãæ›ãˆ
async function headOk(u){
  try{
    const sameOrigin = (() => {
		try { return new URL(u, location.origin).origin === location.origin; }
		catch { return false; }
	})();
    const opt1 = { method: 'HEAD', cache: 'no-store', ...(sameOrigin ? {credentials:'include'} : {}) };
    const r = await fetch(u, opt1);
    if (!r.ok) {
      const opt2 = { method: 'GET', cache: 'no-store', ...(sameOrigin ? {credentials:'include'} : {}) };
      const g = await fetch(u, opt2);
      return g.ok;
    }
    return true;
  }catch{ return false; }
}

async function pickFirstAvailable(list){
  for (const u of list){
    if (await headOk(u)) return u;
  }
  return null;
}

async function ensureHeroVideo(){
  const v = document.getElementById('girlVideo');
  if (!v) return;

const prefer = isPremium() ? ['/videos/run_girl_motion.mp4'] : [];
const candidates = [
  ...prefer,
  '/videos/girl_idle_loop.mp4',
  'https://cdn.jsdelivr.net/gh/masahirotabata/bijyotan@master/src/main/resources/static/videos/girl_idle_loop.mp4'
];

  const ok = await pickFirstAvailable(candidates);
  if (ok){
    v.src = ok;
    try { await v.play(); } catch {}
  }else{
    const p = v.parentElement;
    v.remove();
    const img = document.createElement('img');
    img.src = '/images/beauty.png';
    img.alt = 'girl';
    img.style.borderRadius = '10px';
    img.width = 180;
    p.appendChild(img);
  }
}

	// è¿½åŠ ï¼ˆã©ã“ã§ã‚‚OKã€updateLoginPointsIfNeeded ã‚ˆã‚Šä¸Šã§ã‚‚ä¸‹ã§ã‚‚ï¼‰
function setLoginDays(points){
  const el = document.getElementById('loginDays');
  if (el) el.textContent = `å­¦ç¿’æ—¥æ•°: ${points}æ—¥ç›®`;
}

function isPremium() { return Boolean(user?.premium); } 

// âœ… åˆå›ãƒ­ã‚°ã‚¤ãƒ³ or ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´æ™‚ã®ã¿è¡¨ç¤º
function showUpdateInfoIfNeeded() {
  const shownVersion = localStorage.getItem("updateInfoShownVersion");
  if (shownVersion !== latestUpdateVersion) {
    Swal.fire({
      title: "âœ¨ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ± (v" + latestUpdateVersion + ")âœ¨",
      html: updateMessage,
      icon: "info",
      confirmButtonText: "é–‰ã˜ã‚‹",
      confirmButtonColor: "#e91e63"
    });

    // è¡¨ç¤ºæ¸ˆã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦ä¿å­˜
    localStorage.setItem("updateInfoShownVersion", latestUpdateVersion);
  }
}

	
async function checkPremiumStatus(userId) {
	  try {
			const res = await apiFetch(`/user/${encodeURIComponent(userId)}`);
		  	const ct = res.headers.get('content-type') || '';
		    if (!res.ok || !ct.includes('application/json')) return;
	    	const u = await res.json();
	    if (u.premium === true) {
	      // æ—¢å­˜ã® girlVideo ã‚’ä½¿ç”¨ã—ã€å­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
	      const v = document.getElementById("girlVideo");
	      if (v) {
	        const prefer = "/videos/run_girl_motion.mp4";
	        const fallback = "/videos/girl_idle_loop.mp4";
	        v.onerror = () => { v.src = fallback; };
	        v.src = prefer;
	      }
	    }
	  } catch (err) {
	    console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—", err);
	  }
	}

function placeSwipeBoxAboveStartButton(){
  const box = document.getElementById('swipeModeBox');
  const btn = document.getElementById('swipeStartBtn');
  if (!box || !btn) return;
  const wrap = btn.parentElement;                 // ãƒœã‚¿ãƒ³ã‚’åŒ…ã‚€ <div ...>
  if (wrap && box.previousElementSibling !== wrap){
    // ãƒœã‚¿ãƒ³ã®â€œç›´å‰â€ã« #swipeModeBox ã‚’ç§»å‹•
    wrap.parentNode.insertBefore(box, wrap);
  }
}
// changePart ã¯ selectedPart ã®ã¿æ›´æ–°ã§OK
function changePart(partName) {
  selectedPart = partName;
  const isMusou = (partName === 'ç„¡åŒPart');
  musouMode = isMusou;
  if (isMusou) {
    goToPart(undefined, "ç„¡åŒPart");
  } else {
    loadWords();
  }
}


const CDN_BASE = 'https://cdn.jsdelivr.net/gh/masahirotabata/bijyotan@master/src/main/resources/static/images';
// å˜èªã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã‚¹ãƒ©ãƒƒã‚°
function toSlugForImage(s) {
  return (s || "")
    .toLowerCase()
    .trim()
    .replace(/['â€™`"]/g, "")
    .replace(/\s+/g, "_")
    .replace(/[^a-z0-9_]/g, "");
}

// API 1ä»¶ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã§å…±é€šå½¢ã«æ­£è¦åŒ–
function normalizeWord(raw) {
  const w = {
    id: raw.id ?? raw.wordId ?? raw.word_id ?? raw._id ?? null,   // â† è¿½åŠ 
    word: raw.word ?? "",
    meaning: raw.meaning ?? "",
    part: (raw.part ?? "").toLowerCase(),
    pictUrl: raw.pict_url ?? raw.pictUrl ?? "",
    pictUrlStatic: raw.pict_url_static ?? raw.pictUrlStatic ?? "",
    pictUrlAnimated: raw.pict_url_animated ?? raw.pictUrlAnimated ?? "",
    audioUrl: raw.audio_url ?? raw.audioUrl ?? "",
    videoUrl: raw.video_url ?? raw.videoUrl ?? "",
    status: !!(raw.status ?? raw.learned ?? false),
  };
  w.imageUrl = imageUrlForWord(w);
  return w;
}

// å˜èªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ç”»åƒURLã‚’æ±ºå®šï¼ˆå„ªå…ˆé †ï¼‰
function imageUrlForWord(w) {
  return (
    w.pictUrl ||
    w.pictUrlStatic ||
    w.pictUrlAnimated ||
    `/images/${toSlugForImage(w.word)}_girl.png`
  );
}

// ç”»åƒ404æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
function imgTag(src, alt = "") {
  return `<img src="${safeSrc(src,{allowDataImage:true})}" alt="${escHTML(alt)}"
           width="88" height="132" loading="lazy" decoding="async"
           style="object-fit:cover;border-radius:8px"
           onerror="this.onerror=null;this.src='/images/beauty.png'">`;
}

// â–¼ ä½¿ã„æ–¹ä¾‹ï¼šå–å¾—å¾Œã«æ­£è¦åŒ–
// const rows = await (await fetch(`/api/words?userId=${uid}&part=part1`)).json();
// const words = rows.map(normalizeWord);

async function uploadAndNormalize(file, mode = "cover") {
  const form = new FormData();
  form.append("file", file);
  const res = await apiFetch(`/api/images/normalize/${mode}`, { method: "POST", body: form });
  if (!res.ok) throw new Error("ç”»åƒã®æ­£è¦åŒ–ã«å¤±æ•—");
  return await res.json(); // { url, width, height, mode }
}

async function onFileChange(e, currentWord) {
  const file = e.target.files?.[0];
  if (!file) return;
  const { url } = await uploadAndNormalize(file, "cover");
  // ä¾‹ï¼šä¿å­˜APIã«åæ˜ ï¼ˆå®Ÿè£…ã«åˆã‚ã›ã¦ï¼‰
  // await fetch(`/api/words/${currentWord.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pict_url: url }) });
  currentWord.pictUrl = url;
  currentWord.imageUrl = imageUrlForWord(currentWord);
  // å†æç”»å‡¦ç†â€¦
}

// userId ã¯ä¸€åˆ‡ä½¿ã‚ãšã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§æœ¬äººèªå¯
// äº’æ›ã®ãŸã‚ç¬¬1å¼•æ•°ã¯æœªä½¿ç”¨
function goToPart(_unused, partName) {
  const locked = ["ç„¡åŒPart", "part4", "part5", "part6", "partHealing", "musou"];
  if (!isPremium() && locked.includes(partName) && !isAdEnabled()) {
    Swal.fire({
      title: "ã“ã®ãƒ‘ãƒ¼ãƒˆã¯åºƒå‘Šè¦–è´ãŒå¿…è¦ã§ã™",
      html: `<p>åºƒå‘Šã‚’è¦‹ã‚Œã°<strong>æ®‹ã‚Š6æšã‚ãã‚Œã¾ã™</strong>ã€‚<br>
             <span style="color:#e91e63;font-weight:bold;">ğŸ€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </span>ãªã‚‰<strong>ç„¡åˆ¶é™ã§é–‹æ”¾</strong>ï¼</p>`,
      icon: "info",
      showCancelButton: true,
      showDenyButton: true,
      confirmButtonText: "åºƒå‘Šã‚’è¦‹ã‚‹",
      cancelButtonText: "ã‚„ã‚ã‚‹",
      denyButtonText: "ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã¸"
    }).then(result => {
      if (result.isConfirmed) {
		ã€€pendingToggle = () => { location.href = `musou.html?part=${encodeURIComponent(partName)}`; };
		ã€€showAd();
      } else if (result.isDenied) {
        showPremiumPopup();
      }
    });
    return;
  }
  location.href = `musou.html?part=${encodeURIComponent(partName)}`;
}

function playAll(wordText) {
  const item = words.find(w => w.word === wordText);
  if (item?.videoUrl) {
    playVideo(item.videoUrl);
  } else {
    Swal.fire({ icon: 'info', text: 'ã“ã®å˜èªã®å‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“' });
  }
}


function renderWordCard(word, musouMode, user) {
  if (musouMode) {
    return `
      <div class="musou-card">
        <h3>${word.word}ï¼ˆ${word.meaning}ï¼‰</h3>
        ${word.audioUrl ? `<audio controls src="${word.audioUrl}"></audio>` : ""}
        ${word.videoUrl ? `<video controls width="200" src="${word.videoUrl}"></video>` : ""}
        ${imgTag(word.imageUrl, word.word)}
        <button onclick="${isPremium() ? `playAll('${word.word}')` : 'showPremiumPopup()'}">ç¾å¥³ã‚’å‹•ã‹ã™</button>
      </div>`;
  } else {
    return `
      <div class="normal-card">
        <strong>${word.word}ï¼ˆ${word.meaning}ï¼‰</strong><br>
        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <input type="checkbox" ${word.status ? "checked" : ""}>
        <br>
        ${imgTag(word.imageUrl, word.word)}
        <br>
        <button onclick="${isPremium() ? `playVideo('${esc(String(word.videoUrl||''))}')` : 'showPremiumPopup()'}">ç¾å¥³ã‚’å‹•ã‹ã™</button>
      </div>`;
  }
}
// â–¼ã“ã“å·®ã—æ›¿ãˆï¼š6æšæ–¹å¼ã®çŠ¶æ…‹ç®¡ç†
let remainingCards = Number(localStorage.getItem('remainingCards') || 0);

function saveRemaining() {
  localStorage.setItem('remainingCards', String(remainingCards));
}

// ãƒãƒƒã‚¸è¡¨ç¤ºã®åˆ‡æ›¿ï¼†æ¼”å‡º
function updateCounter(effect = 'none') {
  const badge = document.getElementById('cardCounter');
  if (!badge) return;

  // 0æšã®ã¨ãã¯ã‚¿ãƒƒãƒ—ã§åºƒå‘Šå‘¼ã³å‡ºã—
  if (remainingCards > 0) {
    badge.textContent = `æ®‹ã‚Š ${remainingCards} æš`;
    badge.onclick = null;
    badge.style.opacity = '1';
  } else {
    badge.textContent = 'åºƒå‘Šã‚’è¦‹ã¦å†é–‹ï¼';
    badge.onclick = () => showAd();     // â† ã‚¿ãƒƒãƒ—ã§åºƒå‘Šè¡¨ç¤º
    badge.style.opacity = '.95';
  }

  // æ¼”å‡ºï¼ˆæˆåŠŸæ™‚ã¯pop-glowã€æ¯å›ã®æ¸›ç®—æ™‚ã¯pop-softï¼‰
  badge.classList.remove('pop-glow', 'pop-soft');
  void badge.offsetWidth; // reflowã—ã¦ã‚¢ãƒ‹ãƒ¡ã‚’æ›ã‘ç›´ã™
  if (effect === 'glow') badge.classList.add('pop-glow');
  if (effect === 'soft') badge.classList.add('pop-soft');
}

// åˆæœŸè¡¨ç¤º
updateCounter('none');

// â–¼ã“ã“å·®ã—æ›¿ãˆï¼šã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹å‰ã«æ®‹æšæ•°ãƒã‚§ãƒƒã‚¯
function flipCard() {
  if (remainingCards <= 0) {
    // 0æšæ™‚ã¯åºƒå‘Šã¸èª˜å°ï¼ˆãƒãƒƒã‚¸ã‚‚â€œåºƒå‘Šã‚’è¦‹ã¦å†é–‹ï¼â€è¡¨ç¤ºæ¸ˆï¼‰
    showAd();
    return;
  }
  // æ­£å¸¸ï¼šæ¬¡ã‚«ãƒ¼ãƒ‰è¡¨ç¤º â†’ æ®‹æšæ•°ã‚’1æ¸›ã‚‰ã™
  showNextCard();           // â† æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºå‡¦ç†ã‚’å‘¼ã¶
  remainingCards--;
  saveRemaining();
  updateCounter('soft');    // è»½ã„ãƒãƒ³æ¼”å‡º
}

// â–¼ã“ã“å·®ã—æ›¿ãˆï¼šåºƒå‘Šè¡¨ç¤ºï¼ˆãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
function showAd() {
  // ã“ã“ã§ AdMob ãªã©ã®ãƒªãƒ¯ãƒ¼ãƒ‰åºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹
  // é‡è¦ï¼šè¦–è´å®Œäº†ï¼ˆå ±é…¬ä»˜ä¸æ¡ä»¶ï¼‰ã ã‘ onAdWatchedSuccess() ã‚’å‘¼ã¶ã“ã¨
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ« / å¤±æ•— / é–‰ã˜ã‚‹ ã¯ onAdClosedOrFailed() å´ã§æ‰±ã†

  // ä¾‹ï¼šæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿè£…ã—ã¦ã„ã‚‹åºƒå‘ŠSDKã«åˆã‚ã›ã¦ç½®æ›ï¼‰
  /*
  admob.rewarded.show({
    onRewarded: () => onAdWatchedSuccess(),
    onDismissed: () => onAdClosedOrFailed(),
    onError: (e) => onAdClosedOrFailed(e)
  });
  */
  // æš«å®šãƒ‡ãƒ¢ï¼ˆæœ¬ç•ªã¯â†‘ã®SDKã‚³ãƒ¼ãƒ«ã«ç½®ãæ›ãˆï¼‰
  const ok = confirm('ã€ãƒ‡ãƒ¢ã€‘åºƒå‘Šã‚’æœ€å¾Œã¾ã§è¦–è´ã—ã¾ã—ãŸã‹ï¼Ÿ\nOK=æˆåŠŸ / Cancel=ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
  if (ok) onAdWatchedSuccess(); else onAdClosedOrFailed();
}

// â–¼ã“ã“å·®ã—æ›¿ãˆï¼šåºƒå‘Šâ€œæˆåŠŸæ™‚ã®ã¿â€6æšä»˜ä¸ï¼ˆãƒã‚°ã®æ ¹æœ¬å¯¾ç­–ï¼‰
function onAdWatchedSuccess() {
  remainingCards = 6;       // ä»˜ä¸æšæ•°ï¼š6
  saveRemaining();
  updateCounter('glow');    // ã”è¤’ç¾ã‚¢ãƒ‹ãƒ¡ï¼ˆé»„è‰²ã«å…‰ã£ã¦ãƒãƒ³ï¼‰
ã€€resetBeautyClickCount(); // â† æˆåŠŸæ™‚ã«ã“ã“ã§ãƒªã‚»ãƒƒãƒˆ

  // ãƒˆã‚°ãƒ«å¾…ã¡ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã‚ã‚Œã°å®Ÿè¡Œã—ã¦ãŠã
  if (typeof pendingToggle === 'function') {
    const cb = pendingToggle;
    pendingToggle = null;
    try { cb(); } catch (e) { console.warn('pendingToggle failed:', e); }
  }
}

// â–¼ã“ã“å·®ã—æ›¿ãˆï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«/å¤±æ•—ã¯ä½•ã‚‚ã—ãªã„ï¼ˆè¿½åŠ ä»˜ä¸ã—ãªã„ï¼ï¼‰
function onAdClosedOrFailed(err) {
  // ãƒ­ã‚°ã ã‘ï¼ˆå¿…è¦ãªã‚‰ï¼‰
  if (err) console.warn('Ad closed/failed:', err);
  // ä»˜ä¸ã—ãªã„ãƒ»æ®‹æšæ•°ã‚‚å¤‰ãˆãªã„
  updateCounter('none');
}

// â–¼ã“ã“å·®ã—æ›¿ãˆï¼šã‚«ãƒ¼ãƒ‰DOMç”Ÿæˆæ™‚ã«URLãŒãƒ†ã‚­ã‚¹ãƒˆã§å‡ºãªã„ã‚ˆã†ã«ã™ã‚‹
// æ—¢å­˜ã® showNextCard() å†…ã§ã€Œãƒ†ã‚­ã‚¹ãƒˆã«URLã‚’æµã—è¾¼ã‚€ã€ã®ã‚’ã‚„ã‚ã€å¿…ãš <img> ã‚’append ã™ã‚‹
function createWordCard({ imageUrl, alt = 'word' }) {
  const card = document.createElement('div');
  card.style.width = '100%';
  card.style.height = '100%';
  card.style.display = 'flex';
  card.style.alignItems = 'center';
  card.style.justifyContent = 'center';
  card.style.background = '#fff';

  const img = document.createElement('img');
ã€€img.src = safeSrc(imageUrl, { allowDataImage: true });
  img.onerror = () => { img.src = '/images/beauty.png'; };
  img.alt = alt;
  img.style.maxWidth = '100%';
  img.style.maxHeight = '100%';
  img.style.objectFit = 'contain';

  // ã“ã“ã§çµ¶å¯¾ã« URL ã‚’ textContent/innerText ã«å…¥ã‚Œãªã„ï¼
  // card.textContent = imageUrl; â† NGï¼ˆã“ã‚ŒãŒâ€œURLãŒè¡¨ç¤ºã•ã‚Œã‚‹â€åŸå› ï¼‰

  card.appendChild(img);
  return card;
}

// ä¾‹ï¼šæ—¢å­˜å‡¦ç†ã®ä¸€éƒ¨ã‚¤ãƒ¡ãƒ¼ã‚¸
function showNextCard() {
  const area = document.getElementById('cardArea');
  if (!area) return;
  area.innerHTML = '';

  // æ¬¡ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å–å¾—ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã«åˆã‚ã›ã¦ï¼‰
  const next = getNextWordCardInfo(); // { imageUrl, alt }
  area.appendChild(createWordCard(next));
}

// â–¼ã“ã“å·®ã—æ›¿ãˆï¼šç„¡åŒPartã¯å‡ºã•ãªã„ï¼ˆãƒ•ãƒ©ã‚°ã§æŠ‘æ­¢ï¼‰
const MUSOU_ENABLED = false;
window.addEventListener('DOMContentLoaded', () => {
  if (!MUSOU_ENABLED) {
    const musouNav = document.getElementById('nav-muso'); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ãªã©ã«ä»˜ä¸ã—ã¦ã‚ã‚‹IDã‚’æŒ‡å®š
    if (musouNav) musouNav.style.display = 'none';
  }
});

function getUserId(){
  // â† ã‚¯ã‚¨ãƒª(userId)æœ€å„ªå…ˆã§å–å¾—ã™ã‚‹
  return getUserIdFromQuery() || user?.id || localStorage.getItem("userId") || "1";
}

function showLevelUpPopup(newLevel) {
	  const title = getTitleByLevel(newLevel);
	  Swal.fire({
	    title: 'ğŸ‰ LEVEL UPï¼ğŸ‰',
	    html: `
	      <p style="font-size: 20px;">æ–°ã—ã„ãƒ¬ãƒ™ãƒ«: Lv.${newLevel}</p>
	      <div style="margin-top: 10px;">ç§°å·ï¼š<strong>${title}</strong></div>
	      <div class="slide-message" style="font-size: 18px; margin-top: 10px;">ã“ã®èª¿å­ã§é ‘å¼µã‚ã†ï¼</div>
	      <br>
	      <button id="shareButton" style="background:#1da1f2;color:white;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;">
	        SNSã§ã‚·ã‚§ã‚¢ã™ã‚‹
	      </button>
	    `,
	    showConfirmButton: false,
	    timer: 6000,
	    didOpen: () => {
	      document.getElementById("shareButton").addEventListener("click", () => {
	        const shareText = `ç§ã¯ä»Šãƒ¬ãƒ™ãƒ«${newLevel}ã§ã€Œ${title}ã€ã«åˆ°é”ã—ã¾ã—ãŸï¼ #ç¾å¥³å˜`;
	        const shareUrl = encodeURIComponent("https://your-app-url.com");
	        const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${shareUrl}`;
	       	window.open(tweetUrl, '_blank', 'noopener,noreferrer');
	      });
	    }
	  });
	}


//è¿½åŠ ï¼šPartç”¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°
let partsPage = 1;
const partsPerPage = 4; // 1ãƒšãƒ¼ã‚¸ã«å‡ºã™Partæ•°ï¼ˆãŠå¥½ã¿ã§ï¼‰

// ç½®ãæ›ãˆï¼šãƒœã‚¿ãƒ³ã®æç”»ï¼ˆãƒšãƒ¼ã‚¸å†…ã®Partã ã‘è¡¨ç¤ºï¼‰
function renderPartButtons() {
  const container = document.getElementById("partButtons");
ã€€if (!container) return;
  container.innerHTML = "";

  const start = (partsPage - 1) * partsPerPage;
  const view = parts.slice(start, start + partsPerPage);

  view.forEach(({ label, value }) => {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.onclick = () => selectPart(value);
    if (value === selectedPart) btn.style.fontWeight = "bold";
    container.appendChild(btn);
  });

  renderPartPagination(); // â† ãƒšãƒ¼ã‚¸ç•ªå·ã‚‚æ›´æ–°
}

function renderPartPagination() {
  const pageCount = Math.ceil(parts.length / partsPerPage);
  const bottom = document.getElementById("partPagination");
  const containers = [bottom].filter(Boolean); // â† ä¸Šã¯ä½¿ã‚ãªã„

  containers.forEach(c => { c.innerHTML = ""; });
  if (pageCount <= 1) {
    containers.forEach(c => c.classList.add("hidden"));
    return;
  }
  containers.forEach(c => c.classList.remove("hidden"));

  const build = (wrap) => {
const makeBtn = (label, page, disabled = false, active = false) => {
  const btn = document.createElement("button");
  btn.type = "button";
  btn.textContent = label;
  btn.setAttribute(
    "aria-label",
    label === "â€¹" ? "å‰ã®ãƒšãƒ¼ã‚¸" :
    label === "â€º" ? "æ¬¡ã®ãƒšãƒ¼ã‚¸" :
    `ãƒšãƒ¼ã‚¸ ${label}`
  );
  if (disabled) btn.disabled = true;
  if (active) { btn.classList.add("active"); btn.setAttribute("aria-current","page"); }
      btn.addEventListener("click", () => {
        if (disabled || !page || page === partsPage) return;
        const oldTop = wrap.getBoundingClientRect().top;
        partsPage = page;
        renderPartButtons();
        requestAnimationFrame(() => {
          const newTop = wrap.getBoundingClientRect().top;
          window.scrollBy(0, newTop - oldTop);
        });
      });
      return btn;
    };
    const addPage = (n) => wrap.appendChild(makeBtn(String(n), n, false, n === partsPage));
    const addDots = () => { const s=document.createElement("span"); s.className="ellipsis"; s.textContent="â€¦"; wrap.appendChild(s); };

    wrap.appendChild(makeBtn("â€¹", partsPage - 1, partsPage === 1));
    if (pageCount <= 5) for (let i=1;i<=pageCount;i++) addPage(i);
    else if (partsPage <= 3){ addPage(1);addPage(2);addPage(3);addDots();addPage(pageCount); }
    else if (partsPage >= pageCount-2){ addPage(1);addDots();addPage(pageCount-2);addPage(pageCount-1);addPage(pageCount); }
    else { addPage(1);addDots();addPage(partsPage-1);addPage(partsPage);addPage(partsPage+1);addDots();addPage(pageCount); }
    wrap.appendChild(makeBtn("â€º", partsPage + 1, partsPage === pageCount));
  };

  containers.forEach(build);
}

// ä¿®æ­£ï¼šParté¸æŠæ™‚ã«ã€Œãã®PartãŒè¼‰ã£ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã€ã‚’è‡ªå‹•è¡¨ç¤º
function selectPart(part) {
  const lockedParts = ["part4", "part5", "part6", "partHealing", "musou"];
  const isLockedPart = lockedParts.includes(part);

  const show = () => {
    selectedPart = part;
    const idx = Math.max(0, parts.findIndex(p => p.value === part));
    partsPage = Math.floor(idx / partsPerPage) + 1; // ãã®PartãŒè¼‰ã£ã¦ã„ã‚‹ã€ŒPartãƒšãƒ¼ã‚¸ã€ã‚’è¡¨ç¤º
    currentPart = idx + 1;
    currentPage = 1;
    renderPartButtons();
    loadWords();
  };

  if (!isPremium() && isLockedPart && !isAdEnabled()) {
    Swal.fire({
      title: "ã“ã®ãƒ‘ãƒ¼ãƒˆã¯åºƒå‘Šè¦–è´ãŒå¿…è¦ã§ã™",
      html: `<p>åºƒå‘Šã‚’è¦‹ã‚Œã°<strong>æ®‹ã‚Š6æšã‚ãã‚Œã¾ã™</strong>ã€‚<br>
             <span style="color:#e91e63;font-weight:bold;">ğŸ€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡</span>ãªã‚‰ã€<strong>ç„¡åˆ¶é™ã§é–‹æ”¾</strong>ã•ã‚Œã¾ã™ã€‚</p>`,
      icon: "info",
      showCancelButton: true,
      showDenyButton: true,
      confirmButtonText: "åºƒå‘Šã‚’è¦‹ã‚‹",
      cancelButtonText: "ã‚„ã‚ã‚‹",
      denyButtonText: "ğŸ€ 300å††ã§åºƒå‘Šãªã—ï¼ç¾å¥³ã‚ãã‚Šæ”¾é¡ŒğŸ€"
    }).then(result => {
      if (result.isConfirmed) {
		pendingToggle = show;  // æˆåŠŸå¾Œã« Part ã‚’è¡¨ç¤º
        showAd();
      } else if (result.isDenied) {
        showPremiumPopup();
      }
    });
  } else {
    show();
  }
}

// ã‚¯ã‚¨ãƒªã‹ã‚‰ userId ã‚’å–ã‚‹å°é“å…·
function getUserIdFromQuery() {
  const p = new URLSearchParams(location.search);
  return p.get('userId');
}

// ã©ã“ã‹ä¸Šã®æ–¹ã«è¿½åŠ 
async function readJsonIfPossible(res) {
  const ct = (res.headers.get('content-type') || '').toLowerCase();
  if (!ct.includes('application/json')) return null; // HTMLç­‰ã¯å¼¾ã
  try { return await res.json(); } catch { return null; }
}

// ã“ã‚Œã§ç½®ãæ›ãˆ
async function fetchUserInfo() {
  // ã¾ãš /api/me ã‚’æœ€å„ªå…ˆã§
  const uid = getUserIdFromQuery() || localStorage.getItem('userId');
  const candidates = [
    '/api/me',
    '/user/me',
    ...(uid ? [`/user/${encodeURIComponent(uid)}`] : []),
    '/api/user/me'
  ];

  const normalize = (d) => ({
    id: d.id ?? d.userId ?? null,
    username: d.username ?? d.name ?? '',
    premium: Boolean(d.premium ?? d.isPremium),
    level: Number(d.level ?? 1),
    loginPoints: Number(d.loginPoints ?? 0),
    testCorrectTotal: Number(d.testCorrectTotal ?? 0)
  });

  for (const url of candidates) {
    try {
      const data = await fetchJSON(url);
      const u = normalize(data);
      user = u;

      if (u.id) localStorage.setItem('userId', String(u.id));
      document.getElementById("username").innerText  = `${u.username} ã•ã‚“ã€ã‚ˆã†ã“ãï¼`;
      document.getElementById("planText").innerText  = `ãƒ—ãƒ©ãƒ³: ${u.premium ? "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ " : "ç„¡æ–™"}`;
      document.getElementById("userLevel").innerText = `ãƒ¬ãƒ™ãƒ«: Lv.${u.level}`;
      updateGirlVisual(u.level);

      // ãƒ­ã‚°ãƒœã®æ›´æ–°ï¼†è¡¨ç¤º
      const ok = await updateLoginPointsIfNeeded(u.id);
      if (!ok) {
        const points = Number.isFinite(u.loginPoints) ? u.loginPoints : 1;
        setLoginDays(points);
        showLoginBonusOncePerDay(points);
      }
      return true;
    } catch (_) { /* æ¬¡ã®å€™è£œã¸ */ }
  }

  // èµ·å‹•å¾…ã¡ãªã©ï¼šæ•°å›ãƒªãƒˆãƒ©ã‚¤
  for (let i=0;i<2;i++){
    await new Promise(r=>setTimeout(r, 800));
    for (const url of candidates){
      try {
        const data = await fetchJSON(url);
        const u = normalize(data);
        user = u;
        if (u.id) localStorage.setItem('userId', String(u.id));
        document.getElementById("username").innerText  = `${u.username} ã•ã‚“ã€ã‚ˆã†ã“ãï¼`;
        document.getElementById("planText").innerText  = `ãƒ—ãƒ©ãƒ³: ${u.premium ? "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ " : "ç„¡æ–™"}`;
        document.getElementById("userLevel").innerText = `ãƒ¬ãƒ™ãƒ«: Lv.${u.level}`;
        updateGirlVisual(u.level);
        const ok = await updateLoginPointsIfNeeded(u.id);
        if (!ok) { setLoginDays(u.loginPoints||1); showLoginBonusOncePerDay(u.loginPoints||1); }
        return true;
      } catch { /* æ¬¡ */ }
    }
  }

  console.warn('user info could not be fetched as JSON');
  return false;
}
	
// ä¸å­˜åœ¨ã® PUT ã‚’ã‚„ã‚ã¦ã€weekly ã‹ã‚‰æ—¥æ•°æ¨è¨ˆã ã‘ã«ã™ã‚‹
async function updateLoginPointsIfNeeded(userId) {
  try {
    const res = await apiFetch(`/api/test/weekly?userId=${encodeURIComponent(userId)}`);
    const ct  = (res.headers.get('content-type')||'').toLowerCase();
    if (!res.ok || !ct.includes('application/json')) return false;
    const w = await res.json();
    const days = Array.isArray(w) ? w.filter(d => (d.answers ?? 0) > 0).length : 0;
    const p = Math.max(1, days);
    setLoginDays(p);
    showLoginBonusOncePerDay(p);
    return true;
  } catch { return false; }
}

// 1æ—¥1å›ã ã‘ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
function showLoginBonusOncePerDay(points){
  const d = new Date();
  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const key = `loginBonusShown:${ymd}`;
  if (localStorage.getItem(key) === '1') return;
  showLoginBonus(points);
  localStorage.setItem(key, '1');
}

// å˜èªå–å¾—ï¼šã¾ãšã‚»ãƒƒã‚·ãƒ§ãƒ³èªå¯ã€ç©ºãªã‚‰ userId ä»˜ãã§å†è©¦è¡Œ
async function fetchWordsFromServer(part) {
  const tryUrls = [
    `/api/words?part=${encodeURIComponent(part)}`,
    `/words?part=${encodeURIComponent(part)}`
  ];
  const withUserId = (u) => `${u}&userId=${encodeURIComponent(getUserId())}`;

  for (const base of tryUrls) {
    // 1st: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿
    for (const url of [base]) {
      try {
        const res = await apiFetch(url, { headers:{Accept:'application/json'} });
        if (res.ok) {
          const data = await readJsonIfPossible(res);
          if (Array.isArray(data) && data.length) {
            return data.map(w => normalizeWord({ ...w, status: !!(w.status ?? w.learned) }));
          }
        }
      } catch {}
    }
    // 2nd: userId ã‚’ä»˜ã‘ã¦å†è©¦è¡Œ
    try {
      const res = await apiFetch(withUserId(base), { headers:{Accept:'application/json'} });
      if (res.ok) {
        const data = await readJsonIfPossible(res);
        if (Array.isArray(data)) {
          return data.map(w => normalizeWord({ ...w, status: !!(w.status ?? w.learned) }));
        }
      }
    } catch {}
  }
  console.warn('words endpoint not ready');
  return [];
}


//=== åºƒå‘Šè¡¨ç¤ºãƒˆãƒªã‚¬ç”¨ã®ã‚«ã‚¦ãƒ³ã‚¿ã¨ä¿ç•™å®Ÿè¡Œ ===
let pendingToggle = null;

function getBeautyClickCount() {
  const n = parseInt(localStorage.getItem('beauty_clicks') || '0', 10);
  return isNaN(n) ? 0 : n;
}
function incBeautyClickCount() {
  const n = getBeautyClickCount() + 1;
  localStorage.setItem('beauty_clicks', String(n));
  return n;
}
function resetBeautyClickCount() {
  localStorage.setItem('beauty_clicks', '0');
}

// æ—¢å­˜ã® showAdModalForToggle / closeAdModal ã‚’å·®ã—æ›¿ãˆ
let removeTrapAd = null;

function showAdModalForToggle(callback) {
  pendingToggle = callback;
  const m = document.getElementById('adModal');
  if (!m) { console.error('adModal not found'); return; }
  m.style.display = 'flex';
  m.setAttribute('role','dialog');
  m.setAttribute('aria-modal','true');
  removeTrapAd = trapFocus(m);
  document.body.classList.add('modal-open');
  m.querySelector('#watchAdBtn')?.focus();
}

function closeAdModal() {
  const m = document.getElementById('adModal');
  m.style.display = 'none';
  removeTrapAd?.(); removeTrapAd = null;
  document.body.classList.remove('modal-open');
}

// æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³IDã«å¯¾å¿œï¼ˆä¸‹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLãã®ã¾ã¾ä½¿ãˆã¾ã™ï¼‰
function handleAdAccept() {
 // ã“ã“ã§å ±é…¬å‹åºƒå‘Šã‚’è¡¨ç¤º
  showAd();          // â† 5åˆ†è§£æ”¾ã®watchAdGlobalã¯ä½¿ã‚ãªã„
  closeAdModal();    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯é–‰ã˜ã¦OKï¼ˆæˆåŠŸæ™‚ã¯ onAdWatchedSuccess() ãŒå‘¼ã°ã‚Œã‚‹ï¼‰
}


// ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸Šéƒ¨ã®ã©ã“ã‹ï¼ˆä»–é–¢æ•°ã®å¤–ï¼‰ã«ç½®ã
function esc(s=''){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function safeSrc(u, { allowDataImage=false, allowData=false, allowBlob=false } = {}){
  try{
    const url = new URL(u, location.origin);
    const isHttp = url.protocol === 'http:' || url.protocol === 'https:';
    const isData = url.protocol === 'data:' && (allowData || allowDataImage);
    const isBlob = url.protocol === 'blob:' && allowBlob;
    return (isHttp || isData || isBlob) ? url.href : '/images/beauty.png';
  } catch {
    return '/images/beauty.png';
  }
}
	
function escHTML(v=''){ return String(v)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
  .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
  .replace(/'/g,'&#39;'); }

function h(parts, ...vals){
  return parts.reduce((s, p, i) => s + p + (i < vals.length ? escHTML(vals[i]) : ''), '');
}

function renderWords() {
  const container = document.getElementById("wordContainer");
  if (!container) return;
  container.innerHTML = "";

  const start = (currentPage - 1) * pageSize;
  const pageWords = words.slice(start, start + pageSize);

  pageWords.forEach((word, index) => {
    const div = document.createElement("div");
    div.className = "word-card";

    const premiumUser = isPremium();
    const actionButton = ""; // ç„¡æ–™ã¯éè¡¨ç¤º

    const checkboxId = `status-${word.id ?? 'na'}`;
	const canToggle  = Number.isFinite(word.id);
    const checked = word.status ? "checked" : "";
    const labelText = word.status ? "å­¦ç¿’æ¸ˆã¿" : "æœªå­¦ç¿’";

    const imageId = `img-${index}`;
    const toggleButtonId = `toggle-${index}`;
	const slug = toSlugForImage(word.word);
	const baseImg = '/images/beauty.png';
	const specificImg = `/images/${slug}_girl.png`;
	
	// â† id ãŒç„¡ã„ãƒ‡ãƒ¼ã‚¿ã§ã‚‚è¡çªã—ãªã„ã‚­ãƒ¼ã«ã™ã‚‹
	const keyBase  = (word.id != null && String(word.id) !== '') ? `id:${word.id}` : `slug:${slug}`;
	const stateKey = `imgState:${keyBase}`;
	
	// â† åˆæœŸè¡¨ç¤ºã¯å¿…ãš beauty.png ï¼ˆã‚­ãƒ¼ãŒ '2' ã®ã¨ãã ã‘ç‰¹åˆ¥ç”»åƒï¼‰
	const raw = localStorage.getItem(stateKey);
	const initState = (raw === '2') ? '2' : '1';
	const initSrc   = (initState === '2') ? specificImg : baseImg;
	
	div.innerHTML = `
	  <div class="wc-img">
	    <img
	      id="${imageId}"
	      src="${initSrc}"
	      alt="${esc(word.word)}"
	      loading="lazy"
	      width="88" height="132" decoding="async" draggable="false"
	      data-state="${initState}"
	      data-word-id="${word.id ?? ''}"
	      data-key="${stateKey}"
	    >
	  </div>

      <div class="wc-body">
        <strong>${esc(word.word)}</strong>
        <div class="meta">ï¼ˆ${esc(word.meaning)}ï¼‰</div>
        <div class="meta">
          ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
        <input type="checkbox" id="${checkboxId}" ${checked} ${canToggle ? '' : 'disabled'}
		  data-word-id="${word.id}"
		  data-part="${esc(selectedPart)}">
          <span id="status-label-${word.id ?? 'na'}">${labelText}</span>
        </div>
      </div>

<div class="wc-actions">
    <!-- ç”»åƒãƒˆã‚°ãƒ«ç”¨ -->
	<button
	  type="button"
	  class="js-toggle"
	  id="${toggleButtonId}"
	  data-img-id="${imageId}"
	  data-base="${esc(baseImg)}"
	  data-specific="${esc(specificImg)}"
	  data-index="${index}"
	  aria-controls="${imageId}"
	  aria-pressed="${initState === '2' ? 'true' : 'false'}"
	  aria-label="ã€${esc(word.word)}ã€ã®ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆ"
	>ç¾å¥³ã§è‹±å˜èªã‚’è¡¨ç¾ã™ã‚‹</button>

    <!-- å‹•ç”»å†ç”Ÿï¼ˆã‚ã‚‹å ´åˆã ã‘ï¼‰ -->
    ${word.videoUrl ? `
      <button
        type="button"
        class="js-play"
        data-video="${esc(word.videoUrl)}"
      >å‹•ç”»ã‚’è¦‹ã‚‹</button>` : ``}

    ${actionButton ? `<div style="margin-top:6px">${actionButton}</div>` : ""}
  </div>
	    `;
    container.appendChild(div);
  }); // â† ã“ã“ãŒæŠœã‘ã¦ã¾ã—ãŸï¼

  renderPagination(words.length);
}

let _delegationReady = false;
function setupWordDelegation(){
  if (_delegationReady) return;
  _delegationReady = true;

  const root = document.getElementById("wordContainer");
ã€€if (!root) return;

  root.addEventListener("click", (e) => {
    const tgl = e.target.closest("button.js-toggle");
    if (tgl) {
      const { imgId, base, specific, index } = tgl.dataset;
      handleToggleImage(imgId, tgl.id, base, specific, index);
      return;
    }
	const play = e.target.closest("button.js-play");
	if (play) {
	  const url = safeSrc(play.dataset.video, { allowData:true, allowBlob:true });
	  if (url) playVideo(url);
	}
  });

  root.addEventListener("change", (e) => {
    const cb = e.target.closest('input[type="checkbox"][data-word-id]');
    if (!cb) return;
    toggleStatus(cb.checked, Number(cb.dataset.wordId), cb.dataset.part);
  });
}

// DOMContentLoaded å¾Œ or renderWords() ã®ç›´å¾Œã«ä¸€å›ã ã‘
document.addEventListener("DOMContentLoaded", setupWordDelegation);




function toggleImage(imgId, btnId, img1, img2, index) {
  const imgElem   = document.getElementById(imgId);
  const btn       = document.getElementById(btnId);

  // â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šrenderWordsã¨åŒã˜ã‚­ãƒ¼ã‚’ä½¿ã†
  const stateKey  = imgElem?.dataset?.key ||
                    (imgElem?.dataset?.wordId ? `imgState:id:${imgElem.dataset.wordId}` : null);

  const nextState = (imgElem.dataset.state === '2') ? '1' : '2';
  const nextSrc   = (nextState === '2') ? img2 : img1;

  const test = new Image();
  test.onload = () => {
    imgElem.src = nextSrc;
    imgElem.dataset.state = nextState;
    if (btn) btn.setAttribute('aria-pressed', nextState === '2' ? 'true' : 'false');
    if (stateKey) localStorage.setItem(stateKey, nextState);
  };
  test.onerror = () => {
    imgElem.src = img1;
    imgElem.dataset.state = '1';
    if (btn) btn.setAttribute('aria-pressed', 'false');
    if (stateKey) localStorage.setItem(stateKey, '1');
  };
  test.src = nextSrc;
}

function handleToggleImage(imgId, btnId, img1, img2, index) {
  const proceed = () => toggleImage(imgId, btnId, img1, img2, index);

  if (isPremium() || isAdEnabled()) { proceed(); return; }

  // 6å›ã«1å›ã ã‘åºƒå‘Šã‚’å‡ºã™
  const n = incBeautyClickCount(); // â† æ—¢å­˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æ´»ç”¨
  if (n % AD_EVERY_TOGGLE === 0) {
    showAdModalForToggle(proceed);
  } else {
    proceed();
  }
}

function renderPagination(totalItems) {
  const pageCount = Math.ceil(totalItems / pageSize);
  const bottom = document.getElementById("pagination");
  const containers = [bottom].filter(Boolean); // â† ä¸Šã¯ä½¿ã‚ãªã„

  containers.forEach(c => c.innerHTML = "");
  if (pageCount <= 1) return;

  const build = (wrap) => {
    const makeBtn = (label, page, disabled = false, active = false) => {
      const btn = document.createElement("button");
      btn.textContent = label;
      if (disabled) btn.disabled = true;
      if (active) btn.classList.add("active");
      btn.addEventListener("click", () => {
        if (disabled || !page || page === currentPage) return;
        const oldTop = wrap.getBoundingClientRect().top;
        currentPage = page;
        renderWords();
        requestAnimationFrame(() => {
          const newTop = wrap.getBoundingClientRect().top;
          window.scrollBy(0, newTop - oldTop);
        });
      });
      return btn;
    };
    const addPage = (n) => wrap.appendChild(makeBtn(String(n), n, false, n === currentPage));
    const addDots = () => { const s=document.createElement("span"); s.className="ellipsis"; s.textContent="â€¦"; wrap.appendChild(s); };

    wrap.appendChild(makeBtn("â€¹", currentPage - 1, currentPage === 1));
    if (pageCount <= 5) for (let i=1;i<=pageCount;i++) addPage(i);
    else if (currentPage <= 3){ addPage(1);addPage(2);addPage(3);addDots();addPage(pageCount); }
    else if (currentPage >= pageCount-2){ addPage(1);addDots();addPage(pageCount-2);addPage(pageCount-1);addPage(pageCount); }
    else { addPage(1);addDots();addPage(currentPage-1);addPage(currentPage);addPage(currentPage+1);addDots();addPage(pageCount); }
    wrap.appendChild(makeBtn("â€º", currentPage + 1, currentPage === pageCount));
  };

  containers.forEach(build);
}


// ç½®ãæ›ãˆ
async function loadWords() {
  words = await fetchWordsFromServer(selectedPart);  // â† userIdã‚’æ¸¡ã•ãªã„
  renderWords();

  updateStatusCount();

  document.getElementById("loginDays").textContent =
    `å­¦ç¿’æ—¥æ•°: ${user.loginPoints || 0}æ—¥ç›®`;

  const correct = localStorage.getItem("test_correct") || 0;
  const total = localStorage.getItem("test_total") || 0;
  document.getElementById("testStats").textContent = `æ­£ç­”æ•°: ${correct} / ${total}å•ä¸­`;

  await refreshUserStats();
}


function watchAdGlobal() {
	  const now = Date.now();
	  const expiry = now + 5 * 60 * 1000; // 5åˆ†é–“æœ‰åŠ¹
	  localStorage.setItem("ad_expiry", expiry.toString());

	  alert("åºƒå‘Šè¦–è´å®Œäº†ï¼");
	  renderWords(); // â† ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’å³æ™‚åæ˜ 
	}
	
function isAdEnabled() {
	return remainingCards > 0;  // 6æšæ–¹å¼ï¼šæ®‹æšæ•°ãŒã‚ã‚Œã°è§£æ”¾
}


function unlockCasualSuit() {
  alert("1000å††ã§ç¾å¥³ã‚¹ãƒ¼ãƒ„è§£æ”¾ï¼ˆä»®ï¼‰");
}

function playVideo(videoUrl) {
  const url = safeSrc(videoUrl, { allowData:true, allowBlob:true });
  if (!url) return;
  const modal = document.getElementById("videoModal");
  const player = document.getElementById("videoPlayer");
  player.src = url;
  modal.style.display = "flex";
  const stop = e => e.stopPropagation();
  player.addEventListener('click', stop);
  modal.onclick = () => {
    modal.style.display = "none";
    player.pause();
    player.currentTime = 0;
	player.src = ""; // â˜…è¿½åŠ 
    player.removeEventListener('click', stop);
  };
}

	
// ç½®ãæ›ãˆ
function updateGirlVisual(level) {
  const v = document.getElementById("girlVideo");
  const bg = document.getElementById("bgEffect");
  if (!v || !bg) return;

  // srcã¯åŸå‰‡ã„ã˜ã‚‰ãªã„ã€‚ç©ºãªã‚‰ã ã‘åˆæœŸå€¤ã‚’å…¥ã‚Œã‚‹
  if (!v.getAttribute('src')) {
    v.src = '/videos/girl_idle_loop.mp4';
  }
  // 404æ™‚ã¯CDNã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  v.onerror = () => {
    v.onerror = null;
    v.src =
      'https://cdn.jsdelivr.net/gh/masahirotabata/bijyotan@master/src/main/resources/static/videos/girl_idle_loop.mp4';
  };

  bg.className = level >= 20 ? "heart-bg" : "star-bg";
}



function toggleStatus(isChecked, wordId, part) {
ã€€if (!Number.isFinite(wordId)) return; // idä¸æ˜ãªã‚‰é€ã‚‰ãªã„
  apiFetch('/api/learning/update', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    // userId ã¯é€ã‚‰ãªã„ï¼ˆã‚µãƒ¼ãƒã§ã‚»ãƒƒã‚·ãƒ§ãƒ³èªå¯ï¼‰
    body: JSON.stringify({ wordId, status: isChecked, part })
  })
  .then(response => {
    if (!response.ok) {
      alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
      return;
    }

    // æˆåŠŸæ™‚ã®ã¿ãƒ•ãƒ­ãƒ³ãƒˆçŠ¶æ…‹ã‚’åæ˜ 
    const w = words.find(w => String(w.id) === String(wordId));  // â† æ–‡å­—åˆ—æ¯”è¼ƒã«
    if (w) {
      w.status = isChecked;
      const statusSpan = document.getElementById(`status-label-${wordId}`);
      if (statusSpan) {
        statusSpan.innerText = isChecked ? "å­¦ç¿’æ¸ˆã¿" : "æœªå­¦ç¿’";
      }
    }

    updateStatusCount();
  })
  .catch(err => {
    console.error(err);
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
  });
}


function getSwipeExcludedSet(userId){
  const raw = localStorage.getItem(swipeTodayKey(userId));
  return new Set(raw ? JSON.parse(raw) : []); // ["123","456"]
}

function addToSwipeExcluded(userId, wordId){
  const key = swipeTodayKey(userId);
  const set = getSwipeExcludedSet(userId);
  set.add(String(wordId));
  localStorage.setItem(key, JSON.stringify([...set]));
}

// å­¦ç¿’æ¸ˆã¿ä»¶æ•°
async function updateStatusCount() {
  const uid = getUserIdFromQuery() || getUserId();
  const urls = [
    `/api/learning/count?part=${encodeURIComponent(selectedPart)}&userId=${encodeURIComponent(uid)}`,
    `/learning/count?part=${encodeURIComponent(selectedPart)}&userId=${encodeURIComponent(uid)}`,
    `/api/learning/count?part=${encodeURIComponent(selectedPart)}`,
    `/learning/count?part=${encodeURIComponent(selectedPart)}`
  ];

  for (const url of urls) {
    try {
      const res = await apiFetch(url);
      if (!res.ok) continue;
	  const ct = (res.headers.get('content-type') || '').toLowerCase();
      const n  = Number(ct.includes('application/json') ? await res.json() : await res.text());
      const learned = Number.isFinite(n) ? n : 0;
      const total = words.length;
      document.getElementById("learningStatus").textContent =
        `å­¦ç¿’æ¸ˆã¿: ${learned} / æœªå­¦ç¿’: ${Math.max(0, total - learned)}`;
      return;
    } catch {}
  }
  document.getElementById("learningStatus").textContent = "å­¦ç¿’çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
}

async function loadWeeklyAnswers(){
  const uid = getUserIdFromQuery() || getUserId();
  if (!uid) return;

  const candidates = [
    `/api/test/weekly?userId=${encodeURIComponent(uid)}`,
    `/api/test/weekly` // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  ];

  for (const url of candidates) {
    try {
      const res = await apiFetch(url);
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (!res.ok || !ct.includes('application/json')) continue;

      let data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById('weeklyBars').innerHTML = '';
        document.getElementById('weeklyLabels').innerHTML = '';
        return;
      }

      data = data.slice().sort((a,b)=> new Date(a.ymd) - new Date(b.ymd));

      const barsEl   = document.getElementById('weeklyBars');
      const labelsEl = document.getElementById('weeklyLabels');
      barsEl.innerHTML = ''; labelsEl.innerHTML = '';

      const maxAnswers = Math.max(1, ...data.map(d => Number(d.answers || 0)));
      const scaleH = 130;

      data.forEach(d => {
        const answers = Number(d.answers || 0);
        const correct = Number(d.correct || 0);
        const h = Math.max(answers === 0 ? 6 : Math.round((answers / maxAnswers) * scaleH), 6);

        const col = document.createElement('div');
        col.className = 'weekly-day';

        const num = document.createElement('div');
        num.className = 'weekly-num';
        num.textContent = String(correct);
        col.appendChild(num);

        const bar = document.createElement('div');
        bar.className = 'weekly-bar';
        bar.style.height = `${h}px`;
        bar.title = `æ­£è§£: ${correct} / è§£ç­”: ${answers}`;
        col.appendChild(bar);
        barsEl.appendChild(col);

        const dt = new Date(d.ymd);
        const mm = String(dt.getMonth()+1).padStart(2,'0');
        const dd = String(dt.getDate()).padStart(2,'0');
        const youbi = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dt.getDay()];
        const lab = document.createElement('div');
        lab.className = 'weekly-label';
        lab.innerHTML = `<div>${mm}/${dd}</div><div style="opacity:.75">${youbi}</div>`;
        labelsEl.appendChild(lab);
      });
	ã€€ // å¿µã®ãŸã‚JSå´ã§ã‚‚è¡¨ç¤ºã‚’å¼·åˆ¶
ã€€ã€€ã€€ã€€barsEl.style.display = 'flex'; labelsEl.style.display = 'flex';
      return;
    } catch {}
  }
  console.warn('weekly endpoint returned non-JSON, skip');
}

// ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—
function trapFocus(modal){
  const SEL = 'a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])';
  const getNodes = ()=> Array.from(modal.querySelectorAll(SEL)).filter(el=>!el.disabled && el.offsetParent!==null);
  function onKeydown(e){
    if (e.key !== 'Tab') return;
    const nodes = getNodes(); if (!nodes.length) return;
    const first = nodes[0], last = nodes[nodes.length-1];
    if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  }
  modal.addEventListener('keydown', onKeydown);
  return ()=> modal.removeEventListener('keydown', onKeydown);
}

// ä¾‹ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹
let removeTrapLoginBonus = null;
function showLoginBonus(points){
  const title = document.getElementById('loginBonusTitle');
  const grid  = document.getElementById('stampGrid');
  title.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ï¼ˆå­¦ç¿’æ—¥æ•°: ' + points + 'æ—¥ç›®ï¼‰';
  grid.innerHTML = '';
  for (let i=1;i<=7;i++){
    const cell = document.createElement('div');
    cell.style.cssText = 'aspect-ratio:1/1;border:1px dashed #f48fb1;border-radius:8px;display:flex;align-items:center;justify-content:center;';
    cell.textContent = (i <= (points%7||7)) ? 'âœ…' : 'â€”';
    grid.appendChild(cell);
  }
  const popup = document.getElementById('loginBonusPopup');
  popup.style.display = 'flex';
  popup.style.flexDirection = 'column';
  popup.setAttribute('role','dialog');
  popup.setAttribute('aria-modal','true');
  popup.setAttribute('aria-labelledby','loginBonusTitle');
  removeTrapLoginBonus = trapFocus(popup);
  document.body.classList.add('modal-open');
}
	
function closeLoginBonus(){
  const popup = document.getElementById('loginBonusPopup');
  popup.style.display = 'none';
  removeTrapLoginBonus?.();
  document.body.classList.remove('modal-open');
}


	
function getTitleByLevel(level) {
		  if (level >= 20) return "ãƒ›ãƒƒãƒˆãƒ‘ãƒ³ãƒ„ã®è¦‡è€…";
		  if (level >= 15) return "ã‚»ã‚¯ã‚·ãƒ¼å­¦ç¿’ç‹";
		  if (level >= 10) return "ãƒ•ãƒªãƒ•ãƒªç¾å¥³ãƒã‚¹ã‚¿ãƒ¼";
		  if (level >= 5) return "Newbie";
		  return "ãƒ“ã‚®ãƒŠãƒ¼";
}
	
function showPremiumPopup() {
  Swal.fire({
    title: 'ğŸ€ ç¾å¥³å˜ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ ğŸ€',
    html: `
      <div style="text-align:left; font-size: 0.95rem;">
        <p>å…¨ãƒ¢ãƒ¼ãƒ‰è§£æ”¾ï¼†åºƒå‘Šãªã—ã®è´…æ²¢ä½“é¨“</p>
        <ul style="line-height:1.6;">
          <li>âœ” ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰è§£æ”¾</li>
          <li>âœ” ãƒ†ã‚¹ãƒˆå›æ•°ç„¡åˆ¶é™ï¼†æˆç¸¾å±¥æ­´ã‚‚ä¿å­˜</li>
        </ul>
        <p style="font-weight:bold; font-size:1.1rem;">ğŸ’° æœˆé¡300å††ï¼ˆç¨è¾¼ï¼‰</p>
        <p style="color:red;">âœ¨ ä»Šã ã‘åˆæœˆ100å††ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸­ âœ¨</p>
        <small>SNSã§ã‚·ã‚§ã‚¢ã™ã‚‹ã¨1é€±é–“ç„¡æ–™ä½“é¨“ğŸ</small>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«ç™»éŒ²ã™ã‚‹",
    cancelButtonText: "ã‚ã¨ã§è¦‹ã‚‹",
    allowOutsideClick: false,
    customClass: { popup: 'premium-popup', confirmButton: 'btn-premium' }
  }).then(async ({ isConfirmed }) => {
    if (!isConfirmed) return;

    try {
      const r = await apiFetch('/api/payment/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });

      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const ct = r.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await r.json() : null;
		const url = data?.checkoutUrl || data?.url;
		if (!/^https?:\/\//.test(url)) throw new Error('bad url');
			location.assign(url); // â† ã“ã‚Œã ã‘ã§OK
	    } catch (e) {
	      console.error('checkout failed:', e);
	      window.location.href = '/premium.html';
	    }
	  });
}
	
function startTest() {
		  const userId = getUserId();  
		  const testCount = localStorage.getItem("test_started");

		  if (testCount) {
		    alert("åºƒå‘Šã‚’è¦‹ã›ã‚‹å‡¦ç†ï¼ˆä»®ï¼‰");
		  }

		  if (isPremium()) {
		    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¢ãƒ¼ãƒ‰é¸æŠå¯èƒ½
		    Swal.fire({
		      title: "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
		      html: `
		        <button id="readingBtn" class="swal2-confirm swal2-styled" style="margin: 5px;">ğŸ“˜ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</button>
		        <button id="listeningBtn" class="swal2-confirm swal2-styled" style="background:#3949ab;margin: 5px;">ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
		      `,
		      showConfirmButton: false,
		      didOpen: () => {
		        document.getElementById("readingBtn").addEventListener("click", () => {
		          localStorage.setItem("test_started", "1");
		          window.location.href = `test.html?userId=${userId}&mode=reading`;
		        });
		        document.getElementById("listeningBtn").addEventListener("click", () => {
		          localStorage.setItem("test_started", "1");
		          window.location.href = `test.html?userId=${userId}&mode=listening`;
		        });
		      }
		    });
		  } else {
		    // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ã¿ï¼ˆåºƒå‘Šä»˜ãï¼‰
		    Swal.fire({
		      title: "ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ å°‚ç”¨ğŸ§",
		      html: `
		        <p>ä»Šã¯ <strong>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰</strong>ã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
		        <p>ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç™»éŒ²ã§ <strong>éŸ³å£°ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</strong>ã‚‚å¯èƒ½ã«ï¼</p>
		      `,
		      showCancelButton: true,
		      confirmButtonText: "ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§å§‹ã‚ã‚‹",
		      cancelButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’è¦‹ã‚‹",
		    }).then(result => {
		      if (result.isConfirmed) {
		        localStorage.setItem("test_started", "1");
		        window.location.href = `test.html?userId=${userId}&mode=reading`;
		      } else if (result.dismiss === Swal.DismissReason.cancel) {
		        showPremiumPopup(); // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ¡ˆå†…ã‚’è¡¨ç¤º
		      }
		    });
		  }
		}
	
	function startVocabularyTest() {
		  const userId = getUserId();
		  const testCount = localStorage.getItem("test_started");

		  if (testCount) {
		    alert("åºƒå‘Šã‚’è¦‹ã›ã‚‹å‡¦ç†ï¼ˆä»®ï¼‰");
		  }

		  if (isPremium()) {
		    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¢ãƒ¼ãƒ‰é¸æŠå¯èƒ½
		    Swal.fire({
		      title: "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
		      html: `
		        <button id="readingBtn" class="swal2-confirm swal2-styled" style="margin: 5px;">ğŸ“˜ ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</button>
		        <button id="listeningBtn" class="swal2-confirm swal2-styled" style="background:#3949ab;margin: 5px;">ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
		      `,
		      showConfirmButton: false,
		      didOpen: () => {
		        document.getElementById("readingBtn").addEventListener("click", () => {
		          localStorage.setItem("test_started", "1");
		          window.location.href = `vocabularyTest.html?userId=${userId}&mode=reading`;
		        });
		        document.getElementById("listeningBtn").addEventListener("click", () => {
		          localStorage.setItem("test_started", "1");
		          window.location.href = `vocabularyTest.html?userId=${userId}&mode=listening`;
		        });
		      }
		    });
		  } else {
		    // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ã¿ï¼ˆåºƒå‘Šä»˜ãï¼‰
		    Swal.fire({
		      title: "ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ å°‚ç”¨ğŸ§",
		      html: `
		        <p>ä»Šã¯ <strong>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰</strong>ã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
		        <p>ğŸ€ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç™»éŒ²ã§ <strong>éŸ³å£°ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</strong>ã‚‚å¯èƒ½ã«ï¼</p>
		      `,
		      showCancelButton: true,
		      confirmButtonText: "ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§å§‹ã‚ã‚‹",
		      cancelButtonText: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’è¦‹ã‚‹",
		    }).then(result => {
		      if (result.isConfirmed) {
		        localStorage.setItem("test_started", "1");
		        window.location.href = `vocabularyTest.html?userId=${userId}&mode=reading`;
		      } else if (result.dismiss === Swal.DismissReason.cancel) {
		        showPremiumPopup(); // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ¡ˆå†…ã‚’è¡¨ç¤º
		      }
		    });
		  }
		}
// ç´¯è¨ˆæ­£ç­”ã¨å­¦ç¿’æ—¥æ•°ã‚’ /user/me ã‹ã‚‰æ›´æ–°ã€‚
// loginPoints ãŒãªã‘ã‚Œã° /api/test/weekly ã‹ã‚‰ç›´è¿‘7æ—¥ã®å­¦ç¿’æ—¥æ•°ç›¸å½“ã‚’è¡¨ç¤ºã€‚
let _statsRetry = 0;
// ç´¯è¨ˆæ­£ç­”ã¨å­¦ç¿’æ—¥æ•°ã‚’ /user/me ã‹ã‚‰æ›´æ–°ã€‚
// loginPoints ãŒãªã‘ã‚Œã° /api/test/weekly ã‹ã‚‰ç›´è¿‘7æ—¥ã®å­¦ç¿’æ—¥æ•°ç›¸å½“ã‚’è¡¨ç¤ºã€‚
// ç½®ãæ›ãˆï¼š/api/me å„ªå…ˆï¼‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
async function refreshUserStats() {
  const candidates = ['/api/me', '/user/me', '/api/user/me'];
  let u = null;

  for (const url of candidates) {
    try { u = await fetchJSON(url); break; } catch { /* æ¬¡ã®å€™è£œã¸ */ }
  }

  if (u) {
    // å­¦ç¿’æ—¥æ•°
    const days = (typeof u.loginPoints === 'number') ? u.loginPoints : 0;
    const loginDaysEl = document.getElementById("loginDays");
    if (loginDaysEl) loginDaysEl.textContent = `å­¦ç¿’æ—¥æ•°: ${days}æ—¥ç›®`;

    // ç´¯è¨ˆæ­£ç­” â†’ ãƒ¬ãƒ™ãƒ«æ›´æ–°
    const totalCorrect = Number(u.testCorrectTotal ?? 0);
    const testStatsEl = document.getElementById("testStats");
    if (testStatsEl) testStatsEl.textContent = `æ­£ç­”æ•°ï¼ˆç´¯è¨ˆï¼‰: ${totalCorrect}`;

    const newLevel = Math.max(1, Math.floor(totalCorrect / 10) + 1);
    const currentLevel = Number(u.level ?? 1);
    if (currentLevel !== newLevel) {
      try {
        const r = await apiFetch(`/api/user/updateLevel`, {  // â† /api ã«çµ±ä¸€
          method:'PUT',
          headers:{ 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: getUserId(), level: newLevel })
        });
        if (r.ok) {
          const j = await r.json().catch(()=>({}));
          u.level = Number(j.level ?? newLevel);
        } else {
          u.level = newLevel;
        }
      } catch {
        u.level = newLevel;
      }
    }
    const levelEl = document.getElementById("userLevel");
    const lv = Number(u.level ?? 1);
    if (levelEl) levelEl.textContent = `ãƒ¬ãƒ™ãƒ«: Lv.${lv}`;
    updateGirlVisual(lv);

    // ãƒ¬ãƒ™ãƒ«æ¼”å‡ºï¼ˆå‰å›ã¨ã®å·®åˆ†ï¼‰
    const prev = parseInt(localStorage.getItem('previousCorrect') || '0', 10);
    const prevLv = Math.floor(prev / 10);
    const newLv  = Math.floor(totalCorrect / 10);
    if (newLv > prevLv) {
      for (let lv2 = prevLv + 1; lv2 <= newLv; lv2++) showLevelUpPopup(lv2);
    }
    localStorage.setItem('previousCorrect', String(totalCorrect));
    return;
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç›´è¿‘7æ—¥ã®å­¦ç¿’æ—¥æ•°ç›¸å½“
  try {
    const r2 = await apiFetch('/api/test/weekly');
    const ct = r2.headers.get('content-type') || '';
    if (r2.ok && ct.includes('application/json')) {
      const w = await r2.json();
      const days = Array.isArray(w) ? w.filter(d => (d.answers ?? 0) > 0).length : 0;
      const loginDaysEl = document.getElementById("loginDays");
      if (loginDaysEl) loginDaysEl.textContent = `å­¦ç¿’æ—¥æ•°(ç›´è¿‘7æ—¥): ${days}æ—¥`;
    }
  } catch {}
}
	
async function setUserPremium(userId) {
  try {
    const res = await apiFetch(`/api/user/updatePremium`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    if (!res.ok) throw new Error("æ›´æ–°ã«å¤±æ•—");
    console.log("âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã‚’DBã«åæ˜ ã—ã¾ã—ãŸ");
  } catch (err) {
    console.error("âŒ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è¨­å®šå¤±æ•—:", err);
  }
}

	
	// ===== ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ =====
	let swipeWords = [];      // ä»Šã®ãƒ‘ãƒ¼ãƒˆã®å˜èªé…åˆ—ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ï¼‰
	let swipeIndex = 0;       // å…ˆé ­ã‹ã‚‰ä½•æšç›®ã‹
	let swipeLearned = 0;     // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã€Œè¦šãˆãŸã€ã«ã—ãŸæ•°
	let swipeUnlearned = 0;   // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã€Œè¦šãˆã¦ãªã„ã€ã«ã—ãŸæ•°
	let swipeDrag = null;     // {startX, startY, el}
	// æ—¢å­˜ã®ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨å¤‰æ•°ã®è¿‘ãã«è¿½åŠ 
	let currentSwipeMode = "unlearned"; // 'unlearned' or 'review'
	const SWIPE_THRESHOLD = 80; // ä½•pxä»¥ä¸Šã§ç¢ºå®šã¨ã¿ãªã™
	
	// ğŸ”¸ ä»Šæ—¥ã®æ—¥ä»˜ã‚­ãƒ¼
	function swipeTodayKey(userId){
	  const d = new Date();
	  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
	  return `swipeExcluded:${userId}:${ymd}`;   // ä¾‹: swipeExcluded:1:2025-08-24
	}
	
	function todayKey(type){
		  const d = new Date();
		  const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
		  return `swipe:${type}:${getUserId()}:${ymd}`;
		}

		function getTodaySet(type){
		  const raw = localStorage.getItem(todayKey(type));
		  return new Set(raw ? JSON.parse(raw) : []);
		}

		function addTodaySet(type, wordId){
		  const set = getTodaySet(type);
		  set.add(wordId);
		  localStorage.setItem(todayKey(type), JSON.stringify([...set]));
		}
	
function setSwipeModeVisible(show){
  const box = document.getElementById('swipeModeBox');
  box.classList.toggle('hidden', !show);

  // ä¸€è¦§ç³»ã®è¡¨ç¤º/éè¡¨ç¤º
  ['wordContainer','pagination','test-section','weeklyAnswersBox'].forEach(id=>{
    document.getElementById(id)?.classList.toggle('hidden', show);
  });

  document.querySelectorAll('button:not([type])').forEach(b => b.type = 'button');

  const isMobile = window.matchMedia('(max-width:480px)').matches;
  if (show && isMobile){
    box.classList.add('fullscreen');
    document.body.classList.add('swipe-open');
    requestAnimationFrame(resizeSwipeDeck);
  }else{
    box.classList.remove('fullscreen');
    document.body.classList.remove('swipe-open');
  }

  ['partButtons','partPagination'].forEach(id=>{
    document.getElementById(id)?.classList.toggle('hidden', show);
  });
}

function resizeSwipeDeck(){
  const box = document.getElementById('swipeModeBox');
  const deck = document.getElementById('swipeDeck');
  if (!box || !deck) return;
  // ã‚°ãƒªãƒƒãƒ‰ã§1frã«ã—ã¦ã„ã‚‹ã®ã§æ˜ç¤ºæŒ‡å®šã¯ä¸è¦ã ãŒã€
  // iOSã®ä¸€éƒ¨ã§é«˜ã•ãŒè¶³ã‚Šãªãè¦‹ãˆã‚‹æ™‚ã®ä¿é™ºã¨ã—ã¦æœ€ä½é«˜ã•ã ã‘ä¸ãˆã‚‹
  const h = Math.max(320, box.clientHeight - 96); // ã ã„ãŸã„HUD+ãƒ’ãƒ³ãƒˆã¶ã‚“
  deck.style.minHeight = h + 'px';
}
window.addEventListener('resize', () => {
  if (!document.getElementById('swipeModeBox').classList.contains('hidden')) {
    resizeSwipeDeck();
  }
});



	// âœ… ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’é–‹å§‹æ™‚ï¼šæœ€åˆã«åºƒå‘Š â†’ çµ‚äº†å¾Œãƒ¢ãƒ¼ãƒ‰é¸æŠ
	function startSwipeMode(partValue = selectedPart){
	  placeSwipeBoxAboveStartButton();   // â† è¿½åŠ 
	  selectedPart = partValue;

	  const lockedParts = ["part4", "part5", "part6", "partHealing", "musou"];
	  const isLocked = lockedParts.includes(selectedPart);
	  const premium = isPremium();
  const htmlMsg = premium
    ? "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã®ãŸã‚åºƒå‘Šã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚<br>å­¦ç¿’ã‚’å§‹ã‚ã¾ã™ï¼"
    : "å­¦ç¿’é–‹å§‹å‰ã¨çµ‚äº†æ™‚ã«åºƒå‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆè¨ˆ2å›ï¼‰<br>ç¾å¥³ã¨ä¸€ç·’ã«æ¥½ã—ãå­¦ç¿’ã—ã¾ã—ã‚‡ã†ï¼";

  Swal.fire({
    title: "ç¾å¥³ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ğŸ€",
    html: htmlMsg,
    icon: "info",
    confirmButtonText: premium ? "å­¦ç¿’ã‚’å§‹ã‚ã‚‹" : "åºƒå‘Šã‚’è¦‹ã‚‹",
    confirmButtonColor: "#e91e63",
    allowOutsideClick: false
  }).then(() => {
    if (!premium) {
      pendingToggle = showSwipeModeSelection; // æˆåŠŸå¾Œã«ç¶šè¡Œ
      showAd();
    } else {
      showSwipeModeSelection();
    }
  });
}

	// âœ… ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆåˆ†é›¢ã—ã¦ä½¿ã„ã‚„ã™ãï¼‰
	function showSwipeModeSelection() {
	  Swal.fire({
	    title: "ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­",
	    html: `
	      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
	        <button id="btnUnlearned" class="swal2-confirm swal2-styled">æœªå­¦ç¿’ã‚’è¦šãˆã‚‹</button>
	        <button id="btnReview" class="swal2-confirm swal2-styled" style="background:#3949ab">å¾©ç¿’ãƒã‚§ãƒƒã‚¯</button>
	      </div>
	    `,
	    showConfirmButton: false,
	    didOpen: () => {
	      document.getElementById("btnUnlearned").onclick = () => {
	        currentSwipeMode = "unlearned";
	        Swal.close();
	        initSwipeMode("unlearned");
	      };
	      document.getElementById("btnReview").onclick = () => {
	        currentSwipeMode = "review";
	        Swal.close();
	        initSwipeMode("review");
	      };
	    }
	  });
	}

function scrollToSwipeTop(){
  const box = document.getElementById('swipeModeBox');
  if (!box) return;
  box.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* A) æ¨ªæ–¹å‘ã®ã‚¿ãƒƒãƒç§»å‹•ã¯æ—¢å®šå‹•ä½œã‚’æ­¢ã‚ã‚‹ï¼ˆiOSå¯¾ç­–ï¼‰ */
function preventIOSBackSwipe(){
  const deck = document.getElementById('swipeDeck');
  if (!deck || deck._iosGuardInstalled) return;
  let sx = 0, sy = 0;
  deck.addEventListener('touchstart', e => {
    const t = e.touches && e.touches[0];
    if (!t) return;
    sx = t.clientX; sy = t.clientY;
  }, {passive:true});
  deck.addEventListener('touchmove', e => {
    const t = e.touches && e.touches[0];
    if (!t) return;
    const dx = Math.abs(t.clientX - sx);
    const dy = Math.abs(t.clientY - sy);
    if (dx > dy && dx > 8) {
      // æ¨ªæ–¹å‘ã®æ“ä½œã£ã½ã„æ™‚ã ã‘æ—¢å®šå‹•ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      e.preventDefault();
    }
  }, {passive:false});
  deck._iosGuardInstalled = true;
}

/* B) ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã ã‘â€œæˆ»ã‚‹ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼â€ã‚’æ•ã¾ãˆã¦ä¸€è¦§ã«æˆ»ã™ */
// ã“ã‚Œã‚’1ç®‡æ‰€ã«é›†ç´„
let _ignoreNextPop = false;
let _backGuardHandler = null;

function enableSwipeBackGuard() {
  if (_backGuardHandler) return;
  history.pushState({ swipe: 'on' }, '');
  _backGuardHandler = () => {
    // â† è¿½åŠ ã® pushState ã¯ã—ãªã„
    exitSwipeMode(true); // fromBack = true
  };
  window.addEventListener('popstate', _backGuardHandler);
}

function disableSwipeBackGuard() {
  if (!_backGuardHandler) return;
  window.removeEventListener('popstate', _backGuardHandler);
  _backGuardHandler = null;
}

function exitSwipeMode(fromBack = false) {
  setSwipeModeVisible(false);
  renderWords();
  updateStatusCount();
  disableSwipeBackGuard();
  if (!isPremium()) showAd();

  // â† ã€Œä¸€è¦§ã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ç­‰ã§é–‰ã˜ãŸã¨ãã ã‘ã€ã‚¬ãƒ¼ãƒ‰åˆ†ã®1ã¤ã‚’æˆ»ã™
  if (!fromBack) history.back();
}
	
async function initSwipeMode(mode = "unlearned"){
  currentSwipeMode = mode;
  setSwipeModeVisible(true);
  showSwipeHowToIfNeeded(); // setSwipeModeVisible(true) ã®ç›´å¾Œãªã©
  requestAnimationFrame(scrollToSwipeTop);  // â† è¿½åŠ 

  const userId = getUserIdFromQuery() || getUserId();
	// è©²å½“éƒ¨åˆ†ã®ã¿ç½®ãæ›ãˆ
	if (!Array.isArray(words) || words.length === 0) {
	  words = await fetchWordsFromServer(selectedPart); // â† userIdã‚’æ¸¡ã•ãªã„
	}
  swipeWords = await buildSwipeDeck(mode);
  if (swipeWords.length === 0) {
    Swal.fire({icon:'info', title:(mode==="review"?"ä»Šæ—¥ã¯å¾©ç¿’ãŒã‚ã‚Šã¾ã›ã‚“":"ä»Šæ—¥ã¯æœªå­¦ç¿’ãŒã‚ã‚Šã¾ã›ã‚“")});
    setSwipeModeVisible(false);
    return;
  }
  swipeIndex = 0; swipeLearned = 0; swipeUnlearned = 0;
  await renderSwipeDeck();
  updateSwipeHUD();
  document.getElementById('swipeExitBtn').onclick = () => exitSwipeMode(false);

  // iOSã®æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—å¹²æ¸‰å¯¾ç­–ï¼ˆä¸‹ã® 3) ã¨ã‚»ãƒƒãƒˆï¼‰
  preventIOSBackSwipe();
  enableSwipeBackGuard();
}		
		// ğŸ”¸ ã‚¹ãƒ¯ã‚¤ãƒ—ç”¨ãƒ‡ãƒƒã‚­ã‚’çµ„ã‚€ï¼ˆæœªå­¦ç¿’ã®ã¿ + ä»Šæ—¥ã®é™¤å¤–ã‚’å¼•ãï¼‰
// ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆFisherâ€“Yatesï¼‰
// ãƒ©ãƒ³ãƒ€ãƒ ã«é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆin-placeï¼‰
// in-place shuffle
function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/**
 * æœªå­¦ç¿’ã‚’å„ªå…ˆã—ã¦ N æšã§ãƒ‡ãƒƒã‚­æ§‹ç¯‰ï¼ˆæœªå­¦ç¿’:reviewRatio[0], å¾©ç¿’:reviewRatio[1]ï¼‰
 * è¶³ã‚Šãªã„ã¨ãã¯ç›¸äº’ã«èé€šã—ã€ãã‚Œã§ã‚‚è¶³ã‚Šãªã‘ã‚Œã°é™¤å¤–ç„¡è¦–ã§è£œå……
 */
//shuffle ã¯ãã®ã¾ã¾åˆ©ç”¨

async function buildSwipeDeck(mode = "unlearned"){
  const userId   = getUserIdFromQuery() || getUserId();
  const excluded = getSwipeExcludedSet(userId);

  // ã“ã“ã‚’è¿½åŠ 
ã€€const hasId = w => Number.isFinite(w?.id);
  const allUnlearned = words.filter(w => !w.status && hasId(w));
  const allLearned   = words.filter(w =>  w.status && hasId(w));

  let unlearned = allUnlearned.filter(w => !excluded.has(String(w.id)));
  let learned   = allLearned  .filter(w => !excluded.has(String(w.id)));

  // å¾©ç¿’å€™è£œã‚¼ãƒ­ã®æ•‘æ¸ˆã¯ãã®ã¾ã¾
  if (mode === "review" && learned.length === 0 && allLearned.length > 0) {
    learned = allLearned.slice();
  }
  shuffle(unlearned); shuffle(learned);
  if (mode === "unlearned") return shuffle(unlearned.slice(0, 10));
  if (mode === "review")    return shuffle(learned.slice(0, 10));
  return shuffle([...unlearned.slice(0,25), ...learned.slice(0,5)]);
}
	
	// ãƒ‡ãƒƒã‚­æç”»ï¼ˆå…ˆé ­3æšã ã‘ç©ã‚€ï¼‰
// ãƒ‡ãƒƒã‚­æç”»ï¼ˆå…ˆé ­3æšã ã‘ç©ã‚€ï¼‰
async function renderSwipeDeck(){
  // DOMã®ãƒ‡ãƒƒã‚­è¦ç´ 
  const deckEl = document.getElementById('swipeDeck');
  deckEl.innerHTML = '';

  // swipeWords ãŒã¾ã ç”¨æ„ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½œã‚‹
if (!Array.isArray(swipeWords) || swipeWords.length === 0) {
	// ç¾åœ¨é¸æŠä¸­ã®ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒƒã‚­ã‚’ä½œã‚‹
	swipeWords = await buildSwipeDeck(currentSwipeMode);
	console.log('deck size:', swipeWords.length,
            'unlearned total:', words.filter(w=>!w.status).length,
            'learned total:', words.filter(w=> w.status).length);
}

  // ä»Šã®ä½ç½®ã‹ã‚‰3æšã ã‘æç”»
  const show = swipeWords.slice(swipeIndex, Math.min(swipeIndex + 3, swipeWords.length));

  show.forEach((w, idx) => {
    const card = document.createElement('div');
    card.className = 'swipe-card';
    card.style.zIndex = String(100 - idx);
    card.dataset.index = String(swipeIndex + idx);

    // renderSwipeDeck
	const src = safeSrc(imageUrlForWord(w), { allowDataImage: true });

    card.innerHTML = `
    	  <div class="swipe-badge badge-left">è¦šãˆã¦ãªã„</div>
    	  <div class="swipe-badge badge-right">è¦šãˆãŸï¼</div>
    	  <div class="swipe-word">${esc(w.word)}</div>
    	  <div class="swipe-mean">(${esc(w.meaning)})</div>
    	  <img class="swipe-img" src="${src}" alt="${esc(w.word)}" draggable="false">
    	`;

    // ç”»åƒãŒ404ã®æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const imgEl = card.querySelector('.swipe-img');
    imgEl.onerror = () => { imgEl.src = '/images/beauty.png'; };

    attachSwipeHandlers(card);
    deckEl.appendChild(card);
  });
}


	// 1æšã®ã‚«ãƒ¼ãƒ‰ã«ãƒ‰ãƒ©ãƒƒã‚°/ã‚¿ãƒƒãƒæ“ä½œã‚’ä»˜ä¸
function attachSwipeHandlers(card){
  card.addEventListener('pointerdown', e => {
    e.preventDefault();                 // â† æ—¢å®šå‹•ä½œ(ç”»åƒãƒ‰ãƒ©ãƒƒã‚°ç­‰)ã‚’æŠ‘æ­¢
    card.setPointerCapture(e.pointerId);
    swipeDrag = {startX:e.clientX, startY:e.clientY, el:card};
    card.style.transition = 'none';
  });

  card.addEventListener('pointermove', e => {
    if(!swipeDrag || swipeDrag.el!==card) return;
    const dx = e.clientX - swipeDrag.startX;
    const dy = e.clientY - swipeDrag.startY;
    const rot = dx * 0.05;
    card.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;
    const left  = card.querySelector('.badge-left');
    const right = card.querySelector('.badge-right');
    if(dx < -20){ left.style.opacity = Math.min(1, (-dx)/80); right.style.opacity = 0; }
    else if(dx > 20){ right.style.opacity = Math.min(1, (dx)/80); left.style.opacity = 0; }
    else { left.style.opacity = right.style.opacity = 0; }
  });

  card.addEventListener('pointerup',     e => endSwipe(card, e));

  // â† ã“ã“ã‚’â€œãƒªã‚»ãƒƒãƒˆã®ã¿â€ã«
  card.addEventListener('pointercancel', () => {
    card.style.transition = '.2s ease';
    card.style.transform = 'translate(0,0) rotate(0)';
    card.querySelector('.badge-left').style.opacity  = 0;
    card.querySelector('.badge-right').style.opacity = 0;
    swipeDrag = null;
  });

  // å¿µã®ãŸã‚ HTML5 ã® dragstart ã‚‚æ®ºã™
  card.addEventListener('dragstart', e => e.preventDefault());
}


	function endSwipe(card, e){
	  if(!swipeDrag){ return; }
	  const dx = e.clientX - swipeDrag.startX;
	  swipeDrag = null;

	  // ç¢ºå®šåˆ¤å®š
	  if(dx <= -SWIPE_THRESHOLD){
	    // å·¦ï¼šè¦šãˆã¦ãªã„
	    decideSwipe(card, 'left');
	  }else if(dx >= SWIPE_THRESHOLD){
	    // å³ï¼šè¦šãˆãŸ
	    decideSwipe(card, 'right');
	  }else{
	    // æˆ»ã™
	    card.style.transition = '.2s ease';
	    card.style.transform = 'translate(0,0) rotate(0)';
	    card.querySelector('.badge-left').style.opacity = 0;
	    card.querySelector('.badge-right').style.opacity = 0;
	  }
	}

	// åæ˜ ï¼†æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã¸
// æ—¢å­˜ã® decideSwipe ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ
async function decideSwipe(card, dir){
  const i = swipeIndex;
  const w = swipeWords[i];
  const isRight = (dir === 'right');

  // ã‚¢ãƒ‹ãƒ¡
  card.style.transition = '.2s ease';
  const off = (isRight ? 600 : -600);
  card.style.transform = `translate(${off}px,-40px) rotate(${off>0?15:-15}deg)`;
  setTimeout(() => card.remove(), 200);

  if (currentSwipeMode === "unlearned") {
    if (isRight) {
      addTodaySet('learned', w.id);
      addToSwipeExcluded(getUserId(), w.id);
      swipeLearned++;
      onSwipeRightLearned(w);
      swipeIndex++; // å³ã¯ç¢ºå®šãªã®ã§é€²ã‚ã‚‹
    } else {
      // â† å·¦ã¯ä»Šã®è¦ç´ ã‚’æœ«å°¾ã¸ç§»å‹•ï¼ˆé‡è¤‡ã•ã›ãªã„ï¼‰
      const [cur] = swipeWords.splice(i, 1);
      swipeWords.push(cur);
      addTodaySet('unlearned', w.id);
      swipeUnlearned++;
      // swipeIndex ã¯æ®ãˆç½®ãï¼šåŒã˜ i ã«æ¬¡ã®ã‚«ãƒ¼ãƒ‰ãŒå…¥ã‚‹
    }
  } else { // review
    if (isRight) { swipeLearned++; addTodaySet('review_ok', w.id); }
    else         { swipeUnlearned++; addTodaySet('review_ng', w.id); }
    addToSwipeExcluded(getUserId(), w.id);
    swipeIndex++;
  }

  updateSwipeHUD();

  if (!isPremium() && AD_EVERY_SWIPE > 0 &&
      swipeIndex % AD_EVERY_SWIPE === 0 &&
      swipeIndex < swipeWords.length) {
    showAd();
  }

  if (swipeIndex < swipeWords.length) await renderSwipeDeck();
  else                                 exitSwipeMode();
}



//æ—¢å­˜ã® updateSwipeHUD ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ
function updateSwipeHUD(){
  const total = swipeWords.length;
  document.getElementById('swipeCounter').textContent = `${swipeIndex}/${total}`;

  if (currentSwipeMode === "unlearned") {
    // å½“æ—¥ãƒ¡ãƒ¢ï¼ˆæœªå­¦ç¿’ç”¨ï¼‰
    const learnedSet   = getTodaySet('learned');
    const unlearnedSet = getTodaySet('unlearned');
    document.getElementById('swipeStats').textContent =
      `è¦šãˆãŸ: ${learnedSet.size} / è¦šãˆã¦ãªã„: ${unlearnedSet.size}`;
  } else {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå¾©ç¿’ç”¨ï¼‰
    document.getElementById('swipeStats').textContent =
      `OK: ${swipeLearned} / å¿˜ã‚Œã¦ã„ãŸ: ${swipeUnlearned}`;
  }
}

// å…ˆé ­ã‚ãŸã‚Šã«
const getCSRFFromCookie = (name='_csrf') => {
  const m = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]+)`));
  return m ? decodeURIComponent(m[1]) : null;
};

// ç½®ãæ›ãˆ
// â† ã“ã‚Œã§ç½®ãæ›ãˆ
async function onSwipeRightLearned(word){
    if (!Number.isFinite(word?.id)) {
    // idç„¡ã—ã¯DBæ›´æ–°ã‚¹ã‚­ãƒƒãƒ—ã€‚ä»Šæ—¥ã®é™¤å¤–ã ã‘åæ˜ 
    addToSwipeExcluded(getUserId(), word.id);
    return;
  }
  try{
    await apiFetch('/api/learning/update', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ wordId: word.id, status: true, part: selectedPart })
    });
    const w = words.find(x => String(x.id) === String(word.id));
    if (w) w.status = true;
    addToSwipeExcluded(getUserId(), word.id);
  }catch(e){
    console.warn('update failed (swipe right):', e);
  }
}  
    const SWIPE_TUTOR_KEY = 'swipe_tutorial_shown_v1';

    function showSwipeHowToIfNeeded(){
      if (localStorage.getItem(SWIPE_TUTOR_KEY) === '1') return;
      Swal.fire({
        title: 'ã‚¹ãƒ¯ã‚¤ãƒ—å­¦ç¿’ã®ã‚³ãƒ„',
        html: `
          <div style="text-align:left;line-height:1.8">
            <p>ãƒ»å³ã‚¹ãƒ¯ã‚¤ãƒ— = <b>è¦šãˆãŸï¼â†’ å­¦ç¿’æ¸ˆã¿ã«åæ˜ </b></p>
            <p>ãƒ»å·¦ã‚¹ãƒ¯ã‚¤ãƒ— = ã¾ã è¦šãˆã¦ãªã„ï¼ˆãƒ‡ãƒƒã‚­å¾Œæ–¹ã¸ï¼‰</p>
            <p>ãƒ»ä»Šæ—¥è¦šãˆãŸå˜èªã¯ã€<b>ãã®æ—¥ã¯å†è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</b></p>
            <p>ãƒ»å¯¾è±¡ã¯ <b>æœªå­¦ç¿’ã ã‘</b>ã€‚åŠ¹ç‡ã‚ˆãè¦šãˆã‚ˆã†ï¼</p>
          </div>
        `,
        confirmButtonText: 'OK',
        confirmButtonColor: '#e91e63'
      }).then(()=> localStorage.setItem(SWIPE_TUTOR_KEY,'1'));
    }

document.addEventListener('keydown', (e) => {
  // Esc ã§ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ã‚’é–‰ã˜ã‚‹
  if (e.key === 'Escape') {
    const ad = document.getElementById('adModal');
    if (ad?.style.display === 'flex') closeAdModal();

    const vm = document.getElementById('videoModal');
    const vp = document.getElementById('videoPlayer');
    if (vm?.style.display === 'flex') { vm.style.display = 'none'; vp?.pause(); }

    const box = document.getElementById('swipeModeBox');
    if (!box.classList.contains('hidden')) exitSwipeMode();
    return;
  }

  // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®ã¿ â† / â†’ ã‚’åŠ¹ã‹ã›ã‚‹
  const box = document.getElementById('swipeModeBox');
  if (box.classList.contains('hidden')) return;

  const top = document.querySelector(`.swipe-card[data-index="${swipeIndex}"]`);
  if (!top) return;

  if (e.key === 'ArrowRight') { e.preventDefault(); decideSwipe(top, 'right'); }
  if (e.key === 'ArrowLeft')  { e.preventDefault(); decideSwipe(top, 'left');  }
});
	</script>
ã€€ã€€<!-- ã‚«ã‚¹ã‚¿ãƒ åºƒå‘Šãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div
  id="adModal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="adModalTitle"
  style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:10000;"
>
  <div role="document" style="margin:auto; background:#fff; border-radius:12px; padding:16px; width:min(420px,90%); box-shadow:0 8px 20px rgba(0,0,0,.2)">
    <h3 id="adModalTitle" style="margin-top:0">åºƒå‘Šã‚’è¦‹ã‚‹</h3>
    <p style="margin:8px 0 0">è¦–è´ã™ã‚‹ã¨<strong>5åˆ†é–“</strong>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½ãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚</p>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px">
      <button id="cancelAdBtn" class="btn btn-secondary" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="watchAdBtn" class="btn btn-primary" type="button">è¦–è´ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- ad modal (æœ€å°æ§‹æˆ) -->
<div id="adModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:99999; align-items:center; justify-content:center;">
  <div role="dialog" aria-modal="true" style="background:#fff; padding:16px; border-radius:10px; max-width:360px; width:90%;">
    <p>åºƒå‘Šã‚’è¦–è´ã™ã‚‹ã¨5åˆ†é–“è§£æ”¾ã•ã‚Œã¾ã™ã€‚</p>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="cancelAdBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="watchAdBtn">åºƒå‘Šã‚’è¦‹ã‚‹</button>
    </div>
  </div>
</div>


	</body>
	</html>
