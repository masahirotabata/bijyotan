<script>
function getUserId(){
  const q = new URLSearchParams(location.search).get("userId");
  const ls = localStorage.getItem("userId");
  const id = parseInt(q ?? ls, 10);
  return Number.isFinite(id) ? id : null;
}

async function onPaymentSuccess(){
  const userId = getUserId();
  if(!userId){ alert("ユーザーIDが取得できませんでした"); return; }

  try {
    const res = await fetch(`/user/upgrade?userId=${userId}`, {
      method: "PUT",
      credentials: "include"
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    // ← ここで明示的に遷移する（サーバの302には頼らない）
    window.location.replace(`/user.html?userId=${userId}`);
  } catch (e) {
    console.error(e);
    alert("アップグレードに失敗しました");
  }
}

window.addEventListener("DOMContentLoaded", onPaymentSuccess);
</script>
