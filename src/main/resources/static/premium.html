<script>
function getUserId() {
  const q = new URLSearchParams(location.search).get("userId");
  const ls = localStorage.getItem("userId");
  const id = parseInt(q ?? ls, 10);
  return Number.isFinite(id) ? id : null;
}

async function onPaymentSuccess() {
  const userId = getUserId();
  if (!userId) {
    alert("ユーザーIDが取得できませんでした。ログインし直してください。");
    return;
  }

  try {
    const res = await fetch(`/user/upgrade?userId=${userId}`, {
      method: "PUT",              // ← ここにカンマが必要
      credentials: "include"      // セッションCookieを使うなら付ける
      // headers: { "Content-Type": "text/plain" } // ボディ無しなので通常は不要
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const msg = await res.text();
    alert(msg || "アップグレード成功");
    location.href = `user.html?userId=${userId}`;
  } catch (err) {
    console.error(err);
    alert("アップグレードに失敗しました");
  }
}

window.addEventListener("DOMContentLoaded", onPaymentSuccess);
</script>
