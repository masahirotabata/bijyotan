<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>美女単 - スタート</title>
  <style>
    body{margin:0;padding:0;min-height:100svh;display:grid;place-items:center;
         background:linear-gradient(135deg,#f8e8f0,#f0f8ff);font-family:system-ui,Arial,sans-serif}
    .wrap{text-align:center;padding:24px}
    h1{font-size:clamp(22px,5vw,32px);color:#e91e63;margin:0 0 18px}
    p{color:#555;margin:0 0 22px}
    button{font-size:1.1rem;padding:14px 28px;background:#ff4081;border:0;border-radius:9999px;
           color:#fff;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.08);transition:opacity .2s}
    button:disabled{opacity:.6;cursor:default}
    .links{margin-top:14px;font-size:.95rem}
    .links a{color:#e91e63;text-decoration:none;margin:0 8px}
    .links a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>びじょたん！へようこそ</h1>
    <p>START を押すと、ログイン済みならそのまま続きへ。</p>
    <button id="startBtn">START</button>
    <!-- セカンダリ導線（ワンタップ主義は崩さず、困った時用） -->
    <div class="links">
      <a href="/register.html">新規登録</a> /
      <a href="/login.html?from=start">ログイン</a>
    </div>
  </div>

  <script>
    // セッション確認 → userId を返す（なければ null）
    async function resolveUserId() {
      try {
        const res = await fetch('/api/me', {
          credentials: 'include',
          cache: 'no-store',
        });
        if (res.ok) {
          const me = await res.json().catch(() => null);
          if (me && (me.id ?? me.userId)) {
            const id = me.id ?? me.userId;
            localStorage.setItem('userId', String(id)); // 次回以降のフォールバック
            return id;
          }
        }
      } catch (_) {}
      // フォールバック：以前の userId が残っていれば使う（未ログイン時は意味なし）
      const ls = parseInt(localStorage.getItem('userId') || '', 10);
      return Number.isFinite(ls) ? ls : null;
    }

  async function startApp() {
  // 多重押下防止
  const btn = document.querySelector('button[onclick="startApp()"]');
  btn?.setAttribute('disabled', 'disabled');

  try {
    // まずサーバセッションを確認
    const r = await fetch('/api/me', { credentials: 'include', cache: 'no-store' });
    if (r.ok) {
      const me = await r.json().catch(() => ({}));
      if (me?.id) {
        localStorage.setItem('userId', String(me.id));   // ローカルにも保持
        location.assign(`/user.html?userId=${encodeURIComponent(me.id)}`);
        return;
      }
    }
    // セッションがなければログインへ
    location.assign('/login.html');
  } catch (_) {
    // 通信失敗時もログインへ
    location.assign('/login.html');
  }
}

    document.getElementById('startBtn').addEventListener('click', startApp);

    // 便利オプション：すでにセッションがあれば自動で user.html へ（ワンタップを飛ばす）
    // 使いたい場合は true に
    const AUTO_REDIRECT = false;
    if (AUTO_REDIRECT) {
      resolveUserId().then(id => { if (id) location.replace(`/user.html?userId=${id}`); });
    }
  </script>
</body>
</html>
