<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç¾å¥³å˜ãƒ†ã‚¹ãƒˆ (CSVç‰ˆ)</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #f5f8ff; margin: 0; padding: 20px; }

  @keyframes smile { 0% { transform: scale(1);} 50% { transform: scale(1.05); filter: brightness(1.2);} 100% { transform: scale(1);} }
  .smile-animation { animation: smile 0.6s ease-in-out; }

  #sentence { font-size: 24px; margin: 20px 0; }

  /* 2åˆ—ã‚°ãƒªãƒƒãƒ‰ã€‚ç«¯æœ«å¹…ã§è‡ªå‹•æŠ˜è¿”ã— */
  .option-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    max-width: 600px;
    margin: 0 auto;
  }

/* â˜…ã‚«ãƒ¼ãƒ‰ã®è¦‹ãŸç›®ã¨ã‚µã‚¤ã‚ºçµ±ä¸€ï¼ˆé«˜ã•ã‚’å°‘ã—å¤§ãã‚ã«ï¼‰ */
.option-grid img {
  display: block;
  width: 100%;
  height: 450px;         /* â† é«˜ã•ã‚’æ‹¡å¤§ï¼ˆ220px â†’ 320pxï¼‰ */
  object-fit: cover;     /* ä¸­å¤®ã§ãƒˆãƒªãƒŸãƒ³ã‚°ã€‚é¡”ãŒåˆ‡ã‚Œã«ãããªã‚‹ */
  border: 4px solid transparent;
  border-radius: 12px;
  cursor: pointer;
  transition: transform 0.2s, border 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  background-color: #fff;
}

/* ã‚¹ãƒãƒ›æ™‚ã¯å°‘ã—å°ã•ã‚ã«èª¿æ•´ */
@media (max-width: 480px) {
  .option-grid img {
    height: 240px;   /* â† ãƒ¢ãƒã‚¤ãƒ«ã¯å°‘ã—å°ã•ã‚ã« */
  }
}


  .option-grid img:hover { transform: scale(1.03); }

  .correct { border-color: #2e7d32; }
  .wrong   { border-color: #c62828; }

  /* --- ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ã‚’ body.listening-mode ã«é™å®šï¼‰ --- */
  body.listening-mode { background-color: #111; color: #fff; }

  body.listening-mode .option-grid img {
    background-color: #222;
    border: 2px solid #555;         /* ãƒªã‚¹ãƒ‹ãƒ³ã‚°æ™‚ã®ç¸ */
    box-shadow: 0 2px 6px rgba(0,0,0,0.35);
  }

  body.listening-mode .option-grid img:hover { background-color: #444; }

  #feedback, #score, #nextBtn, #finishMessage { margin-top: 20px; font-size: 20px; }
  #nextBtn { padding: 10px 20px; font-size: 16px; }

  /* ç”»é¢å¹…ãŒç‹­ã„ã¨ãã¯é«˜ã•ã‚’å°‘ã—ä¸‹ã’ã‚‹ï¼ˆå¯èª­æ€§UPï¼‰ */
  @media (max-width: 480px) {
    .option-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
    .option-grid img { height: 180px; }
  }
</style>

</head>
<body id="mainBody">
  <h1>ç¾å¥³å˜ãƒ†ã‚¹ãƒˆï¼ˆCSVèª­ã¿è¾¼ã¿ï¼‰</h1>
  <div id="score">0 å•æ­£è§£</div>
  <div id="sentence"></div>
  <div class="option-grid" id="options"></div>
  <div id="feedback"></div>
  <button id="nextBtn" style="display:none;">æ¬¡ã®å•é¡Œã¸</button>
  <div id="finishMessage" style="display:none;"></div>
  <audio id="correctSound" src="/sounds/pinpon.mp3"></audio>

  <script>
  // ===== ã‚¯ã‚¨ãƒª =====
  const urlParams   = new URLSearchParams(location.search);
  const userIdParam = urlParams.get("userId") || "";
  const modeParam   = urlParams.get("mode")   || "reading";
  const part = urlParams.get("part") || "adverbJA";

  // ===== è¦ç´  =====
  const sentenceEl   = document.getElementById("sentence");
  const optionsEl    = document.getElementById("options");
  const feedbackEl   = document.getElementById("feedback");
  const scoreEl      = document.getElementById("score");
  const nextBtn      = document.getElementById("nextBtn");
  const correctSound = document.getElementById("correctSound");

//===== å®šæ•°/çŠ¶æ…‹ =====
  const MAX_QUESTIONS = 10;
  let testData = [];
  let currentIndex = 0;
  let totalQuestions = 0;
  let score = 0;
  let answered = false;

  // â˜… è¿½åŠ ï¼šä¸æ­£è§£æ™‚ã®è¡¨ç¤ºç”¨ã«ä¿æŒ
  let lastCorrectKey = "";
  let lastCorrectWord = "";
  let lastJaText = "";

  // â˜… è¿½åŠ ï¼šå®‰å…¨ãªHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  const escapeHTML = (s="") => s.replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));

  // â˜… è¿½åŠ ï¼šå’Œè¨³å€™è£œã‚’ã„ã‚ã‚“ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰æ‹¾ã†
  const pickJa = (q={}) =>
    q.ja ?? q.jp ?? q.translation ?? q.meaning ?? q.jaText ?? "";


  // ===== ãƒ˜ãƒ«ãƒ‘ =====
  const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
  const isUrlLike = s => !!s && /^(\/|https?:\/\/|\.{0,2}\/)/i.test(s);
  const normPath  = u => { try { return new URL(u, location.origin).pathname; } catch { return (u||"").trim(); } };
  
  
  async function commitResult(userId, mode, correct, total) {
	    try {
	      const res = await fetch('/api/test/commit', {
	        method:'POST',
	        headers:{'Content-Type':'application/json'},
	        body: JSON.stringify({ userId, mode, correct, total })
	      });
	      // å¤±æ•—æ™‚ã¯ä¾‹å¤–åŒ–
	      if (!res.ok) throw new Error('commit failed: ' + res.status);

	      // ã‚µãƒ¼ãƒå´ã« â€œä»Šå›åˆ†ã¯åŠ ç®—æ¸ˆã¿â€ ã®è¨¼è·¡ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã ã‘æ®‹ã™ï¼ˆé‡è¤‡ã‚³ãƒŸãƒƒãƒˆé˜²æ­¢ï¼‰
	      sessionStorage.setItem(`committed:${userId}:${mode}:${correct}/${total}`, '1');
	      return true;
	    } catch (e) {
	      console.warn('commitå¤±æ•—ã€‚å¾Œæ®µã®ç”»é¢ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™', e);
	      return false;
	    }
	  }

	  // ===== æ¬¡ã¸ / çµ‚äº† =====
	nextBtn.onclick = async () => {
	  currentIndex++;
	  if (currentIndex < totalQuestions) {
	    showQuestion();
	  } else {
	    const msg = `ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼ ${score}/${totalQuestions} å•æ­£è§£ã§ã—ãŸã€‚`;
	    const finish = document.getElementById("finishMessage");
	    finish.textContent = msg;
	    finish.style.display = "block";
	    nextBtn.style.display = "none";
	    scoreEl.textContent = `${score} / ${totalQuestions}`;
	
	    const userId = userIdParam || 1;
	    await commitResult(userId, 'sentence', score, totalQuestions);
	
	    const url =
	      `/user.html?userId=${encodeURIComponent(userId)}&from=test` +
	      `&score=${encodeURIComponent(score)}&total=${encodeURIComponent(totalQuestions)}`;
	    setTimeout(() => window.location.replace(url), 800);
	  }
	};

  function speakText(text){
    if (!text) return;
    try {
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US"; u.pitch = 1.1; u.rate = 0.9;
      speechSynthesis.speak(u);
    } catch {}
  }
  function playAudioOrSpeech(q) {
    if (q.audio) {
      const a = new Audio(q.audio);
      a.onerror = () => speakText(q.sentence || "");
      a.play().catch(() => speakText(q.sentence || ""));
    } else {
      speakText(q.sentence || "");
    }
  }

  // ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
 async function loadData() {
  const res = await fetch(`/api/sentence-quiz?part=${encodeURIComponent(part)}&limit=1000`, { cache: "no-store" });
  if (!res.ok) throw new Error("Failed to load questions");
  const raw = await res.json(); // [{sentence, audio, correct, options[], answerKey}, ...]

  if (!Array.isArray(raw) || raw.length === 0) {
    sentenceEl.textContent = "å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  testData = shuffle(raw).slice(0, MAX_QUESTIONS);
  totalQuestions = testData.length;

  currentIndex = 0;
  score = 0;
  scoreEl.textContent = `${score} å•æ­£è§£`;

  showQuestion();
}

//å˜èªã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã‚¹ãƒ©ãƒƒã‚°ã‚’ä½œã‚‹
  function toSlugForImage(s) {
    return (s || "")
      .toLowerCase()
      .replace(/\s+/g, "_")
      .replace(/['â€™`"]/g, "")
      .replace(/[^a-z0-9_]/g, "");
  }
  
  function guessImageFromWord(word) {
	  if (!word) return "";
	  const slug = toSlugForImage(word);
	  return `/images/${slug}_girl.png`;
	}

  // å˜èªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ç”»åƒURLã‚’æ±ºå®š
  function imageUrlForWord(w) {
    if (w.imageUrl) return w.imageUrl;
    if (w.pictUrlAnimated) return w.pictUrlAnimated;
    if (w.pictUrl) return w.pictUrl;
    const slug = toSlugForImage(w.word || w.correct || "");
    return `/images/${slug}_girl.png`;
  }

  // å•é¡Œè¡¨ç¤º
  async function showQuestion() {
    feedbackEl.textContent = "";
    nextBtn.style.display = "none";
    optionsEl.innerHTML = "";
    answered = false;

    const q = testData[currentIndex];
    if (!q) return;

    sentenceEl.textContent = q.sentence ?? "";

    // ===== sentence éè¡¨ç¤ºï¼ˆãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼‰ =====
    if (modeParam === "listening") {
      document.body.classList.add("listening-mode");
      sentenceEl.style.display = "none";
    }

    playAudioOrSpeech(q);

    // æ­£è§£ç”»åƒURLã‚’å–å¾—ï¼ˆURLå„ªå…ˆ â†’ å˜èªã‹ã‚‰ç”Ÿæˆï¼‰
    let correctKey = q.correctPictUrl || q.correct || "";
    if (!isUrlLike(correctKey) && q.correct) {
      correctKey = imageUrlForWord({ word: q.correct });
    }

    // ä¸æ­£è§£æ™‚ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ä¿æŒ
    lastCorrectKey  = correctKey || "";
    lastCorrectWord = q.correct || "";
    lastJaText      = pickJa(q) || "";

    const candidates = Array.isArray(q.options) ? q.options.slice() : [];
    const shuffled = shuffle(candidates);
    let hasCorrect = false;

    shuffled.forEach((option) => {
      let imgUrl = isUrlLike(option) ? option : imageUrlForWord({ word: option });
      const img = document.createElement("img");
      img.src = encodeURI(imgUrl);
      img.onerror = () => { img.onerror = null; img.src = "/images/beauty.png"; };

      const isCorrect = normPath(imgUrl) === normPath(correctKey);
      if (isCorrect) hasCorrect = true;
      img.dataset.correct = isCorrect ? "1" : "0";

      img.onclick = () => handleAnswer(img);
      optionsEl.appendChild(img);
      console.log("ğŸ” option =", option);
      console.log("ğŸ” imgUrl =", imgUrl);
      console.log("q:", q);
      console.log("correctKey:", correctKey);
      console.log("options:", candidates);
    });

    // å€™è£œã«æ­£è§£ãŒãªã„å ´åˆã€æœ€åˆã‚’æ­£è§£æ‰±ã„ã«ã™ã‚‹
    if (!hasCorrect) {
      const first = optionsEl.querySelector("img");
      if (first) first.dataset.correct = "1";
    }

    // ã‚¹ã‚³ã‚¢è¡¨ç¤º
    scoreEl.textContent = `${score} å•æ­£è§£`;

    // âœ… ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
    const correct = localStorage.getItem("test_correct") || 0;
    const total = localStorage.getItem("test_total") || 0;
    const testStatsEl = document.getElementById("testStats");
    if (testStatsEl) {
      testStatsEl.textContent = `æ­£ç­”æ•°: ${correct} / ${total}å•ä¸­`;
    }

    // âœ… ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ•°è¡¨ç¤º
    const loginDaysEl = document.getElementById("loginDays");
    if (loginDaysEl && typeof user === "object") {
      loginDaysEl.textContent = `å­¦ç¿’æ—¥æ•°: ${user.loginPoints || 0}æ—¥ç›®`;
    }

    // âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å†å–å¾—ï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰
    if (typeof refreshUserStats === "function") {
      await refreshUserStats();
    }
  }




  // ===== å›ç­”å‡¦ç† =====
function handleAnswer(clickedImg){
  if (answered) return;
  answered = true;

  // ä»¥é™ã®ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
  optionsEl.querySelectorAll("img").forEach(i => (i.onclick = null));

  const isCorrect = clickedImg.dataset.correct === "1";

  // æ­£è§£/ä¸æ­£è§£ã®ç¸å–ã‚Š
  optionsEl.querySelectorAll("img").forEach(img => {
    const ok = img.dataset.correct === "1";
    img.classList.add(ok ? "correct" : "wrong");
  });

  if (isCorrect) {
    // â˜… æ­£è§£æ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
    try { correctSound.currentTime = 0; correctSound.play(); } catch {}
    clickedImg.classList.add("smile-animation");
    score++;  // â˜… åŠ ç‚¹
    feedbackEl.innerHTML = `<span style="color:#2e7d32;font-weight:bold;">æ­£è§£ï¼</span>`;
  } else {
    // â˜… ä¸æ­£è§£æ™‚ï¼šè‹±æ–‡ï¼‹å’Œè¨³ï¼‹æ­£è§£è‚¢ã®ã‚µãƒ ãƒã‚¤ãƒ«ã‚’è¡¨ç¤º
    const q = testData[currentIndex] || {};
    const ja = q.ja ? `<div style="margin-top:8px;"><strong>å’Œè¨³:</strong> ${q.ja}</div>` : "";
    const correctSrc = [...optionsEl.querySelectorAll("img")]
      .find(i => i.dataset.correct === "1")?.src || q.correct || q.correctPictUrl || "";

    const thumb = correctSrc
      ? `<div style="margin-top:12px;">
           <div><strong>æ­£è§£ï¼š</strong> ${new URL(correctSrc, location.origin).pathname}</div>
           <img src="${correctSrc}" style="width:120px;height:120px;object-fit:cover;border:3px solid #2e7d32;border-radius:10px;margin-top:8px;">
         </div>`
      : "";

    feedbackEl.innerHTML =
      `<div style="color:#c62828;">
         <strong>ä¸æ­£è§£â€¦</strong>
         <div style="margin-top:8px;"><strong>è‹±æ–‡:</strong> ${sentenceEl.textContent}</div>
         ${ja}
         ${thumb}
       </div>`;
  }

  // ã‚¹ã‚³ã‚¢ã¨ã€Œæ¬¡ã¸ã€è¡¨ç¤º
  scoreEl.textContent = `${score} å•æ­£è§£`;
  nextBtn.style.display = "inline-block";
}

  // ===== èµ·å‹• =====
  loadData().catch(e => {
    console.error(e);
    sentenceEl.textContent = "å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  });
  </script>
</body>
</html>
